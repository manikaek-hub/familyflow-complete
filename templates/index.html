<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow - Assistant Familial IA ‚ú®</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #FAF7F2;
            --sand: #E8DCC4;
            --terracotta: #C9856B;
            --terracotta-dark: #B8754A;
            --forest: #5F7161;
            --sage: #8B9D83;
            --midnight: #2C3333;
            --white: #FFFFFF;
            --red: #E74C3C;
            --green: #27AE60;
            --blue: #3498DB;
            --purple: #9B59B6;
            --orange: #E67E22;
            --yellow: #F1C40F;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F0EDE5 100%);
            color: var(--midnight);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--forest) 0%, var(--sage) 100%);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--white);
            font-weight: 600;
            font-style: italic;
        }
        
        .header-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--sand);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            border: 2px solid var(--white);
        }
        
        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 0.4rem 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--sage);
            font-size: 0.65rem;
            transition: all 0.3s;
        }
        
        .nav-item.active { color: var(--forest); }
        .nav-item .nav-icon { font-size: 1.3rem; margin-bottom: 0.15rem; }
        
        /* CONTAINER */
        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* CARDS */
        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: var(--forest);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* IMPORT */
        .import-zone {
            border: 3px dashed var(--sand);
            border-radius: 15px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--white);
        }
        
        .import-zone:hover { border-color: var(--forest); }
        .import-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .import-title { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--forest); }
        .import-text { color: var(--sage); font-size: 0.8rem; margin-top: 0.3rem; }
        
        /* LOADING */
        .loading-container { text-align: center; padding: 2rem; }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--sand);
            border-top-color: var(--forest);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.8rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        }
        
        .stat-card.income { border-left: 3px solid var(--green); }
        .stat-card.expense { border-left: 3px solid var(--terracotta); }
        .stat-card.balance { border-left: 3px solid var(--blue); }
        .stat-card.savings { border-left: 3px solid var(--purple); }
        
        .stat-icon { font-size: 1.3rem; }
        .stat-value { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 600; }
        .stat-label { font-size: 0.65rem; color: var(--sage); }
        
        /* CATEGORY */
        .category-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--cream);
        }
        .category-item:last-child { border-bottom: none; }
        .category-emoji { font-size: 1.1rem; }
        .category-info { flex: 1; }
        .category-name { font-size: 0.8rem; font-weight: 500; }
        .category-bar { height: 5px; background: var(--cream); border-radius: 3px; margin-top: 0.2rem; }
        .category-fill { height: 100%; border-radius: 3px; }
        .category-amount { font-weight: 600; font-size: 0.85rem; }
        
        /* TRANSACTIONS */
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--cream);
            border-radius: 10px;
            margin-bottom: 0.4rem;
            cursor: pointer;
        }
        .transaction-emoji { font-size: 1rem; }
        .transaction-info { flex: 1; min-width: 0; }
        .transaction-desc { font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-date { font-size: 0.65rem; color: var(--sage); }
        .transaction-amount { font-weight: 600; font-size: 0.85rem; }
        .transaction-amount.income { color: var(--green); }
        .transaction-amount.expense { color: var(--terracotta); }
        
        /* ALERTS */
        .alert-card {
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
        }
        .alert-card.warning { background: #FFF3E0; border-left: 3px solid var(--orange); }
        .alert-card.danger { background: #FFEBEE; border-left: 3px solid var(--red); }
        .alert-card.success { background: #E8F5E9; border-left: 3px solid var(--green); }
        .alert-card.tip { background: linear-gradient(135deg, var(--forest), var(--sage)); color: var(--white); }
        .alert-icon { font-size: 1.2rem; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; font-size: 0.85rem; }
        .alert-text { font-size: 0.75rem; opacity: 0.9; }
        
        /* BUDGET PLAN */
        .budget-item {
            background: var(--cream);
            border-radius: 10px;
            padding: 0.7rem;
            margin-bottom: 0.5rem;
        }
        .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .budget-category { display: flex; align-items: center; gap: 0.4rem; font-weight: 500; font-size: 0.85rem; }
        .budget-spent { font-weight: 600; font-size: 0.85rem; }
        .budget-bar { height: 6px; background: var(--sand); border-radius: 3px; overflow: hidden; }
        .budget-fill { height: 100%; border-radius: 3px; }
        .budget-fill.ok { background: var(--green); }
        .budget-fill.warning { background: var(--orange); }
        .budget-fill.danger { background: var(--red); }
        .budget-status { font-size: 0.7rem; margin-top: 0.2rem; }
        .budget-status.ok { color: var(--green); }
        .budget-status.warning { color: var(--orange); }
        .budget-status.danger { color: var(--red); }
        
        /* SCORE */
        .score-circle {
            width: 70px; height: 70px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.6rem;
        }
        .score-circle.good { background: linear-gradient(135deg, var(--green), #2ECC71); }
        .score-circle.warning { background: linear-gradient(135deg, var(--orange), #F39C12); }
        .score-circle.bad { background: linear-gradient(135deg, var(--red), #C0392B); }
        .score-value { font-size: 1.3rem; font-weight: 700; color: white; }
        .score-label { font-size: 0.5rem; color: rgba(255,255,255,0.8); }
        
        /* CHAT */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 200px); max-height: 450px; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message {
            max-width: 85%;
            padding: 0.6rem 0.8rem;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .message.user {
            background: var(--forest);
            color: var(--white);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            background: var(--cream);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 0.4rem;
            padding: 0.5rem;
            background: var(--cream);
            border-radius: 10px;
            margin-top: 0.5rem;
        }
        .chat-input {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
        }
        .chat-input:focus { outline: none; }
        .chat-send {
            padding: 0.5rem 0.8rem;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--forest), var(--sage));
            color: var(--white);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .suggestion-btn {
            padding: 0.35rem 0.6rem;
            border: 2px solid var(--sand);
            border-radius: 15px;
            background: var(--white);
            font-size: 0.7rem;
            cursor: pointer;
            margin: 0.2rem;
        }
        .suggestion-btn:hover { border-color: var(--forest); }
        
        /* HOMEWORK */
        .homework-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        
        .child-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--cream);
            border-radius: 20px;
            cursor: pointer;
        }
        .child-selector .avatar { font-size: 1.2rem; }
        .child-selector .name { font-weight: 500; font-size: 0.85rem; }
        .child-selector .arrow { font-size: 0.7rem; color: var(--sage); }
        
        .new-chat-btn {
            padding: 0.4rem 0.7rem;
            border: none;
            border-radius: 8px;
            background: var(--terracotta);
            color: var(--white);
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .mode-toggle {
            display: flex;
            background: var(--cream);
            border-radius: 10px;
            padding: 0.25rem;
            margin-bottom: 0.8rem;
        }
        .mode-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            background: none;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .mode-btn.active { background: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .upload-zone {
            border: 2px dashed var(--sand);
            border-radius: 10px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--sage);
            margin-bottom: 0.5rem;
        }
        .upload-preview {
            position: relative;
            padding: 0.5rem;
            background: var(--cream);
            border-radius: 10px;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .upload-preview img { max-width: 100%; max-height: 80px; border-radius: 6px; }
        .remove-upload {
            position: absolute;
            top: 3px; right: 3px;
            width: 18px; height: 18px;
            border-radius: 50%;
            border: none;
            background: var(--red);
            color: white;
            cursor: pointer;
            font-size: 0.6rem;
        }
        
        /* CHILD MODE - INTERACTIVE CARDS */
        .quiz-container {
            position: relative;
            min-height: 280px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .quiz-card {
            position: absolute;
            width: 100%;
            max-width: 320px;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            cursor: grab;
            transition: transform 0.1s;
            user-select: none;
        }
        
        .quiz-card-header {
            padding: 1.2rem;
            text-align: center;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            color: white;
        }
        .quiz-card-header.correct { background: linear-gradient(135deg, var(--green), #2ECC71); }
        .quiz-card-header.wrong { background: linear-gradient(135deg, var(--red), #C0392B); }
        
        .quiz-subject { font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.3rem; }
        .quiz-question { font-size: 1rem; font-weight: 600; line-height: 1.4; }
        
        .quiz-card-body { padding: 1rem; }
        
        .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .quiz-option {
            padding: 0.7rem;
            border: 2px solid var(--sand);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .quiz-option:hover { border-color: var(--blue); background: rgba(52, 152, 219, 0.1); }
        .quiz-option.selected { border-color: var(--blue); background: rgba(52, 152, 219, 0.2); }
        .quiz-option.correct { border-color: var(--green); background: rgba(39, 174, 96, 0.2); }
        .quiz-option.wrong { border-color: var(--red); background: rgba(231, 76, 60, 0.2); }
        
        .quiz-input {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid var(--sand);
            border-radius: 10px;
            font-size: 0.9rem;
            text-align: center;
        }
        .quiz-input:focus { outline: none; border-color: var(--blue); }
        
        .quiz-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .quiz-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .quiz-btn.skip { background: var(--sand); }
        .quiz-btn.check { background: linear-gradient(135deg, var(--green), #2ECC71); color: white; }
        .quiz-btn.hint { background: linear-gradient(135deg, var(--orange), var(--yellow)); color: white; }
        
        .quiz-progress {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }
        .progress-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--sand);
        }
        .progress-dot.done { background: var(--green); }
        .progress-dot.current { background: var(--blue); transform: scale(1.3); }
        
        .quiz-score {
            text-align: center;
            padding: 1.5rem;
        }
        .quiz-score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--forest);
        }
        .quiz-score-label { color: var(--sage); margin-bottom: 1rem; }
        .quiz-restart {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--forest), var(--sage));
            color: white;
            font-weight: 500;
            cursor: pointer;
        }
        
        .swipe-hint {
            text-align: center;
            font-size: 0.75rem;
            color: var(--sage);
            margin-top: 0.5rem;
        }
        
        /* PROFILE */
        .profile-header {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--forest), var(--sage));
            border-radius: 15px;
            margin-bottom: 1rem;
            color: white;
        }
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: var(--sand);
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid white;
        }
        .profile-name { font-size: 1.2rem; font-weight: 600; }
        .profile-email { font-size: 0.8rem; opacity: 0.8; }
        
        .family-section { margin-bottom: 1rem; }
        .family-title {
            font-size: 0.85rem;
            color: var(--sage);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .add-child-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 15px;
            background: var(--terracotta);
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .child-card {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .child-avatar-lg {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: var(--cream);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .child-info { flex: 1; }
        .child-name { font-weight: 600; font-size: 0.95rem; }
        .child-details { font-size: 0.75rem; color: var(--sage); }
        .child-edit {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--sand);
            border-radius: 8px;
            background: none;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: var(--white);
            border-radius: 10px;
            margin-bottom: 0.4rem;
        }
        .settings-label { font-size: 0.85rem; }
        .settings-toggle {
            width: 45px; height: 24px;
            border-radius: 12px;
            background: var(--sand);
            position: relative;
            cursor: pointer;
        }
        .settings-toggle.on { background: var(--green); }
        .settings-toggle::after {
            content: '';
            position: absolute;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px; left: 2px;
            transition: 0.3s;
        }
        .settings-toggle.on::after { left: 23px; }
        
        .logout-btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 10px;
            background: var(--red);
            color: white;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal {
            background: var(--white);
            border-radius: 15px;
            padding: 1.2rem;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        
        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--forest);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .form-group { margin-bottom: 0.7rem; }
        .form-label { display: block; font-size: 0.75rem; color: var(--sage); margin-bottom: 0.2rem; }
        .form-input, .form-select {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--forest); }
        
        .avatar-picker {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .avatar-option {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid var(--sand);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
        }
        .avatar-option.selected { border-color: var(--forest); background: var(--cream); }
        
        .modal-buttons {
            display: flex;
            gap: 0.6rem;
            margin-top: 1rem;
        }
        .modal-btn {
            flex: 1;
            padding: 0.7rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-cancel { background: var(--sand); }
        .btn-save { background: linear-gradient(135deg, var(--forest), var(--sage)); color: white; }
        .btn-delete { background: var(--red); color: white; }
        
        .child-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 50;
            display: none;
            margin-top: 0.3rem;
        }
        .child-dropdown.show { display: block; }
        .child-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
            cursor: pointer;
        }
        .child-dropdown-item:hover { background: var(--cream); }
        .child-dropdown-item:first-child { border-radius: 10px 10px 0 0; }
        .child-dropdown-item:last-child { border-radius: 0 0 10px 10px; }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 10px; left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--forest), var(--sage));
            color: var(--white);
            padding: 0.6rem 1rem;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideDown 0.3s ease-out;
            font-size: 0.85rem;
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .loading-dots { display: flex; gap: 0.2rem; padding: 0.5rem; }
        .loading-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--sage);
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .empty-state { text-align: center; padding: 2rem; color: var(--sage); }
        .empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        
        .edit-btn { padding: 0.3rem 0.5rem; border: 1px solid var(--sand); border-radius: 6px; background: none; font-size: 0.7rem; cursor: pointer; margin-left: 0.5rem; }
        .reset-btn { display: block; width: 100%; padding: 0.6rem; border: 2px dashed var(--sand); border-radius: 8px; background: none; color: var(--sage); cursor: pointer; font-size: 0.8rem; margin-top: 1rem; }
    </style>
</head>
<body>
    <header>
        <div class="header-title">üåä FamilyFlow</div>
        <div class="header-profile" id="headerProfile" onclick="switchView('profile')">üë§</div>
    </header>
    
    <div class="container">
        <!-- BUDGET VIEW -->
        <div class="view active" id="budget-view">
            <div class="import-zone" id="importZone">
                <div class="import-icon">üìÑ</div>
                <div class="import-title">Importer votre relev√©</div>
                <div class="import-text">Glissez un PDF ou cliquez</div>
                <input type="file" id="importInput" accept=".pdf,.csv" style="display: none;">
            </div>
            
            <div class="loading-container" id="loadingContainer" style="display: none;">
                <div class="loading-spinner"></div>
                <div style="color: var(--sage); font-size: 0.85rem;">ü§ñ Analyse en cours...</div>
            </div>
            
            <div id="dashboardContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card income"><div class="stat-icon">üì•</div><div class="stat-value" id="totalIncome">0‚Ç¨</div><div class="stat-label">Revenus</div></div>
                    <div class="stat-card expense"><div class="stat-icon">üí≥</div><div class="stat-value" id="totalExpenses">0‚Ç¨</div><div class="stat-label">D√©penses</div></div>
                    <div class="stat-card balance"><div class="stat-icon">üí∞</div><div class="stat-value" id="totalBalance">0‚Ç¨</div><div class="stat-label">Solde</div></div>
                    <div class="stat-card savings"><div class="stat-icon">üéØ</div><div class="stat-value" id="savingsRate">0%</div><div class="stat-label">√âpargne</div></div>
                </div>
                
                <div class="card">
                    <div class="card-title">üìä R√©partition</div>
                    <div id="categoryBreakdown"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">üìã Transactions r√©centes</div>
                    <div id="recentTransactions"></div>
                </div>
                
                <button class="reset-btn" onclick="resetData()">üîÑ Nouveau relev√©</button>
            </div>
        </div>
        
        <!-- OPTIMIZE VIEW -->
        <div class="view" id="optimize-view">
            <div id="optimizeContent">
                <div class="empty-state"><div class="empty-icon">üìä</div><div>Importez un relev√©</div></div>
            </div>
        </div>
        
        <!-- PLAN VIEW -->
        <div class="view" id="plan-view">
            <div id="planContent">
                <div class="empty-state"><div class="empty-icon">üéØ</div><div>Importez un relev√©</div></div>
            </div>
        </div>
        
        <!-- ASSISTANT VIEW -->
        <div class="view" id="assistant-view">
            <div class="card chat-container">
                <div class="chat-messages" id="budgetChatMessages">
                    <div class="message assistant">üëã Bonjour ! Je suis votre assistant budget. Posez-moi vos questions !</div>
                </div>
                <div id="budgetSuggestions" style="display: flex; flex-wrap: wrap; padding: 0.3rem;">
                    <button class="suggestion-btn" onclick="askBudget('Comment √©conomiser ?')">üí° √âconomiser</button>
                    <button class="suggestion-btn" onclick="askBudget('Analyse mes abonnements')">üì± Abonnements</button>
                    <button class="suggestion-btn" onclick="askBudget('Plan budget')">üéØ Plan</button>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="budgetInput" placeholder="Votre question...">
                    <button class="chat-send" onclick="sendBudgetMsg()">‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- HOMEWORK VIEW -->
        <div class="view" id="homework-view">
            <div class="homework-header">
                <div class="child-selector" id="childSelector" onclick="toggleChildDropdown()">
                    <span class="avatar" id="currentChildAvatar">üë¶</span>
                    <span class="name" id="currentChildName">Gauthier</span>
                    <span class="arrow">‚ñº</span>
                    <div class="child-dropdown" id="childDropdown"></div>
                </div>
                <button class="new-chat-btn" onclick="newHomeworkChat()">üîÑ Nouveau</button>
            </div>
            
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="parent" onclick="setHomeworkMode('parent')">üë®‚Äçüë©‚Äçüëß Parent</button>
                <button class="mode-btn" data-mode="child" onclick="setHomeworkMode('child')">üéÆ Enfant</button>
            </div>
            
            <!-- Parent Mode Chat -->
            <div id="parentModeContent" class="card chat-container">
                <div class="chat-messages" id="homeworkChat">
                    <div class="message assistant">üìö Uploadez une le√ßon ou posez une question !</div>
                </div>
                
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    üìé Photo ou PDF de le√ßon
                    <input type="file" id="fileInput" accept="image/*,.pdf" style="display: none;">
                </div>
                <div class="upload-preview" id="uploadPreview" style="display: none;">
                    <img id="previewImg" src="">
                    <button class="remove-upload" onclick="clearUpload()">‚úï</button>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="homeworkInput" placeholder="Question...">
                    <button class="chat-send" onclick="sendHomeworkMsg()">‚Üí</button>
                </div>
            </div>
            
            <!-- Child Mode Interactive -->
            <div id="childModeContent" style="display: none;">
                <div class="quiz-progress" id="quizProgress"></div>
                
                <div class="quiz-container" id="quizContainer">
                    <div class="empty-state">
                        <div class="empty-icon">üéÆ</div>
                        <div>Uploadez une le√ßon en mode Parent<br>puis revenez ici pour le quiz !</div>
                    </div>
                </div>
                
                <div id="quizActions" style="display: none;">
                    <div class="quiz-actions">
                        <button class="quiz-btn hint" onclick="getHint()">üí°</button>
                        <button class="quiz-btn check" onclick="checkAnswer()">‚úì</button>
                        <button class="quiz-btn skip" onclick="skipQuestion()">‚Üí</button>
                    </div>
                    <div class="swipe-hint">üí° Indice ‚Ä¢ ‚úì V√©rifier ‚Ä¢ ‚Üí Passer</div>
                </div>
            </div>
        </div>
        
        <!-- PROFILE VIEW -->
        <div class="view" id="profile-view">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">üë§</div>
                <div class="profile-name" id="profileName">Famille</div>
                <div class="profile-email" id="profileEmail">Configurez votre profil</div>
            </div>
            
            <div class="family-section">
                <div class="family-title">
                    üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Mes enfants
                    <button class="add-child-btn" onclick="openChildModal()">+ Ajouter</button>
                </div>
                <div id="childrenList"></div>
            </div>
            
            <div class="card">
                <div class="card-title">‚öôÔ∏è Param√®tres</div>
                <div class="settings-item">
                    <span class="settings-label">Notifications</span>
                    <div class="settings-toggle on" onclick="this.classList.toggle('on')"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Mode sombre</span>
                    <div class="settings-toggle" onclick="this.classList.toggle('on')"></div>
                </div>
            </div>
            
            <button class="logout-btn" onclick="resetAll()">üö™ R√©initialiser l'app</button>
        </div>
    </div>
    
    <!-- NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="budget"><span class="nav-icon">üí∞</span>Budget</button>
        <button class="nav-item" data-view="optimize"><span class="nav-icon">üéØ</span>Optimiser</button>
        <button class="nav-item" data-view="plan"><span class="nav-icon">üìÖ</span>Plan</button>
        <button class="nav-item" data-view="assistant"><span class="nav-icon">ü§ñ</span>Assistant</button>
        <button class="nav-item" data-view="homework"><span class="nav-icon">üìö</span>Devoirs</button>
    </nav>
    
    <!-- CHILD MODAL -->
    <div class="modal-overlay" id="childModal">
        <div class="modal">
            <div class="modal-title" id="childModalTitle">‚ûï Ajouter un enfant</div>
            
            <div class="avatar-picker" id="avatarPicker">
                <div class="avatar-option selected" data-avatar="üë¶">üë¶</div>
                <div class="avatar-option" data-avatar="üëß">üëß</div>
                <div class="avatar-option" data-avatar="üßí">üßí</div>
                <div class="avatar-option" data-avatar="üë∂">üë∂</div>
                <div class="avatar-option" data-avatar="üßíüèΩ">üßíüèΩ</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Pr√©nom</label>
                <input type="text" class="form-input" id="childName" placeholder="Ex: Emma">
            </div>
            
            <div class="form-group">
                <label class="form-label">√Çge</label>
                <input type="number" class="form-input" id="childAge" placeholder="Ex: 10" min="3" max="18">
            </div>
            
            <div class="form-group">
                <label class="form-label">Classe</label>
                <select class="form-select" id="childClass">
                    <option value="CP">CP</option>
                    <option value="CE1">CE1</option>
                    <option value="CE2">CE2</option>
                    <option value="CM1">CM1</option>
                    <option value="CM2">CM2</option>
                    <option value="6e">6√®me</option>
                    <option value="5e">5√®me</option>
                    <option value="4e" selected>4√®me</option>
                    <option value="3e">3√®me</option>
                    <option value="2nde">2nde</option>
                    <option value="1ere">1√®re</option>
                    <option value="Term">Terminale</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Centres d'int√©r√™t (optionnel)</label>
                <input type="text" class="form-input" id="childInterests" placeholder="Ex: foot, manga, sciences">
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closeModal('childModal')">Annuler</button>
                <button class="modal-btn btn-delete" id="deleteChildBtn" onclick="deleteChild()" style="display:none;">üóëÔ∏è</button>
                <button class="modal-btn btn-save" onclick="saveChild()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- EDIT TRANSACTION MODAL -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-title">‚úèÔ∏è Modifier</div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="editDesc">
            </div>
            <div class="form-group">
                <label class="form-label">Cat√©gorie</label>
                <div id="categoryGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closeModal('editModal')">Annuler</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ============ CATEGORIES ============
        const CATEGORIES = {
            shopping: { emoji: 'üõí', name: 'Shopping', color: '#E74C3C' },
            food: { emoji: 'üçï', name: 'Alimentation', color: '#E67E22' },
            transport: { emoji: 'üöó', name: 'Transport', color: '#3498DB' },
            housing: { emoji: 'üè†', name: 'Logement', color: '#9B59B6' },
            bills: { emoji: 'üìÑ', name: 'Factures', color: '#8E44AD' },
            entertainment: { emoji: 'üé¨', name: 'Loisirs', color: '#1ABC9C' },
            health: { emoji: 'üíä', name: 'Sant√©', color: '#E91E63' },
            subscriptions: { emoji: 'üì±', name: 'Abos', color: '#00BCD4' },
            insurance: { emoji: 'üõ°Ô∏è', name: 'Assurance', color: '#607D8B' },
            salary: { emoji: 'üíº', name: 'Revenus', color: '#27AE60' },
            transfer: { emoji: 'üîÑ', name: 'Virement', color: '#95A5A6' },
            other: { emoji: 'üì¶', name: 'Autre', color: '#7F8C8D' }
        };

        // ============ DATA ============
        let data = {
            transactions: [],
            budgets: {},
            profile: { name: '', email: '' },
            children: [
                { id: 1, name: 'Gauthier', age: 13, class: '4e', avatar: 'üë¶', interests: '' },
                { id: 2, name: 'Charles', age: 11, class: '6e', avatar: 'üßí', interests: '' },
                { id: 3, name: 'Victoire', age: 7, class: 'CE1', avatar: 'üëß', interests: '' }
            ]
        };
        
        let currentChild = null;
        let homeworkMode = 'parent';
        let homeworkHistory = [];
        let budgetHistory = [];
        let uploadedFile = null;
        let uploadedBase64 = null;
        let editingTransaction = null;
        let editingChild = null;
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let quizScore = 0;

        // ============ INIT ============
        function init() {
            const saved = localStorage.getItem('familyflow_v5');
            if (saved) data = { ...data, ...JSON.parse(saved) };
            
            if (data.children.length > 0) currentChild = data.children[0];
            
            setupListeners();
            updateAllViews();
            updateChildDropdown();
            updateChildrenList();
        }

        function save() { localStorage.setItem('familyflow_v5', JSON.stringify(data)); }

        // ============ LISTENERS ============
        function setupListeners() {
            // Nav
            document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', () => switchView(n.dataset.view)));
            
            // Import
            document.getElementById('importZone').addEventListener('click', () => document.getElementById('importInput').click());
            document.getElementById('importInput').addEventListener('change', (e) => e.target.files[0] && importFile(e.target.files[0]));
            
            // File upload
            document.getElementById('fileInput').addEventListener('change', (e) => e.target.files[0] && handleUpload(e.target.files[0]));
            
            // Chat inputs
            document.getElementById('budgetInput').addEventListener('keypress', (e) => e.key === 'Enter' && sendBudgetMsg());
            document.getElementById('homeworkInput').addEventListener('keypress', (e) => e.key === 'Enter' && sendHomeworkMsg());
            
            // Avatar picker
            document.querySelectorAll('.avatar-option').forEach(a => {
                a.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                    a.classList.add('selected');
                });
            });
            
            // Close modals
            document.querySelectorAll('.modal-overlay').forEach(m => {
                m.addEventListener('click', (e) => e.target === m && closeModal(m.id));
            });
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');
            document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
        }

        // ============ IMPORT ============
        async function importFile(file) {
            document.getElementById('importZone').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const b64 = e.target.result.split(',')[1];
                try {
                    const res = await fetch('/api/claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            system: `Extrais les transactions du relev√©. Retourne UNIQUEMENT ce JSON:
{"period":"Mois YYYY","transactions":[{"date":"DD/MM/YYYY","description":"Court","amount":123.45,"category":"salary"}]}
R√®gles: revenus=positif, d√©penses=n√©gatif. Cat√©gories: shopping,food,transport,housing,bills,entertainment,health,subscriptions,insurance,salary,transfer,other`,
                            messages: [{ role: 'user', content: [
                                { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: b64 }},
                                { type: 'text', text: 'Analyse. JSON uniquement.' }
                            ]}]
                        })
                    });
                    document.getElementById('loadingContainer').style.display = 'none';
                    if (res.ok) {
                        const r = await res.json();
                        const m = r.content[0].text.match(/\{[\s\S]*\}/);
                        if (m) {
                            const p = JSON.parse(m[0]);
                            if (p.transactions?.length) {
                                data.transactions = p.transactions.map((t, i) => ({ id: Date.now() + i, ...t }));
                                data.period = p.period || '';
                                save();
                                updateAllViews();
                                notify(`‚úÖ ${data.transactions.length} transactions`);
                                return;
                            }
                        }
                    }
                    showImportError();
                } catch (e) { console.error(e); showImportError(); }
            };
            reader.readAsDataURL(file);
        }

        function showImportError() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('importZone').style.display = 'block';
            notify('‚ùå Erreur import');
        }

        function resetData() {
            if (confirm('Effacer les donn√©es financi√®res ?')) {
                data.transactions = [];
                save();
                updateAllViews();
            }
        }

        function resetAll() {
            if (confirm('R√©initialiser toute l\'app ?')) {
                localStorage.removeItem('familyflow_v5');
                location.reload();
            }
        }

        // ============ UPDATE VIEWS ============
        function updateAllViews() {
            const has = data.transactions.length > 0;
            document.getElementById('importZone').style.display = has ? 'none' : 'block';
            document.getElementById('dashboardContent').style.display = has ? 'block' : 'none';
            
            if (has) {
                updateDashboard();
                updateOptimize();
                updatePlan();
            } else {
                document.getElementById('optimizeContent').innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div>Importez un relev√©</div></div>';
                document.getElementById('planContent').innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><div>Importez un relev√©</div></div>';
            }
        }

        function updateDashboard() {
            const inc = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const exp = data.transactions.filter(t => t.amount < 0).reduce((s, t) => s + Math.abs(t.amount), 0);
            const bal = inc - exp;
            const sav = inc > 0 ? Math.round((bal / inc) * 100) : 0;
            
            document.getElementById('totalIncome').textContent = '+' + Math.round(inc) + '‚Ç¨';
            document.getElementById('totalExpenses').textContent = '-' + Math.round(exp) + '‚Ç¨';
            document.getElementById('totalBalance').textContent = (bal >= 0 ? '+' : '') + Math.round(bal) + '‚Ç¨';
            document.getElementById('totalBalance').style.color = bal >= 0 ? 'var(--green)' : 'var(--red)';
            document.getElementById('savingsRate').textContent = sav + '%';
            
            // Categories
            const byCat = {};
            data.transactions.filter(t => t.amount < 0).forEach(t => {
                byCat[t.category || 'other'] = (byCat[t.category || 'other'] || 0) + Math.abs(t.amount);
            });
            const sorted = Object.entries(byCat).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const max = sorted[0]?.[1] || 1;
            const total = Object.values(byCat).reduce((s, v) => s + v, 0);
            
            document.getElementById('categoryBreakdown').innerHTML = sorted.map(([c, a]) => {
                const cat = CATEGORIES[c] || CATEGORIES.other;
                return `<div class="category-item">
                    <div class="category-emoji">${cat.emoji}</div>
                    <div class="category-info">
                        <div class="category-name">${cat.name}</div>
                        <div class="category-bar"><div class="category-fill" style="width:${(a/max)*100}%;background:${cat.color}"></div></div>
                    </div>
                    <div class="category-amount">${Math.round(a)}‚Ç¨</div>
                </div>`;
            }).join('');
            
            // Recent
            const recent = [...data.transactions].sort((a, b) => b.date?.localeCompare(a.date)).slice(0, 5);
            document.getElementById('recentTransactions').innerHTML = recent.map(t => txHTML(t)).join('');
        }

        function txHTML(t) {
            const c = CATEGORIES[t.category] || CATEGORIES.other;
            const inc = t.amount > 0;
            return `<div class="transaction-item" onclick="openEdit(${t.id})">
                <div class="transaction-emoji">${c.emoji}</div>
                <div class="transaction-info"><div class="transaction-desc">${t.description}</div><div class="transaction-date">${t.date}</div></div>
                <div class="transaction-amount ${inc ? 'income' : 'expense'}">${inc ? '+' : ''}${t.amount.toFixed(0)}‚Ç¨</div>
            </div>`;
        }

        function updateOptimize() {
            const exp = data.transactions.filter(t => t.amount < 0);
            const inc = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const totalExp = exp.reduce((s, t) => s + Math.abs(t.amount), 0);
            const byCat = {};
            exp.forEach(t => { byCat[t.category || 'other'] = (byCat[t.category || 'other'] || 0) + Math.abs(t.amount); });
            
            const savRate = inc > 0 ? (inc - totalExp) / inc : 0;
            let score = Math.max(0, Math.min(100, Math.round(50 + savRate * 40)));
            const scoreClass = score >= 70 ? 'good' : score >= 40 ? 'warning' : 'bad';
            
            let alerts = [];
            const subs = byCat.subscriptions || 0;
            if (subs > 80) alerts.push({ type: 'warning', icon: 'üì±', title: `${Math.round(subs)}‚Ç¨ abonnements`, text: 'V√©rifiez si vous les utilisez tous.' });
            if (byCat.shopping && byCat.shopping > totalExp * 0.25) alerts.push({ type: 'warning', icon: 'üõí', title: 'Shopping √©lev√©', text: `${Math.round((byCat.shopping/totalExp)*100)}% des d√©penses.` });
            if (savRate < 0.1) alerts.push({ type: 'danger', icon: 'üí∏', title: '√âpargne faible', text: `${Math.round(savRate*100)}% (objectif: 20%)` });
            else if (savRate >= 0.2) alerts.push({ type: 'success', icon: 'üéâ', title: 'Bravo !', text: `${Math.round(savRate*100)}% d'√©pargne` });
            
            document.getElementById('optimizeContent').innerHTML = `
                <div class="card"><div class="card-title">üìà Score</div>
                    <div class="score-circle ${scoreClass}"><div class="score-value">${score}</div><div class="score-label">/100</div></div>
                </div>
                ${alerts.map(a => `<div class="alert-card ${a.type}"><div class="alert-icon">${a.icon}</div><div class="alert-content"><div class="alert-title">${a.title}</div><div class="alert-text">${a.text}</div></div></div>`).join('')}
                <div class="alert-card tip"><div class="alert-icon">üí°</div><div class="alert-content"><div class="alert-title">Astuce</div><div class="alert-text">N√©gociez vos assurances chaque ann√©e.</div></div></div>
            `;
        }

        function updatePlan() {
            const exp = data.transactions.filter(t => t.amount < 0);
            const inc = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const byCat = {};
            exp.forEach(t => { byCat[t.category || 'other'] = (byCat[t.category || 'other'] || 0) + Math.abs(t.amount); });
            const sorted = Object.entries(byCat).sort((a, b) => b[1] - a[1]);
            
            document.getElementById('planContent').innerHTML = `
                <div class="card"><div class="card-title">üí∞ Revenus</div><div style="font-size:1.3rem;font-weight:600;color:var(--green);text-align:center;">+${Math.round(inc)}‚Ç¨</div></div>
                <div class="card"><div class="card-title">üéØ Budgets</div>
                ${sorted.map(([cat, spent]) => {
                    const c = CATEGORIES[cat] || CATEGORIES.other;
                    const budget = data.budgets[cat] || Math.round(spent * 1.2);
                    const pct = Math.round((spent / budget) * 100);
                    const st = pct >= 100 ? 'danger' : pct >= 80 ? 'warning' : 'ok';
                    return `<div class="budget-item"><div class="budget-header"><div class="budget-category">${c.emoji} ${c.name}</div><div class="budget-spent">${Math.round(spent)}‚Ç¨ / ${budget}‚Ç¨</div></div><div class="budget-bar"><div class="budget-fill ${st}" style="width:${Math.min(pct,100)}%"></div></div><div class="budget-status ${st}">${pct >= 100 ? '‚ö†Ô∏è D√©pass√©' : `‚úì Reste ${budget - Math.round(spent)}‚Ç¨`}</div></div>`;
                }).join('')}
                </div>
            `;
        }

        // ============ EDIT TRANSACTION ============
        function openEdit(id) {
            editingTransaction = data.transactions.find(t => t.id === id);
            if (!editingTransaction) return;
            document.getElementById('editDesc').value = editingTransaction.description;
            document.getElementById('categoryGrid').innerHTML = Object.entries(CATEGORIES).map(([k, c]) => 
                `<div class="category-option ${editingTransaction.category === k ? 'active' : ''}" data-cat="${k}" onclick="selectCat(this)"><span class="cat-emoji">${c.emoji}</span>${c.name}</div>`
            ).join('');
            openModal('editModal');
        }

        function selectCat(el) {
            document.querySelectorAll('#categoryGrid .category-option').forEach(o => o.classList.remove('active'));
            el.classList.add('active');
        }

        function saveEdit() {
            if (!editingTransaction) return;
            editingTransaction.description = document.getElementById('editDesc').value || editingTransaction.description;
            editingTransaction.category = document.querySelector('#categoryGrid .active')?.dataset.cat || editingTransaction.category;
            save();
            updateAllViews();
            closeModal('editModal');
            notify('‚úÖ Modifi√©');
        }

        // ============ BUDGET CHAT ============
        async function sendBudgetMsg() {
            const input = document.getElementById('budgetInput');
            const msg = input.value.trim();
            if (!msg) return;
            addMsg('budgetChatMessages', msg, 'user');
            input.value = '';
            
            const loading = addLoading('budgetChatMessages');
            
            const context = data.transactions.length ? `Donn√©es: Revenus ${data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0).toFixed(0)}‚Ç¨, D√©penses ${data.transactions.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0).toFixed(0)}‚Ç¨` : 'Pas de donn√©es import√©es.';
            
            try {
                const res = await fetch('/api/claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system: `Assistant budget concis. ${context}. R√©ponds en fran√ßais avec emojis.`,
                        messages: [...budgetHistory.slice(-4), { role: 'user', content: msg }]
                    })
                });
                loading.remove();
                if (res.ok) {
                    const r = await res.json();
                    const reply = r.content[0].text;
                    addMsg('budgetChatMessages', reply, 'assistant');
                    budgetHistory.push({ role: 'user', content: msg }, { role: 'assistant', content: reply });
                }
            } catch (e) { loading.remove(); addMsg('budgetChatMessages', '‚ùå Erreur', 'assistant'); }
        }

        function askBudget(q) { document.getElementById('budgetInput').value = q; sendBudgetMsg(); }

        // ============ HOMEWORK ============
        function updateChildDropdown() {
            const dd = document.getElementById('childDropdown');
            dd.innerHTML = data.children.map(c => 
                `<div class="child-dropdown-item" onclick="selectChild(${c.id})">${c.avatar} ${c.name} (${c.class})</div>`
            ).join('');
            if (currentChild) {
                document.getElementById('currentChildAvatar').textContent = currentChild.avatar;
                document.getElementById('currentChildName').textContent = currentChild.name;
            }
        }

        function toggleChildDropdown() {
            document.getElementById('childDropdown').classList.toggle('show');
        }

        function selectChild(id) {
            currentChild = data.children.find(c => c.id === id);
            updateChildDropdown();
            document.getElementById('childDropdown').classList.remove('show');
            notify(`üëã ${currentChild.name} s√©lectionn√©`);
        }

        function setHomeworkMode(mode) {
            homeworkMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
            document.getElementById('parentModeContent').style.display = mode === 'parent' ? 'flex' : 'none';
            document.getElementById('childModeContent').style.display = mode === 'child' ? 'block' : 'none';
        }

        function newHomeworkChat() {
            homeworkHistory = [];
            quizQuestions = [];
            currentQuizIndex = 0;
            quizScore = 0;
            document.getElementById('homeworkChat').innerHTML = '<div class="message assistant">üìö Nouvelle conversation ! Uploadez une le√ßon.</div>';
            document.getElementById('quizContainer').innerHTML = '<div class="empty-state"><div class="empty-icon">üéÆ</div><div>Uploadez une le√ßon en mode Parent</div></div>';
            document.getElementById('quizActions').style.display = 'none';
            clearUpload();
            notify('üîÑ Nouveau');
        }

        function handleUpload(file) {
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') return notify('‚ö†Ô∏è Format non support√©');
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedBase64 = e.target.result;
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('uploadPreview').style.display = 'block';
                document.getElementById('previewImg').src = file.type.startsWith('image/') ? e.target.result : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><rect fill="%23e74c3c" width="50" height="50" rx="5"/><text x="25" y="30" text-anchor="middle" fill="white" font-size="12">PDF</text></svg>';
            };
            reader.readAsDataURL(file);
        }

        function clearUpload() {
            uploadedFile = null;
            uploadedBase64 = null;
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        async function sendHomeworkMsg() {
            const input = document.getElementById('homeworkInput');
            const msg = input.value.trim();
            if (!msg && !uploadedFile) return;
            
            let display = msg || '';
            if (uploadedFile) display += (display ? ' ' : '') + 'üìé';
            addMsg('homeworkChat', display, 'user');
            input.value = '';
            
            const loading = addLoading('homeworkChat');
            
            // Build system prompt based on child and mode
            const child = currentChild || { name: 'l\'enfant', age: 10, class: 'CM2', interests: '' };
            const ageGroup = child.age <= 7 ? 'tr√®s jeune (CP-CE1)' : child.age <= 10 ? 'primaire (CE2-CM2)' : child.age <= 14 ? 'coll√®ge' : 'lyc√©e';
            
            let systemPrompt;
            if (homeworkMode === 'parent') {
                systemPrompt = `Tu aides un parent √† faire r√©viser ${child.name} (${child.age} ans, ${child.class}).
Adapte tes suggestions au niveau ${ageGroup}.
- Sugg√®re des questions pour tester la compr√©hension
- Identifie les points cl√©s de la le√ßon
- Propose des m√©thodes p√©dagogiques adapt√©es
${child.interests ? `Int√©r√™ts de l'enfant: ${child.interests} - utilise-les dans tes exemples !` : ''}
R√©ponds en fran√ßais, sois concis et pratique. Utilise des emojis.

IMPORTANT: G√©n√®re aussi 3-5 questions de quiz au format JSON √† la fin de ta r√©ponse:
[QUIZ]{"questions":[{"q":"Question?","options":["A","B","C"],"answer":0,"hint":"Indice"}]}[/QUIZ]`;
            } else {
                systemPrompt = `Tu es un assistant sympa qui aide ${child.name} (${child.age} ans, ${child.class}).
Adapte ton langage au niveau ${ageGroup}:
${child.age <= 7 ? '- Utilise des mots simples, des comparaisons avec la vie quotidienne, sois tr√®s encourageant' : ''}
${child.age <= 10 ? '- Explique clairement, utilise des exemples concrets et amusants' : ''}
${child.age <= 14 ? '- Sois clair et engageant, utilise des r√©f√©rences qui parlent aux ados' : ''}
${child.age > 14 ? '- Sois direct et pr√©cis, comme un bon tuteur' : ''}
${child.interests ? `Ses centres d'int√©r√™t: ${child.interests} - fais des liens avec !` : ''}
Utilise des emojis, encourage, f√©licite les efforts. R√©ponds en fran√ßais.`;
            }
            
            // Build content
            let content = [];
            if (uploadedBase64 && uploadedFile) {
                const b64 = uploadedBase64.split(',')[1];
                content.push(uploadedFile.type.startsWith('image/') 
                    ? { type: 'image', source: { type: 'base64', media_type: uploadedFile.type, data: b64 }}
                    : { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: b64 }});
            }
            content.push({ type: 'text', text: msg || 'Analyse cette le√ßon et aide-moi.' });
            
            try {
                const res = await fetch('/api/claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system: systemPrompt,
                        messages: [...homeworkHistory.slice(-6), { role: 'user', content: content.length === 1 ? content[0].text : content }]
                    })
                });
                loading.remove();
                if (res.ok) {
                    const r = await res.json();
                    let reply = r.content[0].text;
                    
                    // Extract quiz if present
                    const quizMatch = reply.match(/\[QUIZ\](.*?)\[\/QUIZ\]/s);
                    if (quizMatch) {
                        try {
                            const quizData = JSON.parse(quizMatch[1]);
                            quizQuestions = quizData.questions || [];
                            currentQuizIndex = 0;
                            quizScore = 0;
                            if (quizQuestions.length > 0) {
                                showQuiz();
                            }
                        } catch (e) { console.error('Quiz parse error', e); }
                        reply = reply.replace(/\[QUIZ\].*?\[\/QUIZ\]/s, '').trim();
                    }
                    
                    addMsg('homeworkChat', reply, 'assistant');
                    homeworkHistory.push({ role: 'user', content: msg || 'Document' }, { role: 'assistant', content: reply });
                    clearUpload();
                }
            } catch (e) { loading.remove(); addMsg('homeworkChat', '‚ùå Erreur', 'assistant'); }
        }

        // ============ QUIZ MODE ============
        function showQuiz() {
            if (currentQuizIndex >= quizQuestions.length) {
                showQuizResults();
                return;
            }
            
            const q = quizQuestions[currentQuizIndex];
            document.getElementById('quizProgress').innerHTML = quizQuestions.map((_, i) => 
                `<div class="progress-dot ${i < currentQuizIndex ? 'done' : i === currentQuizIndex ? 'current' : ''}"></div>`
            ).join('');
            
            const isOpenQuestion = !q.options || q.options.length === 0;
            
            document.getElementById('quizContainer').innerHTML = `
                <div class="quiz-card">
                    <div class="quiz-card-header">
                        <div class="quiz-subject">Question ${currentQuizIndex + 1}/${quizQuestions.length}</div>
                        <div class="quiz-question">${q.q}</div>
                    </div>
                    <div class="quiz-card-body">
                        ${isOpenQuestion 
                            ? `<input type="text" class="quiz-input" id="quizAnswer" placeholder="Ta r√©ponse...">`
                            : `<div class="quiz-options">${q.options.map((o, i) => `<div class="quiz-option" data-index="${i}" onclick="selectOption(this)">${o}</div>`).join('')}</div>`
                        }
                    </div>
                </div>
            `;
            document.getElementById('quizActions').style.display = 'block';
        }

        function selectOption(el) {
            document.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
        }

        function checkAnswer() {
            const q = quizQuestions[currentQuizIndex];
            const isOpen = !q.options || q.options.length === 0;
            
            let correct = false;
            if (isOpen) {
                const ans = document.getElementById('quizAnswer')?.value.trim().toLowerCase();
                correct = ans && (q.answer?.toLowerCase().includes(ans) || ans.includes(q.answer?.toLowerCase()));
            } else {
                const selected = document.querySelector('.quiz-option.selected');
                if (!selected) return notify('Choisis une r√©ponse !');
                const idx = parseInt(selected.dataset.index);
                correct = idx === q.answer;
                
                document.querySelectorAll('.quiz-option').forEach((o, i) => {
                    if (i === q.answer) o.classList.add('correct');
                    else if (i === idx) o.classList.add('wrong');
                });
            }
            
            if (correct) {
                quizScore++;
                document.querySelector('.quiz-card-header').classList.add('correct');
                notify('üéâ Bravo !');
            } else {
                document.querySelector('.quiz-card-header').classList.add('wrong');
                notify('‚ùå Pas tout √† fait...');
            }
            
            setTimeout(() => {
                currentQuizIndex++;
                showQuiz();
            }, 1500);
        }

        function skipQuestion() {
            currentQuizIndex++;
            showQuiz();
        }

        function getHint() {
            const q = quizQuestions[currentQuizIndex];
            if (q.hint) notify('üí° ' + q.hint);
            else notify('üí° R√©fl√©chis bien !');
        }

        function showQuizResults() {
            const pct = Math.round((quizScore / quizQuestions.length) * 100);
            document.getElementById('quizContainer').innerHTML = `
                <div class="quiz-score">
                    <div class="quiz-score-value">${quizScore}/${quizQuestions.length}</div>
                    <div class="quiz-score-label">${pct >= 80 ? 'üåü Excellent !' : pct >= 50 ? 'üëç Pas mal !' : 'üí™ Continue !'}</div>
                    <button class="quiz-restart" onclick="restartQuiz()">üîÑ Recommencer</button>
                </div>
            `;
            document.getElementById('quizActions').style.display = 'none';
        }

        function restartQuiz() {
            currentQuizIndex = 0;
            quizScore = 0;
            showQuiz();
        }

        // ============ CHILDREN ============
        function updateChildrenList() {
            document.getElementById('childrenList').innerHTML = data.children.map(c => `
                <div class="child-card">
                    <div class="child-avatar-lg">${c.avatar}</div>
                    <div class="child-info">
                        <div class="child-name">${c.name}</div>
                        <div class="child-details">${c.age} ans ‚Ä¢ ${c.class}${c.interests ? ' ‚Ä¢ ' + c.interests : ''}</div>
                    </div>
                    <button class="child-edit" onclick="editChild(${c.id})">‚úèÔ∏è</button>
                </div>
            `).join('') || '<div style="color:var(--sage);font-size:0.85rem;padding:0.5rem;">Aucun enfant ajout√©</div>';
        }

        function openChildModal(childId = null) {
            editingChild = childId ? data.children.find(c => c.id === childId) : null;
            document.getElementById('childModalTitle').textContent = editingChild ? '‚úèÔ∏è Modifier' : '‚ûï Ajouter';
            document.getElementById('deleteChildBtn').style.display = editingChild ? 'block' : 'none';
            
            document.getElementById('childName').value = editingChild?.name || '';
            document.getElementById('childAge').value = editingChild?.age || '';
            document.getElementById('childClass').value = editingChild?.class || '4e';
            document.getElementById('childInterests').value = editingChild?.interests || '';
            
            document.querySelectorAll('.avatar-option').forEach(a => {
                a.classList.toggle('selected', a.dataset.avatar === (editingChild?.avatar || 'üë¶'));
            });
            
            openModal('childModal');
        }

        function editChild(id) { openChildModal(id); }

        function saveChild() {
            const name = document.getElementById('childName').value.trim();
            const age = parseInt(document.getElementById('childAge').value);
            const cls = document.getElementById('childClass').value;
            const interests = document.getElementById('childInterests').value.trim();
            const avatar = document.querySelector('.avatar-option.selected')?.dataset.avatar || 'üë¶';
            
            if (!name || !age) return notify('‚ö†Ô∏è Pr√©nom et √¢ge requis');
            
            if (editingChild) {
                Object.assign(editingChild, { name, age, class: cls, interests, avatar });
            } else {
                data.children.push({ id: Date.now(), name, age, class: cls, interests, avatar });
            }
            
            save();
            updateChildrenList();
            updateChildDropdown();
            closeModal('childModal');
            notify('‚úÖ Enregistr√©');
        }

        function deleteChild() {
            if (!editingChild || !confirm(`Supprimer ${editingChild.name} ?`)) return;
            data.children = data.children.filter(c => c.id !== editingChild.id);
            if (currentChild?.id === editingChild.id) currentChild = data.children[0] || null;
            save();
            updateChildrenList();
            updateChildDropdown();
            closeModal('childModal');
            notify('üóëÔ∏è Supprim√©');
        }

        // ============ UTILS ============
        function addMsg(containerId, text, role) {
            const el = document.createElement('div');
            el.className = `message ${role}`;
            el.innerHTML = text.replace(/\n/g, '<br>');
            const container = document.getElementById(containerId);
            container.appendChild(el);
            container.scrollTop = 99999;
        }

        function addLoading(containerId) {
            const el = document.createElement('div');
            el.className = 'loading-dots';
            el.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
            document.getElementById(containerId).appendChild(el);
            return el;
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function notify(msg) {
            const n = document.createElement('div');
            n.className = 'notification';
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 2500);
        }

        init();
    </script>
</body>
</html>
