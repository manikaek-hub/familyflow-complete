<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow ‚ú®</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--cream:#FAF7F2;--sand:#E8DCC4;--terracotta:#C9856B;--forest:#5F7161;--sage:#8B9D83;--midnight:#2C3333;--white:#FFF;--red:#E74C3C;--green:#27AE60;--blue:#3498DB;--purple:#9B59B6;--orange:#E67E22;--yellow:#F1C40F}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:linear-gradient(135deg,var(--cream),#F0EDE5);color:var(--midnight);min-height:100vh;padding-bottom:75px}
        header{background:linear-gradient(135deg,var(--forest),var(--sage));padding:.8rem 1rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.15)}
        .header-left{display:flex;align-items:center;gap:.8rem}
        .back-btn{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.2);color:#fff;font-size:1rem;cursor:pointer;display:none}
        .back-btn.visible{display:flex;align-items:center;justify-content:center}
        .header-title{font-family:'Playfair Display',serif;font-size:1.5rem;color:#fff;font-weight:600;font-style:italic}
        .header-profile{width:36px;height:36px;border-radius:50%;background:var(--sand);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;border:2px solid #fff}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:.4rem 0;box-shadow:0 -2px 15px rgba(0,0,0,.1);z-index:100}
        .nav-item{display:flex;flex-direction:column;align-items:center;padding:.3rem .4rem;border:none;background:none;cursor:pointer;color:var(--sage);font-size:.55rem}
        .nav-item.active{color:var(--forest)}
        .nav-item .nav-icon{font-size:1.1rem;margin-bottom:.1rem}
        .container{max-width:600px;margin:0 auto;padding:1rem}
        .view{display:none}
        .view.active{display:block;animation:fadeIn .3s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .card{background:#fff;border-radius:15px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 15px rgba(0,0,0,.08)}
        .card-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--forest);margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
        .smart-notif{background:linear-gradient(135deg,var(--terracotta),#B8754A);border-radius:12px;padding:.8rem;margin-bottom:1rem;color:#fff;display:flex;align-items:center;gap:.8rem;cursor:pointer}
        .smart-notif-icon{font-size:1.5rem}
        .smart-notif-content{flex:1}
        .smart-notif-title{font-weight:600;font-size:.85rem}
        .smart-notif-text{font-size:.75rem;opacity:.9}
        .smart-notif-close{background:none;border:none;color:#fff;font-size:1rem;cursor:pointer;opacity:.7}
        .import-zone{border:3px dashed var(--sand);border-radius:15px;padding:2rem 1rem;text-align:center;cursor:pointer;background:#fff}
        .import-zone:hover{border-color:var(--forest)}
        .import-icon{font-size:2.5rem;margin-bottom:.5rem}
        .import-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--forest)}
        .import-text{color:var(--sage);font-size:.8rem;margin-top:.3rem}
        .loading-container{text-align:center;padding:2rem}
        .loading-spinner{width:40px;height:40px;border:3px solid var(--sand);border-top-color:var(--forest);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto .8rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin-bottom:1rem}
        .stat-card{background:#fff;border-radius:12px;padding:.8rem;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.06)}
        .stat-card.income{border-left:3px solid var(--green)}
        .stat-card.expense{border-left:3px solid var(--terracotta)}
        .stat-card.balance{border-left:3px solid var(--blue)}
        .stat-card.savings{border-left:3px solid var(--purple)}
        .stat-icon{font-size:1.3rem}
        .stat-value{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:600}
        .stat-label{font-size:.65rem;color:var(--sage)}
        .category-item{display:flex;align-items:center;gap:.5rem;padding:.5rem 0;border-bottom:1px solid var(--cream)}
        .category-item:last-child{border-bottom:none}
        .category-emoji{font-size:1.1rem}
        .category-info{flex:1}
        .category-name{font-size:.8rem;font-weight:500}
        .category-bar{height:5px;background:var(--cream);border-radius:3px;margin-top:.2rem}
        .category-fill{height:100%;border-radius:3px}
        .category-amount{font-weight:600;font-size:.85rem}
        .transaction-item{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--cream);border-radius:10px;margin-bottom:.4rem;cursor:pointer}
        .transaction-emoji{font-size:1rem}
        .transaction-info{flex:1;min-width:0}
        .transaction-desc{font-size:.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .transaction-date{font-size:.65rem;color:var(--sage)}
        .transaction-amount{font-weight:600;font-size:.85rem}
        .transaction-amount.income{color:var(--green)}
        .transaction-amount.expense{color:var(--terracotta)}
        .alert-card{border-radius:10px;padding:.8rem;margin-bottom:.6rem;display:flex;align-items:flex-start;gap:.6rem}
        .alert-card.warning{background:#FFF3E0;border-left:3px solid var(--orange)}
        .alert-card.danger{background:#FFEBEE;border-left:3px solid var(--red)}
        .alert-card.success{background:#E8F5E9;border-left:3px solid var(--green)}
        .alert-card.tip{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .alert-icon{font-size:1.2rem}
        .alert-content{flex:1}
        .alert-title{font-weight:600;font-size:.85rem}
        .alert-text{font-size:.75rem;opacity:.9}
        .score-circle{width:70px;height:70px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto .6rem}
        .score-circle.good{background:linear-gradient(135deg,var(--green),#2ECC71)}
        .score-circle.warning{background:linear-gradient(135deg,var(--orange),#F39C12)}
        .score-circle.bad{background:linear-gradient(135deg,var(--red),#C0392B)}
        .score-value{font-size:1.3rem;font-weight:700;color:#fff}
        .score-label{font-size:.5rem;color:rgba(255,255,255,.8)}
        .planning-week{display:flex;gap:.3rem;margin-bottom:1rem;overflow-x:auto;padding-bottom:.3rem}
        .planning-day{flex:1;min-width:65px;text-align:center;padding:.5rem;background:var(--cream);border-radius:10px;cursor:pointer}
        .planning-day.active{background:var(--forest);color:#fff}
        .planning-day.today{border:2px solid var(--terracotta)}
        .planning-day-name{font-size:.7rem;font-weight:500}
        .planning-day-num{font-size:1.1rem;font-weight:600}
        .activity-item{display:flex;align-items:center;gap:.6rem;padding:.7rem;background:var(--cream);border-radius:10px;margin-bottom:.5rem;cursor:pointer}
        .activity-time{font-size:.75rem;font-weight:600;color:var(--forest);min-width:45px}
        .activity-info{flex:1}
        .activity-title{font-size:.85rem;font-weight:500}
        .activity-child{font-size:.7rem;color:var(--sage)}
        .activity-icon{font-size:1.2rem}
        .add-activity-btn{width:100%;padding:.7rem;border:2px dashed var(--sand);border-radius:10px;background:none;color:var(--sage);font-size:.85rem;cursor:pointer;margin-top:.5rem}
        .add-activity-btn:hover{border-color:var(--forest);color:var(--forest)}
        .chat-container{display:flex;flex-direction:column;height:calc(100vh - 220px);max-height:350px}
        .chat-messages{flex:1;overflow-y:auto;padding:.5rem;display:flex;flex-direction:column;gap:.5rem}
        .message{max-width:85%;padding:.6rem .8rem;border-radius:12px;font-size:.85rem;line-height:1.4}
        .message.user{background:var(--forest);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
        .message.assistant{background:var(--cream);align-self:flex-start;border-bottom-left-radius:4px}
        .chat-input-container{display:flex;gap:.4rem;padding:.5rem;background:var(--cream);border-radius:10px;margin-top:.5rem}
        .chat-input{flex:1;padding:.5rem;border:none;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.85rem}
        .chat-input:focus{outline:none}
        .chat-send{padding:.5rem .8rem;border:none;border-radius:8px;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;font-weight:500;cursor:pointer}
        .suggestion-btn{padding:.35rem .6rem;border:2px solid var(--sand);border-radius:15px;background:#fff;font-size:.7rem;cursor:pointer;margin:.2rem}
        .suggestion-btn:hover{border-color:var(--forest)}
        .homework-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;gap:.5rem}
        .child-selector{position:relative;display:flex;align-items:center;gap:.4rem;padding:.5rem .8rem;background:#fff;border-radius:25px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1);flex:1;max-width:180px}
        .child-selector .avatar{font-size:1.2rem}
        .child-selector .name{font-weight:500;font-size:.85rem;flex:1}
        .child-selector .arrow{font-size:.6rem;color:var(--sage);transition:transform .3s}
        .child-selector.open .arrow{transform:rotate(180deg)}
        .child-dropdown{position:absolute;top:calc(100% + 5px);left:0;right:0;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:50;overflow:hidden;max-height:0;opacity:0;transition:all .3s}
        .child-dropdown.show{max-height:300px;opacity:1}
        .child-dropdown-item{display:flex;align-items:center;gap:.5rem;padding:.7rem .8rem;cursor:pointer;font-size:.85rem}
        .child-dropdown-item:hover{background:var(--cream)}
        .child-dropdown-item.active{background:var(--sand)}
        .header-actions{display:flex;gap:.4rem}
        .action-btn{padding:.4rem .6rem;border:none;border-radius:8px;font-size:.7rem;cursor:pointer}
        .action-btn.primary{background:var(--terracotta);color:#fff}
        .action-btn.secondary{background:var(--sand);color:var(--midnight)}
        .mode-toggle{display:flex;background:var(--cream);border-radius:10px;padding:.25rem;margin-bottom:.8rem}
        .mode-btn{flex:1;padding:.5rem;border:none;border-radius:8px;background:none;font-size:.8rem;cursor:pointer}
        .mode-btn.active{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .upload-zone{border:2px dashed var(--sand);border-radius:10px;padding:.8rem;text-align:center;cursor:pointer;font-size:.8rem;color:var(--sage);margin-bottom:.5rem}
        .upload-preview{position:relative;padding:.5rem;background:var(--cream);border-radius:10px;text-align:center;margin-bottom:.5rem}
        .upload-preview img{max-width:100%;max-height:80px;border-radius:6px}
        .remove-upload{position:absolute;top:3px;right:3px;width:18px;height:18px;border-radius:50%;border:none;background:var(--red);color:#fff;cursor:pointer;font-size:.6rem}
        
        /* LESSON CONTENT STYLING */
        .lesson-container{margin-top:1rem}
        .lesson-section{background:#fff;border-radius:15px;margin-bottom:1rem;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.08)}
        .lesson-section-header{padding:.8rem 1rem;font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:.5rem;cursor:pointer}
        .lesson-section-header.summary{background:linear-gradient(135deg,var(--blue),#5DADE2);color:#fff}
        .lesson-section-header.mindmap{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff}
        .lesson-section-header.qa{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .lesson-section-header .toggle-icon{margin-left:auto;transition:transform .3s}
        .lesson-section-header.collapsed .toggle-icon{transform:rotate(-90deg)}
        .lesson-section-content{padding:1rem;display:block}
        .lesson-section-content.hidden{display:none}
        
        /* Summary styling */
        .summary-content{font-size:.9rem;line-height:1.6}
        .summary-content p{margin-bottom:.8rem}
        .summary-content .key-point{background:linear-gradient(135deg,rgba(52,152,219,.1),rgba(52,152,219,.05));border-left:3px solid var(--blue);padding:.5rem .8rem;margin:.5rem 0;border-radius:0 8px 8px 0}
        .summary-content .definition{background:var(--cream);padding:.6rem;border-radius:8px;margin:.5rem 0}
        .summary-content .definition-term{font-weight:600;color:var(--forest)}
        
        /* Mind Map styling */
        .mindmap-container{padding:.5rem}
        .mindmap-center{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff;padding:.8rem 1.2rem;border-radius:25px;text-align:center;font-weight:600;font-size:.95rem;margin:0 auto 1rem;max-width:200px}
        .mindmap-branches{display:flex;flex-direction:column;gap:.8rem}
        .mindmap-branch{display:flex;align-items:flex-start;gap:.5rem}
        .mindmap-branch-icon{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
        .mindmap-branch:nth-child(1) .mindmap-branch-icon{background:#E8F5E9}
        .mindmap-branch:nth-child(2) .mindmap-branch-icon{background:#FFF3E0}
        .mindmap-branch:nth-child(3) .mindmap-branch-icon{background:#E3F2FD}
        .mindmap-branch:nth-child(4) .mindmap-branch-icon{background:#FCE4EC}
        .mindmap-branch:nth-child(5) .mindmap-branch-icon{background:#F3E5F5}
        .mindmap-branch-content{flex:1;background:var(--cream);padding:.6rem .8rem;border-radius:10px}
        .mindmap-branch-title{font-weight:600;font-size:.85rem;color:var(--forest);margin-bottom:.3rem}
        .mindmap-branch-items{font-size:.8rem;color:var(--midnight)}
        .mindmap-branch-items li{margin-left:1rem;margin-bottom:.2rem}
        
        /* Q&A Cards */
        .qa-cards-container{display:flex;flex-direction:column;gap:.6rem}
        .qa-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid var(--sand)}
        .qa-question{padding:.8rem;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;font-weight:500;font-size:.85rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
        .qa-question .toggle{font-size:.7rem;transition:transform .3s}
        .qa-question.open .toggle{transform:rotate(180deg)}
        .qa-answer{max-height:0;overflow:hidden;transition:all .3s;background:var(--cream)}
        .qa-answer.show{max-height:500px}
        .qa-answer-content{padding:.8rem}
        .qa-answer-text{font-size:.85rem;line-height:1.5;color:var(--midnight)}
        
        /* Action buttons */
        .lesson-actions{display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap}
        .lesson-action-btn{flex:1;min-width:120px;padding:.7rem;border:none;border-radius:10px;font-size:.85rem;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.4rem}
        .lesson-action-btn.quiz{background:linear-gradient(135deg,var(--terracotta),#D98B70);color:#fff}
        .lesson-action-btn.continue{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        
        /* Quiz styles */
        .quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .quiz-progress{display:flex;gap:.3rem}
        .progress-dot{width:10px;height:10px;border-radius:50%;background:var(--sand)}
        .progress-dot.done{background:var(--green)}
        .progress-dot.current{background:var(--blue);transform:scale(1.3)}
        .progress-dot.wrong{background:var(--red)}
        .quiz-score-display{font-weight:600;font-size:.9rem;color:var(--forest)}
        .quiz-card{background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden;margin-bottom:1rem}
        .quiz-card-header{padding:1.2rem;text-align:center;background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .quiz-card-header.correct{background:linear-gradient(135deg,var(--green),#2ECC71)}
        .quiz-card-header.wrong{background:linear-gradient(135deg,var(--red),#C0392B)}
        .quiz-number{font-size:.75rem;opacity:.9;margin-bottom:.3rem}
        .quiz-question{font-size:1.05rem;font-weight:600;line-height:1.4}
        .quiz-card-body{padding:1rem}
        .quiz-options{display:flex;flex-direction:column;gap:.5rem}
        .quiz-option{padding:.8rem;border:2px solid var(--sand);border-radius:12px;text-align:left;cursor:pointer;font-size:.9rem;transition:all .3s}
        .quiz-option:hover{border-color:var(--blue);background:rgba(52,152,219,.05)}
        .quiz-option.selected{border-color:var(--blue);background:rgba(52,152,219,.15)}
        .quiz-option.correct{border-color:var(--green);background:rgba(39,174,96,.15)}
        .quiz-option.wrong{border-color:var(--red);background:rgba(231,76,60,.15)}
        .quiz-option.disabled{pointer-events:none;opacity:.7}
        .quiz-actions{display:flex;justify-content:center;gap:1rem;margin-top:1rem}
        .quiz-btn{width:55px;height:55px;border-radius:50%;border:none;font-size:1.4rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .quiz-btn.hint{background:linear-gradient(135deg,var(--orange),var(--yellow));color:#fff}
        .quiz-btn.check{background:linear-gradient(135deg,var(--green),#2ECC71);color:#fff}
        .quiz-btn.next{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .quiz-hint{text-align:center;padding:.6rem;background:#FFF3E0;border-radius:10px;margin-top:.8rem;font-size:.85rem;color:var(--orange)}
        .quiz-explanation{padding:.8rem;background:var(--cream);border-radius:10px;margin-top:.8rem;font-size:.85rem}
        .quiz-results{text-align:center;padding:2rem 1rem}
        .quiz-results-score{font-size:3rem;font-weight:700;color:var(--forest)}
        .quiz-results-text{color:var(--sage);margin:.5rem 0 1rem}
        .quiz-results-btn{padding:.8rem 1.5rem;border:none;border-radius:25px;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;font-weight:500;cursor:pointer;margin:.3rem}
        
        .profile-header{text-align:center;padding:1.5rem;background:linear-gradient(135deg,var(--forest),var(--sage));border-radius:15px;margin-bottom:1rem;color:#fff}
        .profile-avatar{width:60px;height:60px;border-radius:50%;background:var(--sand);margin:0 auto .5rem;display:flex;align-items:center;justify-content:center;font-size:1.8rem;border:3px solid #fff}
        .profile-name{font-size:1.1rem;font-weight:600}
        .family-section{margin-bottom:1rem}
        .family-title{font-size:.85rem;color:var(--sage);margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
        .add-child-btn{padding:.3rem .6rem;border:none;border-radius:15px;background:var(--terracotta);color:#fff;font-size:.7rem;cursor:pointer}
        .child-card{display:flex;align-items:center;gap:.8rem;padding:.8rem;background:#fff;border-radius:12px;margin-bottom:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .child-avatar-lg{width:45px;height:45px;border-radius:50%;background:var(--cream);display:flex;align-items:center;justify-content:center;font-size:1.5rem}
        .child-info{flex:1}
        .child-name{font-weight:600;font-size:.95rem}
        .child-details{font-size:.75rem;color:var(--sage)}
        .child-edit{padding:.3rem .6rem;border:1px solid var(--sand);border-radius:8px;background:none;font-size:.7rem;cursor:pointer}
        .logout-btn{width:100%;padding:.8rem;border:none;border-radius:10px;background:var(--red);color:#fff;font-weight:500;cursor:pointer;margin-top:1rem}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:#fff;border-radius:15px;padding:1.2rem;max-width:350px;width:90%;max-height:80vh;overflow-y:auto;transform:scale(.9);transition:transform .3s}
        .modal-overlay.active .modal{transform:scale(1)}
        .modal-title{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--forest);margin-bottom:1rem;text-align:center}
        .form-group{margin-bottom:.7rem}
        .form-label{display:block;font-size:.75rem;color:var(--sage);margin-bottom:.2rem}
        .form-input,.form-select{width:100%;padding:.6rem;border:2px solid var(--sand);border-radius:8px;font-family:'Outfit',sans-serif;font-size:.9rem}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--forest)}
        .avatar-picker{display:flex;justify-content:center;gap:.5rem;margin-bottom:1rem}
        .avatar-option{width:40px;height:40px;border-radius:50%;border:2px solid var(--sand);display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer}
        .avatar-option.selected{border-color:var(--forest);background:var(--cream)}
        .modal-buttons{display:flex;gap:.6rem;margin-top:1rem}
        .modal-btn{flex:1;padding:.7rem;border:none;border-radius:8px;font-weight:500;cursor:pointer;font-size:.85rem}
        .btn-cancel{background:var(--sand)}
        .btn-save{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .btn-delete{background:var(--red);color:#fff}
        .notification{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;padding:.6rem 1.2rem;border-radius:25px;box-shadow:0 4px 15px rgba(0,0,0,.2);z-index:2000;animation:slideDown .3s ease-out;font-size:.85rem}
        @keyframes slideDown{from{transform:translateX(-50%) translateY(-100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
        .loading-dots{display:flex;gap:.2rem;padding:.5rem}
        .loading-dot{width:6px;height:6px;border-radius:50%;background:var(--sage);animation:bounce 1.4s infinite ease-in-out both}
        .loading-dot:nth-child(1){animation-delay:-.32s}
        .loading-dot:nth-child(2){animation-delay:-.16s}
        @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
        .empty-state{text-align:center;padding:2rem;color:var(--sage)}
        .empty-icon{font-size:2.5rem;margin-bottom:.5rem}
        .reset-btn{display:block;width:100%;padding:.6rem;border:2px dashed var(--sand);border-radius:8px;background:none;color:var(--sage);cursor:pointer;font-size:.8rem;margin-top:1rem}
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê</button>
            <div class="header-title">üåä FamilyFlow</div>
        </div>
        <div class="header-profile" onclick="switchView('profile')">üë§</div>
    </header>
    <div class="container">
        <div class="view active" id="budget-view">
            <div id="smartNotifications"></div>
            <div class="import-zone" id="importZone"><div class="import-icon">üìÑ</div><div class="import-title">Importer votre relev√©</div><div class="import-text">PDF ou cliquez</div><input type="file" id="importInput" accept=".pdf,.csv" style="display:none"></div>
            <div class="loading-container" id="loadingContainer" style="display:none"><div class="loading-spinner"></div><div style="color:var(--sage);font-size:.85rem">ü§ñ Analyse...</div></div>
            <div id="dashboardContent" style="display:none">
                <div class="stats-grid">
                    <div class="stat-card income"><div class="stat-icon">üì•</div><div class="stat-value" id="totalIncome">0‚Ç¨</div><div class="stat-label">Revenus</div></div>
                    <div class="stat-card expense"><div class="stat-icon">üí≥</div><div class="stat-value" id="totalExpenses">0‚Ç¨</div><div class="stat-label">D√©penses</div></div>
                    <div class="stat-card balance"><div class="stat-icon">üí∞</div><div class="stat-value" id="totalBalance">0‚Ç¨</div><div class="stat-label">Solde</div></div>
                    <div class="stat-card savings"><div class="stat-icon">üéØ</div><div class="stat-value" id="savingsRate">0%</div><div class="stat-label">√âpargne</div></div>
                </div>
                <div class="card"><div class="card-title">üìä R√©partition</div><div id="categoryBreakdown"></div></div>
                <div class="card"><div class="card-title">üìã Transactions</div><div id="recentTransactions"></div></div>
                <button class="reset-btn" onclick="resetData()">üîÑ Nouveau relev√©</button>
            </div>
        </div>
        <div class="view" id="optimize-view"><div id="optimizeContent"><div class="empty-state"><div class="empty-icon">üìä</div><div>Importez un relev√©</div></div></div></div>
        <div class="view" id="planning-view">
            <div class="card"><div class="card-title">üìÖ Cette semaine</div><div class="planning-week" id="planningWeek"></div></div>
            <div class="card"><div class="card-title" id="selectedDayTitle">üìã Activit√©s</div><div id="activitiesList"></div><button class="add-activity-btn" onclick="openActivityModal()">+ Ajouter</button></div>
        </div>
        <div class="view" id="assistant-view">
            <div class="card chat-container">
                <div class="chat-messages" id="budgetChat"><div class="message assistant">üëã Questions budget ?</div></div>
                <div style="display:flex;flex-wrap:wrap;padding:.3rem"><button class="suggestion-btn" onclick="askBudget('Comment √©conomiser ?')">üí° √âconomiser</button><button class="suggestion-btn" onclick="askBudget('Mes abonnements')">üì± Abonnements</button></div>
                <div class="chat-input-container"><input type="text" class="chat-input" id="budgetInput" placeholder="Question..."><button class="chat-send" onclick="sendBudgetMsg()">‚Üí</button></div>
            </div>
        </div>
        <div class="view" id="homework-view">
            <div class="homework-header">
                <div class="child-selector" id="childSelector"><span class="avatar" id="currentAvatar">üë¶</span><span class="name" id="currentName">Choisir</span><span class="arrow">‚ñº</span><div class="child-dropdown" id="childDropdown"></div></div>
                <div class="header-actions"><button class="action-btn secondary" onclick="newChat()">üîÑ</button></div>
            </div>
            
            <div class="mode-toggle"><button class="mode-btn active" data-mode="parent" onclick="setMode('parent')">üë®‚Äçüë©‚Äçüëß Parent</button><button class="mode-btn" data-mode="child" onclick="setMode('child')">üéÆ Enfant</button></div>
            
            <div id="parentMode">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">üìé Photo ou PDF de la le√ßon<input type="file" id="fileInput" accept="image/*,.pdf" style="display:none"></div>
                <div class="upload-preview" id="uploadPreview" style="display:none"><img id="previewImg" src=""><button class="remove-upload" onclick="clearUpload()">‚úï</button></div>
                <div class="chat-input-container"><input type="text" class="chat-input" id="parentInput" placeholder="Sujet de la le√ßon ou question..."><button class="chat-send" onclick="sendParentMsg()">‚Üí</button></div>
                <div id="lessonContent"></div>
            </div>
            
            <div id="childMode" style="display:none">
                <div class="quiz-header"><div class="quiz-progress" id="quizProgress"></div><div class="quiz-score-display" id="quizScoreDisplay">Score: 0</div></div>
                <div id="quizContent"><div class="empty-state"><div class="empty-icon">üéÆ</div><div>G√©n√©rez des questions en mode Parent</div></div></div>
            </div>
        </div>
        <div class="view" id="profile-view">
            <div class="profile-header"><div class="profile-avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div><div class="profile-name">Ma Famille</div></div>
            <div class="family-section"><div class="family-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Enfants <button class="add-child-btn" onclick="openChildModal()">+ Ajouter</button></div><div id="childrenList"></div></div>
            <button class="logout-btn" onclick="resetAll()">üö™ R√©initialiser</button>
        </div>
    </div>
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="budget"><span class="nav-icon">üí∞</span>Budget</button>
        <button class="nav-item" data-view="optimize"><span class="nav-icon">üéØ</span>Optimiser</button>
        <button class="nav-item" data-view="planning"><span class="nav-icon">üìÖ</span>Planning</button>
        <button class="nav-item" data-view="assistant"><span class="nav-icon">ü§ñ</span>Assistant</button>
        <button class="nav-item" data-view="homework"><span class="nav-icon">üìö</span>Devoirs</button>
    </nav>
    <div class="modal-overlay" id="childModal">
        <div class="modal">
            <div class="modal-title" id="childModalTitle">‚ûï Ajouter</div>
            <div class="avatar-picker"><div class="avatar-option selected" data-avatar="üë¶">üë¶</div><div class="avatar-option" data-avatar="üëß">üëß</div><div class="avatar-option" data-avatar="üßí">üßí</div><div class="avatar-option" data-avatar="üë∂">üë∂</div></div>
            <div class="form-group"><label class="form-label">Pr√©nom</label><input type="text" class="form-input" id="childNameInput"></div>
            <div class="form-group"><label class="form-label">√Çge</label><input type="number" class="form-input" id="childAgeInput" min="3" max="18"></div>
            <div class="form-group"><label class="form-label">Classe</label><select class="form-select" id="childClassInput"><option value="CP">CP</option><option value="CE1">CE1</option><option value="CE2">CE2</option><option value="CM1">CM1</option><option value="CM2">CM2</option><option value="6e">6√®me</option><option value="5e">5√®me</option><option value="4e" selected>4√®me</option><option value="3e">3√®me</option><option value="2nde">2nde</option><option value="1ere">1√®re</option><option value="Term">Terminale</option></select></div>
            <div class="form-group"><label class="form-label">Int√©r√™ts</label><input type="text" class="form-input" id="childInterestsInput" placeholder="foot, manga..."></div>
            <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('childModal')">Annuler</button><button class="modal-btn btn-delete" id="deleteChildBtn" onclick="deleteChild()" style="display:none">üóëÔ∏è</button><button class="modal-btn btn-save" onclick="saveChild()">OK</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="activityModal">
        <div class="modal">
            <div class="modal-title" id="activityModalTitle">‚ûï Activit√©</div>
            <div class="form-group"><label class="form-label">Titre</label><input type="text" class="form-input" id="activityTitle" placeholder="Tennis..."></div>
            <div class="form-group"><label class="form-label">Heure</label><input type="time" class="form-input" id="activityTime"></div>
            <div class="form-group"><label class="form-label">Enfant</label><select class="form-select" id="activityChild"></select></div>
            <div class="form-group"><label class="form-label">R√©currence</label><select class="form-select" id="activityRecur"><option value="once">Une fois</option><option value="weekly">Chaque semaine</option></select></div>
            <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('activityModal')">Annuler</button><button class="modal-btn btn-delete" id="deleteActivityBtn" onclick="deleteActivity()" style="display:none">üóëÔ∏è</button><button class="modal-btn btn-save" onclick="saveActivity()">OK</button></div>
        </div>
    </div>
    <script>
const CATEGORIES={shopping:{emoji:'üõí',name:'Shopping',color:'#E74C3C'},food:{emoji:'üçï',name:'Alimentation',color:'#E67E22'},transport:{emoji:'üöó',name:'Transport',color:'#3498DB'},housing:{emoji:'üè†',name:'Logement',color:'#9B59B6'},bills:{emoji:'üìÑ',name:'Factures',color:'#8E44AD'},entertainment:{emoji:'üé¨',name:'Loisirs',color:'#1ABC9C'},health:{emoji:'üíä',name:'Sant√©',color:'#E91E63'},subscriptions:{emoji:'üì±',name:'Abos',color:'#00BCD4'},salary:{emoji:'üíº',name:'Revenus',color:'#27AE60'},other:{emoji:'üì¶',name:'Autre',color:'#7F8C8D'}};
const DAYS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
let data={transactions:[],budgets:{},children:[{id:1,name:'Gauthier',age:13,class:'4e',avatar:'üë¶',interests:'jeux vid√©o, histoire'},{id:2,name:'Charles',age:11,class:'6e',avatar:'üßí',interests:'foot, sciences'},{id:3,name:'Victoire',age:7,class:'CE1',avatar:'üëß',interests:'dessin, animaux'}],activities:[],dismissedNotifs:[]};
let currentChild=null,currentView='budget',viewHistory=[],editingChild=null,editingActivity=null,selectedDate=new Date(),uploadedFile=null,uploadedBase64=null;
let quizQuestions=[],quizIndex=0,quizScore=0,quizAnswered=false;
let conversationHistory=[];  // HISTORIQUE DE CONVERSATION
let currentLesson={summary:'',mindmap:null,qaCards:[]};

function init(){const s=localStorage.getItem('familyflow_v8');if(s)data={...data,...JSON.parse(s)};if(data.children.length>0)currentChild=data.children[0];setupListeners();updateAll();generateNotifs()}
function save(){localStorage.setItem('familyflow_v8',JSON.stringify(data))}

function generateNotifs(){const n=[],t=new Date(),ta=data.activities.filter(a=>{const d=new Date(a.date);return d.toDateString()===t.toDateString()});if(ta.length>0){const a=ta[0],c=data.children.find(x=>x.id===a.childId);n.push({id:'act',icon:'üìÖ',title:a.title+' aujourd\'hui',text:c?c.name+' √† '+a.time:'√Ä '+a.time,action:()=>switchView('planning')})}if(data.transactions.length>0){const e=data.transactions.filter(t=>t.amount<0),bc={};e.forEach(t=>{bc[t.category||'other']=(bc[t.category||'other']||0)+Math.abs(t.amount)});if((bc.subscriptions||0)>100&&!data.dismissedNotifs.includes('subs'))n.push({id:'subs',icon:'üì±',title:Math.round(bc.subscriptions)+'‚Ç¨ abonnements',text:'V√©rifiez leur utilit√©',action:()=>switchView('optimize')});const i=data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),te=e.reduce((s,t)=>s+Math.abs(t.amount),0),sr=i>0?(i-te)/i:0;if(sr<.15&&data.children.length>0&&!data.dismissedNotifs.includes('sav'))n.push({id:'sav',icon:'üí°',title:'Astuce √©pargne',text:'Mettez 50‚Ç¨/mois de c√¥t√© pour '+data.children.map(c=>c.name).join(', '),action:()=>switchView('assistant')})}const h=t.getHours();if(h>=17&&h<=20&&data.children.length>0&&!data.dismissedNotifs.includes('hw'+t.toDateString())){const sc=data.children.filter(c=>c.age>=6);if(sc.length>0)n.push({id:'hw'+t.toDateString(),icon:'üìö',title:'Heure des devoirs!',text:'Accompagnez '+sc[0].name,action:()=>switchView('homework')})}renderNotifs(n.slice(0,2))}
function renderNotifs(n){const c=document.getElementById('smartNotifications');c.innerHTML=n.map(x=>'<div class="smart-notif" onclick="handleNotif(\''+x.id+'\')"><div class="smart-notif-icon">'+x.icon+'</div><div class="smart-notif-content"><div class="smart-notif-title">'+x.title+'</div><div class="smart-notif-text">'+x.text+'</div></div><button class="smart-notif-close" onclick="dismissNotif(event,\''+x.id+'\')">‚úï</button></div>').join('');window.notifAct={};n.forEach(x=>{window.notifAct[x.id]=x.action})}
function handleNotif(id){if(window.notifAct[id])window.notifAct[id]()}
function dismissNotif(e,id){e.stopPropagation();data.dismissedNotifs.push(id);save();generateNotifs()}
function switchView(v){if(currentView!==v)viewHistory.push(currentView);currentView=v;document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.getElementById(v+'-view').classList.add('active');document.querySelector('[data-view="'+v+'"]')?.classList.add('active');document.getElementById('backBtn').classList.toggle('visible',viewHistory.length>0);if(v==='planning')updatePlanning()}
function goBack(){if(viewHistory.length>0){const p=viewHistory.pop();currentView=p;document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.getElementById(p+'-view').classList.add('active');document.querySelector('[data-view="'+p+'"]')?.classList.add('active')}document.getElementById('backBtn').classList.toggle('visible',viewHistory.length>0)}
function setupListeners(){document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>switchView(n.dataset.view)));document.getElementById('importZone').addEventListener('click',()=>document.getElementById('importInput').click());document.getElementById('importInput').addEventListener('change',e=>e.target.files[0]&&importFile(e.target.files[0]));document.getElementById('fileInput').addEventListener('change',e=>e.target.files[0]&&handleUpload(e.target.files[0]));document.getElementById('budgetInput').addEventListener('keypress',e=>e.key==='Enter'&&sendBudgetMsg());document.getElementById('parentInput').addEventListener('keypress',e=>e.key==='Enter'&&sendParentMsg());document.getElementById('childSelector').addEventListener('click',e=>{e.stopPropagation();document.getElementById('childDropdown').classList.toggle('show');document.getElementById('childSelector').classList.toggle('open')});document.addEventListener('click',()=>{document.getElementById('childDropdown').classList.remove('show');document.getElementById('childSelector').classList.remove('open')});document.querySelectorAll('.avatar-option').forEach(a=>a.addEventListener('click',()=>{document.querySelectorAll('.avatar-option').forEach(o=>o.classList.remove('selected'));a.classList.add('selected')}));document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>e.target===m&&closeModal(m.id)))}
function updateAll(){updateChildSelector();updateChildrenList();const h=data.transactions.length>0;document.getElementById('importZone').style.display=h?'none':'block';document.getElementById('dashboardContent').style.display=h?'block':'none';if(h){updateDashboard();updateOptimize()}updatePlanning()}
function updateChildSelector(){const d=document.getElementById('childDropdown');d.innerHTML=data.children.map(c=>'<div class="child-dropdown-item '+(currentChild?.id===c.id?'active':'')+'" onclick="selectChild('+c.id+')">'+c.avatar+' '+c.name+' ('+c.class+')</div>').join('')||'<div class="child-dropdown-item" style="color:var(--sage)">Ajoutez un enfant</div>';if(currentChild){document.getElementById('currentAvatar').textContent=currentChild.avatar;document.getElementById('currentName').textContent=currentChild.name}}
function selectChild(id){currentChild=data.children.find(c=>c.id===id);updateChildSelector();document.getElementById('childDropdown').classList.remove('show');document.getElementById('childSelector').classList.remove('open');notify('üëã '+currentChild.name)}
function updatePlanning(){const t=new Date(),ws=new Date(t);ws.setDate(t.getDate()-t.getDay()+1);let wh='';for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(ws.getDate()+i);const it=d.toDateString()===t.toDateString(),is=d.toDateString()===selectedDate.toDateString();wh+='<div class="planning-day '+(is?'active':'')+' '+(it?'today':'')+'" onclick="selectPlanningDate(\''+d.toISOString()+'\')"><div class="planning-day-name">'+DAYS[d.getDay()]+'</div><div class="planning-day-num">'+d.getDate()+'</div></div>'}document.getElementById('planningWeek').innerHTML=wh;document.getElementById('selectedDayTitle').textContent='üìã '+selectedDate.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});const da=data.activities.filter(a=>{const ad=new Date(a.date);return a.recurrence==='weekly'?ad.getDay()===selectedDate.getDay():ad.toDateString()===selectedDate.toDateString()}).sort((a,b)=>a.time.localeCompare(b.time));document.getElementById('activitiesList').innerHTML=da.length?da.map(a=>{const c=data.children.find(x=>x.id===a.childId);return'<div class="activity-item" onclick="editActivity('+a.id+')"><div class="activity-time">'+a.time+'</div><div class="activity-info"><div class="activity-title">'+a.title+'</div><div class="activity-child">'+(c?c.avatar+' '+c.name:'')+'</div></div><div class="activity-icon">üìå</div></div>'}).join(''):'<div class="empty-state" style="padding:1rem"><div>Aucune activit√©</div></div>'}
function selectPlanningDate(iso){selectedDate=new Date(iso);updatePlanning()}
function openActivityModal(id=null){editingActivity=id?data.activities.find(a=>a.id===id):null;document.getElementById('activityModalTitle').textContent=editingActivity?'‚úèÔ∏è Modifier':'‚ûï Activit√©';document.getElementById('deleteActivityBtn').style.display=editingActivity?'block':'none';document.getElementById('activityTitle').value=editingActivity?.title||'';document.getElementById('activityTime').value=editingActivity?.time||'14:00';document.getElementById('activityRecur').value=editingActivity?.recurrence||'once';document.getElementById('activityChild').innerHTML='<option value="">Famille</option>'+data.children.map(c=>'<option value="'+c.id+'" '+(editingActivity?.childId===c.id?'selected':'')+'>'+c.avatar+' '+c.name+'</option>').join('');openModal('activityModal')}
function editActivity(id){openActivityModal(id)}
function saveActivity(){const t=document.getElementById('activityTitle').value.trim();if(!t)return notify('‚ö†Ô∏è Titre requis');const a={id:editingActivity?.id||Date.now(),title:t,time:document.getElementById('activityTime').value,childId:parseInt(document.getElementById('activityChild').value)||null,date:selectedDate.toISOString(),recurrence:document.getElementById('activityRecur').value};if(editingActivity){const i=data.activities.findIndex(x=>x.id===editingActivity.id);if(i>=0)data.activities[i]=a}else data.activities.push(a);save();updatePlanning();closeModal('activityModal');notify('‚úÖ Enregistr√©')}
function deleteActivity(){if(!editingActivity)return;data.activities=data.activities.filter(a=>a.id!==editingActivity.id);save();updatePlanning();closeModal('activityModal');notify('üóëÔ∏è Supprim√©')}

// ==================== HOMEWORK SYSTEM ====================
function setMode(m){document.querySelectorAll('.mode-btn').forEach(b=>b.classList.toggle('active',b.dataset.mode===m));document.getElementById('parentMode').style.display=m==='parent'?'block':'none';document.getElementById('childMode').style.display=m==='child'?'block':'none'}

function newChat(){
    conversationHistory=[];
    currentLesson={summary:'',mindmap:null,qaCards:[]};
    quizQuestions=[];
    document.getElementById('lessonContent').innerHTML='';
    document.getElementById('quizContent').innerHTML='<div class="empty-state"><div class="empty-icon">üéÆ</div><div>G√©n√©rez des questions en mode Parent</div></div>';
    clearUpload();
    notify('üîÑ Nouvelle le√ßon');
}

function handleUpload(f){
    if(!f.type.startsWith('image/')&&f.type!=='application/pdf')return notify('‚ö†Ô∏è Format non support√©');
    uploadedFile=f;
    const r=new FileReader();
    r.onload=e=>{
        uploadedBase64=e.target.result;
        document.getElementById('uploadZone').style.display='none';
        document.getElementById('uploadPreview').style.display='block';
        document.getElementById('previewImg').src=f.type.startsWith('image/')?e.target.result:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><rect fill="%23e74c3c" width="50" height="50" rx="5"/><text x="25" y="30" text-anchor="middle" fill="white" font-size="12">PDF</text></svg>';
    };
    r.readAsDataURL(f);
}

function clearUpload(){
    uploadedFile=null;
    uploadedBase64=null;
    document.getElementById('uploadZone').style.display='block';
    document.getElementById('uploadPreview').style.display='none';
    document.getElementById('fileInput').value='';
}

async function sendParentMsg(){
    const input=document.getElementById('parentInput');
    const msg=input.value.trim();
    if(!msg&&!uploadedFile)return;
    input.value='';
    
    const c=currentChild||{name:'enfant',age:10,class:'CM2',interests:''};
    
    // Build user message content
    let userContent=[];
    if(uploadedBase64&&uploadedFile){
        const b=uploadedBase64.split(',')[1];
        userContent.push(uploadedFile.type.startsWith('image/')?
            {type:'image',source:{type:'base64',media_type:uploadedFile.type,data:b}}:
            {type:'document',source:{type:'base64',media_type:'application/pdf',data:b}});
    }
    userContent.push({type:'text',text:msg||'Analyse cette le√ßon.'});
    
    // Add to conversation history
    conversationHistory.push({role:'user',content:userContent});
    
    // Show loading
    document.getElementById('lessonContent').innerHTML='<div class="loading-container"><div class="loading-spinner"></div><div style="color:var(--sage)">ü§ñ Analyse de la le√ßon...</div></div>';
    
    const systemPrompt=`Tu es un assistant p√©dagogique pour aider ${c.name} (${c.age} ans, ${c.class}) √† r√©viser.
${c.interests?'Ses centres d\'int√©r√™t: '+c.interests+'. Utilise-les dans tes exemples!':''}

IMPORTANT: Ne JAMAIS utiliser de ** ou d'ast√©risques pour mettre en gras. Utilise un langage clair et simple.

Tu dois TOUJOURS r√©pondre avec ce format JSON exact:
{
  "summary": {
    "title": "Titre de la le√ßon",
    "keyPoints": ["Point cl√© 1", "Point cl√© 2", "Point cl√© 3"],
    "definitions": [{"term": "Mot", "definition": "Explication simple"}]
  },
  "mindmap": {
    "center": "Th√®me central",
    "branches": [
      {"icon": "üîµ", "title": "Branche 1", "items": ["√©l√©ment 1", "√©l√©ment 2"]},
      {"icon": "üü¢", "title": "Branche 2", "items": ["√©l√©ment 1", "√©l√©ment 2"]},
      {"icon": "üü†", "title": "Branche 3", "items": ["√©l√©ment 1", "√©l√©ment 2"]}
    ]
  },
  "quiz": [
    {
      "question": "Question 1 ?",
      "answer": "R√©ponse correcte compl√®te",
      "options": ["R√©ponse correcte", "Mauvaise r√©ponse 1", "Mauvaise r√©ponse 2", "Mauvaise r√©ponse 3"],
      "hint": "Un indice"
    }
  ]
}

R√®gles:
- 3-5 points cl√©s maximum
- 3-4 branches dans la carte mentale
- 5-6 questions de quiz
- Les options du quiz doivent √™tre PERTINENTES au sujet (pas de "Je ne sais pas")
- Adapte le vocabulaire au niveau ${c.class}
- R√©ponds UNIQUEMENT avec le JSON, rien d'autre`;

    try{
        const res=await fetch('/api/claude',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                system:systemPrompt,
                messages:conversationHistory
            })
        });
        
        if(res.ok){
            const r=await res.json();
            const reply=r.content[0].text;
            
            // Add assistant response to history
            conversationHistory.push({role:'assistant',content:reply});
            
            // Parse JSON response
            try{
                const jsonMatch=reply.match(/\{[\s\S]*\}/);
                if(jsonMatch){
                    const lesson=JSON.parse(jsonMatch[0]);
                    currentLesson=lesson;
                    renderLessonContent(lesson);
                }else{
                    // Fallback: display as text
                    renderFallbackContent(reply);
                }
            }catch(e){
                renderFallbackContent(reply);
            }
        }
        clearUpload();
    }catch(e){
        document.getElementById('lessonContent').innerHTML='<div class="alert-card danger"><div class="alert-icon">‚ùå</div><div class="alert-content"><div class="alert-title">Erreur</div><div class="alert-text">Impossible d\'analyser la le√ßon</div></div></div>';
    }
}

function renderLessonContent(lesson){
    let html='';
    
    // Summary section
    if(lesson.summary){
        html+=`<div class="lesson-section">
            <div class="lesson-section-header summary" onclick="toggleSection(this)">
                üìù R√©sum√©
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="lesson-section-content">
                <div class="summary-content">
                    ${lesson.summary.title?'<h3 style="color:var(--forest);margin-bottom:.8rem;font-size:1rem;">'+lesson.summary.title+'</h3>':''}
                    ${lesson.summary.keyPoints?lesson.summary.keyPoints.map(p=>'<div class="key-point">'+p+'</div>').join(''):''}
                    ${lesson.summary.definitions?lesson.summary.definitions.map(d=>'<div class="definition"><span class="definition-term">'+d.term+'</span>: '+d.definition+'</div>').join(''):''}
                </div>
            </div>
        </div>`;
    }
    
    // Mind map section
    if(lesson.mindmap){
        html+=`<div class="lesson-section">
            <div class="lesson-section-header mindmap" onclick="toggleSection(this)">
                üß† Carte mentale
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="lesson-section-content">
                <div class="mindmap-container">
                    <div class="mindmap-center">${lesson.mindmap.center}</div>
                    <div class="mindmap-branches">
                        ${lesson.mindmap.branches.map(b=>`
                            <div class="mindmap-branch">
                                <div class="mindmap-branch-icon">${b.icon}</div>
                                <div class="mindmap-branch-content">
                                    <div class="mindmap-branch-title">${b.title}</div>
                                    <ul class="mindmap-branch-items">
                                        ${b.items.map(i=>'<li>'+i+'</li>').join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    // Q&A section
    if(lesson.quiz&&lesson.quiz.length>0){
        quizQuestions=lesson.quiz.map(q=>({
            q:q.question,
            a:q.answer,
            correctAnswer:q.options[0],
            options:[...q.options].sort(()=>Math.random()-.5),
            hint:q.hint
        }));
        
        html+=`<div class="lesson-section">
            <div class="lesson-section-header qa" onclick="toggleSection(this)">
                ‚ùì Questions/R√©ponses (${lesson.quiz.length})
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="lesson-section-content">
                <div class="qa-cards-container">
                    ${lesson.quiz.map((q,i)=>`
                        <div class="qa-card">
                            <div class="qa-question" onclick="toggleQA(this)">
                                <span>${i+1}. ${q.question}</span>
                                <span class="toggle">‚ñº</span>
                            </div>
                            <div class="qa-answer">
                                <div class="qa-answer-content">
                                    <div class="qa-answer-text">‚úÖ ${q.answer}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>`;
    }
    
    // Action buttons
    html+=`<div class="lesson-actions">
        <button class="lesson-action-btn quiz" onclick="startQuiz()">üéÆ Lancer le Quiz</button>
        <button class="lesson-action-btn continue" onclick="continueConversation()">üí¨ Poser une question</button>
    </div>`;
    
    document.getElementById('lessonContent').innerHTML=html;
}

function renderFallbackContent(text){
    // Clean asterisks and format nicely
    const cleaned=text.replace(/\*\*/g,'').replace(/\*/g,'');
    document.getElementById('lessonContent').innerHTML=`
        <div class="card">
            <div class="card-title">üìö R√©sum√©</div>
            <div style="font-size:.9rem;line-height:1.6">${cleaned.replace(/\n/g,'<br>')}</div>
        </div>
    `;
}

function toggleSection(el){
    el.classList.toggle('collapsed');
    el.nextElementSibling.classList.toggle('hidden');
}

function toggleQA(el){
    el.classList.toggle('open');
    el.nextElementSibling.classList.toggle('show');
}

function continueConversation(){
    document.getElementById('parentInput').focus();
    notify('üí¨ Posez votre question !');
}

// ==================== QUIZ ====================
function startQuiz(){
    if(quizQuestions.length===0)return notify('‚ö†Ô∏è G√©n√©rez d\'abord une le√ßon');
    setMode('child');
    quizIndex=0;
    quizScore=0;
    quizAnswered=false;
    showQuizQ();
}

function showQuizQ(){
    if(quizIndex>=quizQuestions.length){showQuizResults();return}
    const q=quizQuestions[quizIndex];
    quizAnswered=false;
    document.getElementById('quizProgress').innerHTML=quizQuestions.map((_,i)=>'<div class="progress-dot '+(i<quizIndex?'done':i===quizIndex?'current':'')+'"></div>').join('');
    document.getElementById('quizScoreDisplay').textContent='Score: '+quizScore+'/'+quizIndex;
    
    document.getElementById('quizContent').innerHTML=`
        <div class="quiz-card">
            <div class="quiz-card-header" id="quizHeader">
                <div class="quiz-number">Question ${quizIndex+1}/${quizQuestions.length}</div>
                <div class="quiz-question">${q.q}</div>
            </div>
            <div class="quiz-card-body">
                <div class="quiz-options" id="quizOptions">
                    ${q.options.map(o=>'<div class="quiz-option" data-value="'+o+'" onclick="selectQuizOpt(this)">'+o+'</div>').join('')}
                </div>
                <div id="quizHint"></div>
                <div id="quizExpl"></div>
            </div>
        </div>
        <div class="quiz-actions">
            <button class="quiz-btn hint" onclick="showHint()">üí°</button>
            <button class="quiz-btn check" onclick="checkQuizAns()">‚úì</button>
            <button class="quiz-btn next" onclick="nextQ()">‚Üí</button>
        </div>
    `;
}

function selectQuizOpt(el){
    if(quizAnswered)return;
    document.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));
    el.classList.add('selected');
}

function checkQuizAns(){
    if(quizAnswered)return;
    const s=document.querySelector('.quiz-option.selected');
    if(!s)return notify('Choisis une r√©ponse !');
    quizAnswered=true;
    const q=quizQuestions[quizIndex];
    const sv=s.dataset.value;
    const cv=q.correctAnswer;
    const ic=sv===cv;
    
    document.querySelectorAll('.quiz-option').forEach(o=>{
        o.classList.add('disabled');
        if(o.dataset.value===cv)o.classList.add('correct');
        else if(o===s&&!ic)o.classList.add('wrong');
    });
    
    const h=document.getElementById('quizHeader');
    if(ic){
        quizScore++;
        h.classList.add('correct');
        notify('üéâ Bravo !');
    }else{
        h.classList.add('wrong');
        document.getElementById('quizExpl').innerHTML='<div class="quiz-explanation">üìñ '+q.a+'</div>';
    }
    document.getElementById('quizScoreDisplay').textContent='Score: '+quizScore+'/'+(quizIndex+1);
}

function nextQ(){quizIndex++;showQuizQ()}

function showHint(){
    const q=quizQuestions[quizIndex];
    document.getElementById('quizHint').innerHTML='<div class="quiz-hint">üí° '+q.hint+'</div>';
}

function showQuizResults(){
    const p=Math.round((quizScore/quizQuestions.length)*100);
    const e=p>=80?'üèÜ':p>=60?'üëç':'üí™';
    let txt=p>=80?'Excellent !':p>=60?'Bien jou√© !':'Continue !';
    if(currentChild){
        if(p>=80)txt='Bravo '+currentChild.name+' !';
        else if(p<60)txt='Courage '+currentChild.name+' !';
    }
    document.getElementById('quizContent').innerHTML=`
        <div class="quiz-results">
            <div style="font-size:3rem">${e}</div>
            <div class="quiz-results-score">${quizScore}/${quizQuestions.length}</div>
            <div class="quiz-results-text">${txt}</div>
            <button class="quiz-results-btn" onclick="startQuiz()">üîÑ Recommencer</button>
            <button class="quiz-results-btn" onclick="setMode('parent')">üë®‚Äçüë©‚Äçüëß Retour</button>
        </div>
    `;
    document.getElementById('quizProgress').innerHTML='';
}

// ==================== BUDGET ====================
async function importFile(f){document.getElementById('importZone').style.display='none';document.getElementById('loadingContainer').style.display='block';const r=new FileReader();r.onload=async e=>{const b=e.target.result.split(',')[1];try{const rs=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:'Extrais transactions. JSON: {"transactions":[{"date":"DD/MM/YYYY","description":"Court","amount":123.45,"category":"salary"}]}',messages:[{role:'user',content:[{type:'document',source:{type:'base64',media_type:'application/pdf',data:b}},{type:'text',text:'JSON uniquement.'}]}]})});document.getElementById('loadingContainer').style.display='none';if(rs.ok){const j=await rs.json(),m=j.content[0].text.match(/\{[\s\S]*\}/);if(m){const p=JSON.parse(m[0]);if(p.transactions?.length){data.transactions=p.transactions.map((t,i)=>({id:Date.now()+i,...t}));save();updateAll();generateNotifs();notify('‚úÖ '+data.transactions.length+' transactions');return}}}showImportErr()}catch(e){showImportErr()}};r.readAsDataURL(f)}
function showImportErr(){document.getElementById('loadingContainer').style.display='none';document.getElementById('importZone').style.display='block';notify('‚ùå Erreur')}
function resetData(){if(confirm('Effacer?')){data.transactions=[];save();updateAll()}}
function resetAll(){if(confirm('Tout r√©initialiser?')){localStorage.removeItem('familyflow_v8');location.reload()}}
function updateDashboard(){const i=data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),e=data.transactions.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0),b=i-e;document.getElementById('totalIncome').textContent='+'+Math.round(i)+'‚Ç¨';document.getElementById('totalExpenses').textContent='-'+Math.round(e)+'‚Ç¨';document.getElementById('totalBalance').textContent=(b>=0?'+':'')+Math.round(b)+'‚Ç¨';document.getElementById('totalBalance').style.color=b>=0?'var(--green)':'var(--red)';document.getElementById('savingsRate').textContent=i>0?Math.round((b/i)*100)+'%':'0%';const bc={};data.transactions.filter(t=>t.amount<0).forEach(t=>{bc[t.category||'other']=(bc[t.category||'other']||0)+Math.abs(t.amount)});const sr=Object.entries(bc).sort((a,b)=>b[1]-a[1]).slice(0,5),mx=sr[0]?.[1]||1;document.getElementById('categoryBreakdown').innerHTML=sr.map(([c,a])=>{const ct=CATEGORIES[c]||CATEGORIES.other;return'<div class="category-item"><div class="category-emoji">'+ct.emoji+'</div><div class="category-info"><div class="category-name">'+ct.name+'</div><div class="category-bar"><div class="category-fill" style="width:'+(a/mx)*100+'%;background:'+ct.color+'"></div></div></div><div class="category-amount">'+Math.round(a)+'‚Ç¨</div></div>'}).join('');const rc=[...data.transactions].sort((a,b)=>(b.date||'').localeCompare(a.date||'')).slice(0,5);document.getElementById('recentTransactions').innerHTML=rc.map(t=>{const c=CATEGORIES[t.category]||CATEGORIES.other;return'<div class="transaction-item"><div class="transaction-emoji">'+c.emoji+'</div><div class="transaction-info"><div class="transaction-desc">'+t.description+'</div><div class="transaction-date">'+t.date+'</div></div><div class="transaction-amount '+(t.amount>0?'income':'expense')+'">'+(t.amount>0?'+':'')+t.amount.toFixed(0)+'‚Ç¨</div></div>'}).join('')}
function updateOptimize(){const e=data.transactions.filter(t=>t.amount<0),i=data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),te=e.reduce((s,t)=>s+Math.abs(t.amount),0),bc={};e.forEach(t=>{bc[t.category||'other']=(bc[t.category||'other']||0)+Math.abs(t.amount)});const sr=i>0?(i-te)/i:0,sc=Math.max(0,Math.min(100,Math.round(50+sr*40))),scl=sc>=70?'good':sc>=40?'warning':'bad';let al=[];if((bc.subscriptions||0)>80)al.push({type:'warning',icon:'üì±',title:Math.round(bc.subscriptions)+'‚Ç¨ abonnements',text:'V√©rifiez leur utilit√©'});if(sr<.1)al.push({type:'danger',icon:'üí∏',title:'√âpargne faible',text:Math.round(sr*100)+'%'});else if(sr>=.2)al.push({type:'success',icon:'üéâ',title:'Bravo!',text:Math.round(sr*100)+'% √©pargne'});if(data.children.length>0)al.push({type:'tip',icon:'üí°',title:'Astuce famille',text:'Ouvrez un livret jeune pour '+data.children.slice(0,2).map(c=>c.name).join(' et ')});document.getElementById('optimizeContent').innerHTML='<div class="card"><div class="card-title">üìà Score</div><div class="score-circle '+scl+'"><div class="score-value">'+sc+'</div><div class="score-label">/100</div></div></div>'+al.map(a=>'<div class="alert-card '+a.type+'"><div class="alert-icon">'+a.icon+'</div><div class="alert-content"><div class="alert-title">'+a.title+'</div><div class="alert-text">'+a.text+'</div></div></div>').join('')}
async function sendBudgetMsg(){const i=document.getElementById('budgetInput'),m=i.value.trim();if(!m)return;addMsg('budgetChat',m,'user');i.value='';const l=addLoading('budgetChat'),fc=data.children.length>0?'Famille: '+data.children.map(c=>c.name+' ('+c.age+' ans)').join(', ')+'.':'';try{const r=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:'Assistant budget familial. '+fc+' '+data.transactions.length+' transactions. Conseils personnalis√©s. Fran√ßais avec emojis. Ne jamais utiliser ** ou ast√©risques.',messages:[{role:'user',content:m}]})});l.remove();if(r.ok){const j=await r.json();const reply=j.content[0].text.replace(/\*\*/g,'').replace(/\*/g,'');addMsg('budgetChat',reply,'assistant')}}catch(e){l.remove();addMsg('budgetChat','‚ùå Erreur','assistant')}}
function askBudget(q){document.getElementById('budgetInput').value=q;sendBudgetMsg()}
function updateChildrenList(){document.getElementById('childrenList').innerHTML=data.children.map(c=>'<div class="child-card"><div class="child-avatar-lg">'+c.avatar+'</div><div class="child-info"><div class="child-name">'+c.name+'</div><div class="child-details">'+c.age+' ans ‚Ä¢ '+c.class+(c.interests?' ‚Ä¢ '+c.interests:'')+'</div></div><button class="child-edit" onclick="editChildProfile('+c.id+')">‚úèÔ∏è</button></div>').join('')||'<div style="color:var(--sage);padding:.5rem">Aucun enfant</div>'}
function openChildModal(id=null){editingChild=id?data.children.find(c=>c.id===id):null;document.getElementById('childModalTitle').textContent=editingChild?'‚úèÔ∏è Modifier':'‚ûï Ajouter';document.getElementById('deleteChildBtn').style.display=editingChild?'block':'none';document.getElementById('childNameInput').value=editingChild?.name||'';document.getElementById('childAgeInput').value=editingChild?.age||'';document.getElementById('childClassInput').value=editingChild?.class||'4e';document.getElementById('childInterestsInput').value=editingChild?.interests||'';document.querySelectorAll('.avatar-option').forEach(a=>a.classList.toggle('selected',a.dataset.avatar===(editingChild?.avatar||'üë¶')));openModal('childModal')}
function editChildProfile(id){openChildModal(id)}
function saveChild(){const n=document.getElementById('childNameInput').value.trim(),a=parseInt(document.getElementById('childAgeInput').value);if(!n||!a)return notify('‚ö†Ô∏è Pr√©nom et √¢ge requis');const c={id:editingChild?.id||Date.now(),name:n,age:a,class:document.getElementById('childClassInput').value,interests:document.getElementById('childInterestsInput').value.trim(),avatar:document.querySelector('.avatar-option.selected')?.dataset.avatar||'üë¶'};if(editingChild){const i=data.children.findIndex(x=>x.id===editingChild.id);if(i>=0)data.children[i]=c}else data.children.push(c);if(!currentChild)currentChild=c;save();updateChildrenList();updateChildSelector();closeModal('childModal');generateNotifs();notify('‚úÖ Enregistr√©')}
function deleteChild(){if(!editingChild)return;data.children=data.children.filter(c=>c.id!==editingChild.id);if(currentChild?.id===editingChild.id)currentChild=data.children[0]||null;save();updateChildrenList();updateChildSelector();closeModal('childModal');notify('üóëÔ∏è Supprim√©')}
function addMsg(id,t,r){const e=document.createElement('div');e.className='message '+r;e.innerHTML=t.replace(/\n/g,'<br>');const c=document.getElementById(id);c.appendChild(e);c.scrollTop=99999}
function addLoading(id){const e=document.createElement('div');e.className='loading-dots';e.innerHTML='<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';document.getElementById(id).appendChild(e);return e}
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function notify(m){const n=document.createElement('div');n.className='notification';n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.remove(),2500)}
init();
    </script>
</body>
</html>
