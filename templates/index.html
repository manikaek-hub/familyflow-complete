const q = quizQuestions[quizIndex];
    document.getElementById('quizHint').innerHTML = `
        <div class="quiz-hint">üí° ${q.hint || 'R√©fl√©chis bien...'}</div>
    `;
}

function showQuizResults() {
    const percent = Math.round((quizScore / quizQuestions.length) * 100);
    const emoji = percent >= 80 ? 'üèÜ' : percent >= 60 ? 'üëç' : 'üí™';
    let text = percent >= 80 ? 'Excellent !' : percent >= 60 ? 'Bien jou√© !' : 'Continue !';
    
    if (currentChild) {
        if (percent >= 80) text = `Bravo ${currentChild.name} !`;
        else if (percent < 60) text = `Courage ${currentChild.name} !`;
    }
    
    // Update lesson score if exists
    if (currentLesson) {
        const idx = data.lessons.findIndex(l => l.id === currentLesson.id);
        if (idx >= 0) {
            data.lessons[idx].lastQuizScore = percent;
            data.lessons[idx].lastQuizDate = new Date().toISOString();
            save();
        }
    }
    
    document.getElementById('quizContent').innerHTML = `
        <div class="quiz-results">
            <div style="font-size:3rem">${emoji}</div>
            <div class="quiz-results-score">${quizScore}/${quizQuestions.length}</div>
            <div class="quiz-results-text">${text}</div>
            <button class="quiz-results-btn" onclick="restartQuiz()">üîÑ Recommencer</button>
            <button class="quiz-results-btn" onclick="switchView('revision')">üìÅ Mes le√ßons</button>
            <button class="quiz-results-btn" onclick="switchView('dashboard')">üè† Accueil</button>
        </div>
    `;
    document.getElementById('quizProgress').innerHTML = '';
}

function restartQuiz() {
    quizIndex = 0;
    quizScore = 0;
    quizAnswered = false;
    quizQuestions.forEach(q => {
        q.options = shuffleArray([...q.options]);
    });
    showQuizQuestion();
}

// ============== REVISION ==============
function updateRevision() {
    // Child folders
    document.getElementById('childFolders').innerHTML = data.children.map(c => {
        const count = data.lessons.filter(l => l.childId === c.id).length;
        return `
            <div class="child-folder ${selectedFolder?.id === c.id ? 'active' : ''}" onclick="selectFolder(${c.id})">
                <div class="child-folder-avatar">${c.avatar}</div>
                <div class="child-folder-name">${c.name}</div>
                <div class="child-folder-count">${count} le√ßon${count > 1 ? 's' : ''}</div>
            </div>
        `;
    }).join('');
    
    updateSavedLessons();
}

function selectFolder(id) {
    selectedFolder = data.children.find(c => c.id === id);
    updateRevision();
}

function updateSavedLessons() {
    const container = document.getElementById('savedLessonsList');
    
    if (!selectedFolder) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìÅ</div>
                <div>S√©lectionnez un enfant</div>
            </div>
        `;
        return;
    }
    
    const lessons = data.lessons
        .filter(l => l.childId === selectedFolder.id)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (lessons.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìö</div>
                <div>Aucune le√ßon pour ${selectedFolder.name}</div>
                <button class="lesson-action-btn quiz" style="margin-top:.8rem;max-width:180px" onclick="switchView('homework')">
                    ‚úèÔ∏è Ajouter une le√ßon
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = lessons.map(l => {
        const subj = SUBJECTS[l.subject] || SUBJECTS.general;
        const date = new Date(l.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        return `
            <div class="lesson-folder-card ${l.subject}" onclick="openSavedLesson(${l.id})">
                <div class="lesson-folder-header">
                    <div>
                        <span class="lesson-folder-subject">${subj.emoji} ${subj.name}</span>
                        <div class="lesson-folder-title">${l.title}</div>
                    </div>
                    <div class="lesson-folder-date">${date}</div>
                </div>
                <div class="lesson-folder-stats">
                    <span>üß† ${l.mindmap?.branches?.length || 0} branches</span>
                    <span>‚ùì ${l.quiz?.length || 0} questions</span>
                    ${l.lastQuizScore !== undefined ? `<span>üìä ${l.lastQuizScore}%</span>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function openSavedLesson(id) {
    viewingLesson = data.lessons.find(l => l.id === id);
    if (!viewingLesson) return;
    
    const subj = SUBJECTS[viewingLesson.subject] || SUBJECTS.general;
    document.getElementById('lessonModalTitle').textContent = `${subj.emoji} ${viewingLesson.title}`;
    
    let html = '';
    
    // Summary
    if (viewingLesson.summary) {
        html += '<div style="margin-bottom:1rem">';
        html += '<div style="font-weight:600;color:var(--forest);margin-bottom:.5rem">üìù Points cl√©s</div>';
        html += viewingLesson.summary.keyPoints?.map(p => `<div class="key-point">${p}</div>`).join('') || '';
        html += '</div>';
    }
    
    // Mindmap
    if (viewingLesson.mindmap) {
        html += '<div style="margin-bottom:1rem">';
        html += '<div style="font-weight:600;color:var(--purple);margin-bottom:.5rem">üß† Carte mentale</div>';
        html += `<div class="mindmap-center" style="font-size:.8rem;padding:.5rem">${viewingLesson.mindmap.center}</div>`;
        html += viewingLesson.mindmap.branches?.map(b => `
            <div style="display:flex;gap:.4rem;font-size:.8rem;margin:.3rem 0">
                <span>${b.icon}</span>
                <strong>${b.title}:</strong>
                <span style="color:var(--sage)">${b.items.join(', ')}</span>
            </div>
        `).join('') || '';
        html += '</div>';
    }
    
    // Stats
    if (viewingLesson.lastQuizScore !== undefined) {
        html += `<div style="text-align:center;padding:.5rem;background:var(--cream);border-radius:8px">
            <div style="font-size:.8rem;color:var(--sage)">Dernier score</div>
            <div style="font-size:1.5rem;font-weight:600;color:var(--forest)">${viewingLesson.lastQuizScore}%</div>
        </div>`;
    }
    
    document.getElementById('lessonModalContent').innerHTML = html;
    openModal('lessonModal');
}

function startSavedLessonQuiz() {
    if (!viewingLesson || !viewingLesson.quiz) return notify('‚ö†Ô∏è Pas de quiz disponible');
    closeModal('lessonModal');
    
    currentLesson = viewingLesson;
    quizQuestions = viewingLesson.quiz.map(q => ({
        q: q.question,
        a: q.answer,
        correctAnswer: q.options[0],
        options: shuffleArray([...q.options]),
        hint: q.hint
    }));
    
    quizIndex = 0;
    quizScore = 0;
    quizAnswered = false;
    
    switchView('quiz');
    showQuizQuestion();
}

// ============== CHILDREN ==============
function updateChildrenList() {
    document.getElementById('childrenList').innerHTML = data.children.map(c => {
        const lessonCount = data.lessons.filter(l => l.childId === c.id).length;
        return `
            <div class="child-card">
                <div class="child-avatar-lg">${c.avatar}</div>
                <div class="child-info">
                    <div class="child-name">${c.name}</div>
                    <div class="child-details">
                        ${c.age} ans ‚Ä¢ ${c.class} ‚Ä¢ ${lessonCount} le√ßon${lessonCount > 1 ? 's' : ''}
                        ${c.interests ? ' ‚Ä¢ ' + c.interests : ''}
                    </div>
                </div>
                <button class="child-edit" onclick="editChild(${c.id})">‚úèÔ∏è</button>
            </div>
        `;
    }).join('') || '<div style="color:var(--sage);padding:.5rem">Aucun enfant</div>';
}

function openChildModal(id = null) {
    editingChild = id ? data.children.find(c => c.id === id) : null;
    document.getElementById('childModalTitle').textContent = editingChild ? '‚úèÔ∏è Modifier' : '‚ûï Ajouter un enfant';
    document.getElementById('deleteChildBtn').style.display = editingChild ? 'block' : 'none';
    document.getElementById('childNameInput').value = editingChild?.name || '';
    document.getElementById('childAgeInput').value = editingChild?.age || '';
    document.getElementById('childClassInput').value = editingChild?.class || '4e';
    document.getElementById('childInterestsInput').value = editingChild?.interests || '';
    document.querySelectorAll('.avatar-option').forEach(a => 
        a.classList.toggle('selected', a.dataset.avatar === (editingChild?.avatar || 'üë¶'))
    );
    openModal('childModal');
}

function editChild(id) { openChildModal(id); }

function saveChild() {
    const name = document.getElementById('childNameInput').value.trim();
    const age = parseInt(document.getElementById('childAgeInput').value);
    if (!name || !age) return notify('‚ö†Ô∏è Pr√©nom et √¢ge requis');
    
    const child = {
        id: editingChild?.id || Date.now(),
        name,
        age,
        class: document.getElementById('childClassInput').value,
        interests: document.getElementById('childInterestsInput').value.trim(),
        avatar: document.querySelector('.avatar-option.selected')?.dataset.avatar || 'üë¶'
    };
    
    if (editingChild) {
        const idx = data.children.findIndex(c => c.id === editingChild.id);
        if (idx >= 0) data.children[idx] = child;
    } else {
        data.children.push(child);
    }
    
    if (!currentChild) currentChild = child;
    if (!selectedFolder) selectedFolder = child;
    
    save();
    updateAll();
    closeModal('childModal');
    notify('‚úÖ Enregistr√©');
}

function deleteChild() {
    if (!editingChild) return;
    if (!confirm(`Supprimer ${editingChild.name} et toutes ses le√ßons ?`)) return;
    
    data.children = data.children.filter(c => c.id !== editingChild.id);
    data.lessons = data.lessons.filter(l => l.childId !== editingChild.id);
    data.activities = data.activities.filter(a => a.childId !== editingChild.id);
    
    if (currentChild?.id === editingChild.id) currentChild = data.children[0] || null;
    if (selectedFolder?.id === editingChild.id) selectedFolder = data.children[0] || null;
    
    save();
    updateAll();
    closeModal('childModal');
    notify('üóëÔ∏è Supprim√©');
}

// ============== UTILS ==============
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function notify(msg) {
    const n = document.createElement('div');
    n.className = 'notification';
    n.textContent = msg;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 2500);
}

function resetAll() {
    if (confirm('Tout r√©initialiser ? Cette action est irr√©versible.')) {
        localStorage.removeItem('familyflow_v10');
        location.reload();
    }
}

// ============== START ==============
init();
</script>
</body>
</html>
