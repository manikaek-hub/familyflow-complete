<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow v9 ‚ú®</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--cream:#FAF7F2;--sand:#E8DCC4;--terracotta:#C9856B;--forest:#5F7161;--sage:#8B9D83;--midnight:#2C3333;--white:#FFF;--red:#E74C3C;--green:#27AE60;--blue:#3498DB;--purple:#9B59B6;--orange:#E67E22;--yellow:#F1C40F}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:linear-gradient(135deg,var(--cream),#F0EDE5);color:var(--midnight);min-height:100vh;padding-bottom:75px}
        header{background:linear-gradient(135deg,var(--forest),var(--sage));padding:.8rem 1rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.15)}
        .header-left{display:flex;align-items:center;gap:.8rem}
        .back-btn{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.2);color:#fff;font-size:1rem;cursor:pointer;display:none}
        .back-btn.visible{display:flex;align-items:center;justify-content:center}
        .header-title{font-family:'Playfair Display',serif;font-size:1.4rem;color:#fff;font-weight:600}
        .header-profile{width:36px;height:36px;border-radius:50%;background:var(--sand);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;border:2px solid #fff}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:.4rem 0;box-shadow:0 -2px 15px rgba(0,0,0,.1);z-index:100}
        .nav-item{display:flex;flex-direction:column;align-items:center;padding:.3rem;border:none;background:none;cursor:pointer;color:var(--sage);font-size:.5rem}
        .nav-item.active{color:var(--forest)}
        .nav-item .nav-icon{font-size:1.1rem}
        .container{max-width:600px;margin:0 auto;padding:1rem}
        .view{display:none}.view.active{display:block;animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .card{background:#fff;border-radius:15px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 15px rgba(0,0,0,.08)}
        .card-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--forest);margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
        .agent-badge{display:inline-flex;align-items:center;gap:.2rem;padding:.2rem .5rem;border-radius:15px;font-size:.6rem;font-weight:500}
        .agent-badge.homework{background:linear-gradient(135deg,var(--blue),#5DADE2);color:#fff}
        .agent-badge.planning{background:linear-gradient(135deg,var(--orange),var(--yellow));color:#fff}
        .agent-badge.profile{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff}
        .agent-badge.revision{background:linear-gradient(135deg,var(--green),var(--sage));color:#fff}
        .child-folders{display:flex;gap:.5rem;overflow-x:auto;padding-bottom:.5rem;margin-bottom:1rem}
        .child-folder{display:flex;flex-direction:column;align-items:center;padding:.5rem .7rem;background:#fff;border-radius:12px;cursor:pointer;min-width:65px;box-shadow:0 2px 8px rgba(0,0,0,.06);border:2px solid transparent}
        .child-folder.active{border-color:var(--forest);background:var(--cream)}
        .child-folder-avatar{font-size:1.4rem}
        .child-folder-name{font-size:.7rem;font-weight:500}
        .child-folder-count{font-size:.55rem;color:var(--sage)}
        .lesson-card{background:#fff;border-radius:12px;padding:.7rem;margin-bottom:.5rem;box-shadow:0 2px 10px rgba(0,0,0,.06);cursor:pointer;border-left:4px solid var(--blue)}
        .lesson-card.math{border-left-color:var(--purple)}
        .lesson-card.french{border-left-color:var(--terracotta)}
        .lesson-card.history{border-left-color:var(--orange)}
        .lesson-card.science{border-left-color:var(--green)}
        .lesson-header{display:flex;justify-content:space-between;align-items:flex-start}
        .lesson-title{font-weight:600;font-size:.85rem}
        .lesson-date{font-size:.6rem;color:var(--sage)}
        .lesson-subject{display:inline-block;padding:.1rem .4rem;border-radius:10px;font-size:.55rem;background:var(--cream);color:var(--forest);margin-bottom:.2rem}
        .lesson-stats{display:flex;gap:.6rem;font-size:.65rem;color:var(--sage)}
        .revision-plan{background:linear-gradient(135deg,var(--forest),var(--sage));border-radius:15px;padding:1rem;color:#fff;margin-bottom:1rem}
        .revision-plan-title{font-family:'Playfair Display',serif;font-size:.95rem;margin-bottom:.6rem}
        .revision-item{background:rgba(255,255,255,.15);border-radius:8px;padding:.5rem;margin-bottom:.4rem;display:flex;align-items:center;gap:.5rem}
        .revision-time{font-size:.7rem;opacity:.8;min-width:40px}
        .revision-content{flex:1}
        .revision-content-title{font-size:.8rem;font-weight:500}
        .revision-content-type{font-size:.6rem;opacity:.8}
        .revision-action{width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,.2);border:none;color:#fff;cursor:pointer}
        .smart-notif{background:linear-gradient(135deg,var(--terracotta),#B8754A);border-radius:12px;padding:.7rem;margin-bottom:.8rem;color:#fff;display:flex;align-items:center;gap:.6rem;cursor:pointer}
        .smart-notif-icon{font-size:1.3rem}
        .smart-notif-content{flex:1}
        .smart-notif-title{font-weight:600;font-size:.8rem}
        .smart-notif-text{font-size:.7rem;opacity:.9}
        .smart-notif-close{background:none;border:none;color:#fff;cursor:pointer;opacity:.7}
        .homework-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
        .child-selector{position:relative;display:flex;align-items:center;gap:.3rem;padding:.4rem .6rem;background:#fff;border-radius:20px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:160px}
        .child-selector .avatar{font-size:1.1rem}
        .child-selector .name{font-weight:500;font-size:.8rem;flex:1}
        .child-selector .arrow{font-size:.5rem;color:var(--sage)}
        .child-dropdown{position:absolute;top:calc(100% + 5px);left:0;right:0;background:#fff;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.15);z-index:50;overflow:hidden;max-height:0;opacity:0;transition:all .3s}
        .child-dropdown.show{max-height:200px;opacity:1}
        .child-dropdown-item{padding:.5rem .6rem;cursor:pointer;font-size:.8rem}
        .child-dropdown-item:hover{background:var(--cream)}
        .child-dropdown-item.active{background:var(--sand)}
        .subject-chips{display:flex;gap:.3rem;margin-bottom:.6rem;flex-wrap:wrap}
        .subject-chip{padding:.3rem .5rem;border-radius:15px;border:2px solid var(--sand);background:#fff;font-size:.7rem;cursor:pointer}
        .subject-chip.active{border-color:var(--forest);background:var(--cream)}
        .upload-zone{border:2px dashed var(--sand);border-radius:10px;padding:.6rem;text-align:center;cursor:pointer;font-size:.75rem;color:var(--sage);margin-bottom:.4rem}
        .upload-preview{position:relative;padding:.4rem;background:var(--cream);border-radius:8px;text-align:center;margin-bottom:.4rem}
        .upload-preview img{max-width:100%;max-height:60px;border-radius:4px}
        .remove-upload{position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;border:none;background:var(--red);color:#fff;cursor:pointer;font-size:.5rem}
        .chat-input-container{display:flex;gap:.3rem;padding:.4rem;background:var(--cream);border-radius:8px}
        .chat-input{flex:1;padding:.4rem;border:none;border-radius:6px;font-family:'Outfit',sans-serif;font-size:.8rem}
        .chat-input:focus{outline:none}
        .chat-send{padding:.4rem .6rem;border:none;border-radius:6px;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;cursor:pointer}
        .lesson-section{background:#fff;border-radius:12px;margin-bottom:.8rem;overflow:hidden;box-shadow:0 3px 12px rgba(0,0,0,.08)}
        .lesson-section-header{padding:.6rem .8rem;font-weight:600;font-size:.85rem;display:flex;align-items:center;gap:.4rem;cursor:pointer}
        .lesson-section-header.summary{background:linear-gradient(135deg,var(--blue),#5DADE2);color:#fff}
        .lesson-section-header.mindmap{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff}
        .lesson-section-header.qa{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .lesson-section-header .toggle-icon{margin-left:auto}
        .lesson-section-content{padding:.8rem}
        .lesson-section-content.hidden{display:none}
        .key-point{background:rgba(52,152,219,.1);border-left:3px solid var(--blue);padding:.4rem .6rem;margin:.3rem 0;border-radius:0 6px 6px 0;font-size:.8rem}
        .definition{background:var(--cream);padding:.4rem;border-radius:6px;margin:.3rem 0;font-size:.8rem}
        .definition-term{font-weight:600;color:var(--forest)}
        .mindmap-center{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff;padding:.5rem .8rem;border-radius:20px;text-align:center;font-weight:600;font-size:.85rem;margin:0 auto .8rem;max-width:180px}
        .mindmap-branch{display:flex;align-items:flex-start;gap:.4rem;margin-bottom:.5rem}
        .mindmap-branch-icon{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;background:var(--cream)}
        .mindmap-branch-content{flex:1;background:var(--cream);padding:.4rem .6rem;border-radius:8px}
        .mindmap-branch-title{font-weight:600;font-size:.8rem;color:var(--forest)}
        .mindmap-branch-items{font-size:.75rem}
        .mindmap-branch-items li{margin-left:.8rem}
        .qa-card{background:#fff;border-radius:10px;margin-bottom:.4rem;overflow:hidden;border:1px solid var(--sand)}
        .qa-question{padding:.6rem;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;font-size:.8rem;cursor:pointer;display:flex;justify-content:space-between}
        .qa-question.open .toggle{transform:rotate(180deg)}
        .qa-answer{max-height:0;overflow:hidden;transition:all .3s;background:var(--cream)}
        .qa-answer.show{max-height:300px}
        .qa-answer-content{padding:.6rem;font-size:.8rem}
        .lesson-actions{display:flex;gap:.4rem;flex-wrap:wrap}
        .lesson-action-btn{flex:1;min-width:90px;padding:.5rem;border:none;border-radius:8px;font-size:.75rem;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.3rem}
        .lesson-action-btn.save{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff}
        .lesson-action-btn.quiz{background:linear-gradient(135deg,var(--terracotta),#D98B70);color:#fff}
        .lesson-action-btn.plan{background:linear-gradient(135deg,var(--green),var(--sage));color:#fff}
        .quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
        .quiz-progress{display:flex;gap:.2rem}
        .progress-dot{width:8px;height:8px;border-radius:50%;background:var(--sand)}
        .progress-dot.done{background:var(--green)}
        .progress-dot.current{background:var(--blue);transform:scale(1.2)}
        .quiz-score{font-weight:600;font-size:.85rem;color:var(--forest)}
        .quiz-card{background:#fff;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,.1);overflow:hidden}
        .quiz-card-header{padding:1rem;text-align:center;background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .quiz-card-header.correct{background:linear-gradient(135deg,var(--green),#2ECC71)}
        .quiz-card-header.wrong{background:linear-gradient(135deg,var(--red),#C0392B)}
        .quiz-number{font-size:.7rem;opacity:.9}
        .quiz-question-text{font-size:.95rem;font-weight:600;margin-top:.3rem}
        .quiz-card-body{padding:.8rem}
        .quiz-option{padding:.6rem;border:2px solid var(--sand);border-radius:10px;margin-bottom:.4rem;cursor:pointer;font-size:.85rem}
        .quiz-option:hover{border-color:var(--blue)}
        .quiz-option.selected{border-color:var(--blue);background:rgba(52,152,219,.1)}
        .quiz-option.correct{border-color:var(--green);background:rgba(39,174,96,.1)}
        .quiz-option.wrong{border-color:var(--red);background:rgba(231,76,60,.1)}
        .quiz-option.disabled{pointer-events:none;opacity:.7}
        .quiz-actions{display:flex;justify-content:center;gap:.8rem;margin-top:.8rem}
        .quiz-btn{width:45px;height:45px;border-radius:50%;border:none;font-size:1.1rem;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.15)}
        .quiz-btn.hint{background:linear-gradient(135deg,var(--orange),var(--yellow));color:#fff}
        .quiz-btn.check{background:linear-gradient(135deg,var(--green),#2ECC71);color:#fff}
        .quiz-btn.next{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .quiz-hint{text-align:center;padding:.4rem;background:#FFF3E0;border-radius:8px;margin-top:.6rem;font-size:.8rem;color:var(--orange)}
        .quiz-explanation{padding:.5rem;background:var(--cream);border-radius:8px;margin-top:.6rem;font-size:.8rem}
        .quiz-results{text-align:center;padding:1.5rem}
        .quiz-results-score{font-size:2.5rem;font-weight:700;color:var(--forest)}
        .quiz-results-text{color:var(--sage);margin:.4rem 0 .8rem}
        .quiz-results-btn{padding:.6rem 1rem;border:none;border-radius:20px;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;font-weight:500;cursor:pointer;margin:.2rem;font-size:.8rem}
        .planning-week{display:flex;gap:.2rem;margin-bottom:.8rem;overflow-x:auto}
        .planning-day{flex:1;min-width:55px;text-align:center;padding:.4rem;background:var(--cream);border-radius:8px;cursor:pointer}
        .planning-day.active{background:var(--forest);color:#fff}
        .planning-day.today{border:2px solid var(--terracotta)}
        .planning-day.has-revision::after{content:'';display:block;width:5px;height:5px;background:var(--purple);border-radius:50%;margin:.2rem auto 0}
        .planning-day-name{font-size:.6rem}
        .planning-day-num{font-size:1rem;font-weight:600}
        .activity-item{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--cream);border-radius:8px;margin-bottom:.4rem;cursor:pointer}
        .activity-item.revision{background:rgba(155,89,182,.1);border-left:3px solid var(--purple)}
        .activity-time{font-size:.7rem;font-weight:600;color:var(--forest);min-width:40px}
        .activity-info{flex:1}
        .activity-title{font-size:.8rem;font-weight:500}
        .activity-child{font-size:.65rem;color:var(--sage)}
        .activity-icon{font-size:1rem}
        .add-btn{width:100%;padding:.5rem;border:2px dashed var(--sand);border-radius:8px;background:none;color:var(--sage);font-size:.8rem;cursor:pointer}
        .profile-header{text-align:center;padding:1.2rem;background:linear-gradient(135deg,var(--forest),var(--sage));border-radius:12px;margin-bottom:.8rem;color:#fff}
        .profile-avatar{width:50px;height:50px;border-radius:50%;background:var(--sand);margin:0 auto .4rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;border:2px solid #fff}
        .profile-name{font-size:1rem;font-weight:600}
        .family-title{font-size:.8rem;color:var(--sage);margin-bottom:.4rem;display:flex;justify-content:space-between}
        .add-child-btn{padding:.2rem .5rem;border:none;border-radius:12px;background:var(--terracotta);color:#fff;font-size:.65rem;cursor:pointer}
        .child-card{display:flex;align-items:center;gap:.6rem;padding:.6rem;background:#fff;border-radius:10px;margin-bottom:.4rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .child-avatar-lg{width:38px;height:38px;border-radius:50%;background:var(--cream);display:flex;align-items:center;justify-content:center;font-size:1.3rem}
        .child-info{flex:1}
        .child-name{font-weight:600;font-size:.9rem}
        .child-details{font-size:.7rem;color:var(--sage)}
        .child-edit{padding:.2rem .5rem;border:1px solid var(--sand);border-radius:6px;background:none;font-size:.65rem;cursor:pointer}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:#fff;border-radius:12px;padding:1rem;max-width:320px;width:90%;max-height:75vh;overflow-y:auto}
        .modal-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--forest);margin-bottom:.8rem;text-align:center}
        .form-group{margin-bottom:.5rem}
        .form-label{display:block;font-size:.7rem;color:var(--sage);margin-bottom:.1rem}
        .form-input,.form-select{width:100%;padding:.5rem;border:2px solid var(--sand);border-radius:6px;font-family:'Outfit',sans-serif;font-size:.85rem}
        .avatar-picker{display:flex;justify-content:center;gap:.4rem;margin-bottom:.8rem}
        .avatar-option{width:36px;height:36px;border-radius:50%;border:2px solid var(--sand);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer}
        .avatar-option.selected{border-color:var(--forest);background:var(--cream)}
        .modal-buttons{display:flex;gap:.4rem;margin-top:.8rem}
        .modal-btn{flex:1;padding:.5rem;border:none;border-radius:6px;font-weight:500;cursor:pointer;font-size:.8rem}
        .btn-cancel{background:var(--sand)}
        .btn-save{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .btn-delete{background:var(--red);color:#fff}
        .logout-btn{width:100%;padding:.6rem;border:none;border-radius:8px;background:var(--red);color:#fff;cursor:pointer;margin-top:.8rem}
        .notification{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;padding:.5rem 1rem;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.2);z-index:2000;font-size:.8rem}
        .loading-container{text-align:center;padding:1.5rem}
        .loading-spinner{width:35px;height:35px;border:3px solid var(--sand);border-top-color:var(--forest);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto .5rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:1.5rem;color:var(--sage)}
        .empty-icon{font-size:2rem;margin-bottom:.4rem}
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê</button>
            <div class="header-title">üåä FamilyFlow</div>
        </div>
        <div class="header-profile" onclick="switchView('profile')">üë§</div>
    </header>
    <div class="container">
        <!-- REVISION VIEW -->
        <div class="view active" id="revision-view">
            <div id="smartNotifications"></div>
            <div class="revision-plan" id="revisionPlan" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div class="revision-plan-title">üìö Plan du jour</div>
                    <span class="agent-badge revision">ü§ñ Agent</span>
                </div>
                <div id="revisionItems"></div>
            </div>
            <div class="card">
                <div class="card-title">üìÅ Dossiers</div>
                <div class="child-folders" id="childFolders"></div>
                <div id="lessonsList"></div>
            </div>
        </div>
        <!-- HOMEWORK VIEW -->
        <div class="view" id="homework-view">
            <div class="homework-header">
                <div class="child-selector" id="childSelector">
                    <span class="avatar" id="currentAvatar">üë¶</span>
                    <span class="name" id="currentName">Choisir</span>
                    <span class="arrow">‚ñº</span>
                    <div class="child-dropdown" id="childDropdown"></div>
                </div>
                <span class="agent-badge homework">ü§ñ Agent Devoirs</span>
            </div>
            <div class="subject-chips" id="subjectChips">
                <div class="subject-chip active" data-subject="">üìö Tous</div>
                <div class="subject-chip" data-subject="math">üî¢ Maths</div>
                <div class="subject-chip" data-subject="french">üìñ Fran√ßais</div>
                <div class="subject-chip" data-subject="history">üèõÔ∏è Histoire</div>
                <div class="subject-chip" data-subject="science">üî¨ Sciences</div>
            </div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">üìé Photo ou PDF<input type="file" id="fileInput" accept="image/*,.pdf" style="display:none"></div>
            <div class="upload-preview" id="uploadPreview" style="display:none"><img id="previewImg"><button class="remove-upload" onclick="clearUpload()">‚úï</button></div>
            <div class="chat-input-container"><input type="text" class="chat-input" id="parentInput" placeholder="Sujet de la le√ßon..."><button class="chat-send" onclick="sendParentMsg()">‚Üí</button></div>
            <div id="lessonContent"></div>
        </div>
        <!-- QUIZ VIEW -->
        <div class="view" id="quiz-view">
            <div class="quiz-header"><div class="quiz-progress" id="quizProgress"></div><div class="quiz-score" id="quizScore">Score: 0</div></div>
            <div id="quizContent"><div class="empty-state"><div class="empty-icon">üéÆ</div><div>G√©n√©rez une le√ßon</div></div></div>
        </div>
        <!-- PLANNING VIEW -->
        <div class="view" id="planning-view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
                <div class="card-title" style="margin:0">üìÖ Planning</div>
                <span class="agent-badge planning">ü§ñ Agent</span>
            </div>
            <div class="card"><div class="planning-week" id="planningWeek"></div></div>
            <div class="card"><div class="card-title" id="dayTitle">üìã Activit√©s</div><div id="activitiesList"></div><button class="add-btn" onclick="openActivityModal()">+ Ajouter</button></div>
        </div>
        <!-- PROFILE VIEW -->
        <div class="view" id="profile-view">
            <div class="profile-header"><div class="profile-avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div><div class="profile-name">Ma Famille</div><span class="agent-badge profile" style="margin-top:.3rem">ü§ñ Agent Profil</span></div>
            <div class="family-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Enfants <button class="add-child-btn" onclick="openChildModal()">+ Ajouter</button></div>
            <div id="childrenList"></div>
            <button class="logout-btn" onclick="resetAll()">üö™ R√©initialiser</button>
        </div>
    </div>
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="revision"><span class="nav-icon">üìö</span>R√©visions</button>
        <button class="nav-item" data-view="homework"><span class="nav-icon">‚úèÔ∏è</span>Devoirs</button>
        <button class="nav-item" data-view="quiz"><span class="nav-icon">üéÆ</span>Quiz</button>
        <button class="nav-item" data-view="planning"><span class="nav-icon">üìÖ</span>Planning</button>
        <button class="nav-item" data-view="profile"><span class="nav-icon">üë§</span>Profil</button>
    </nav>
    <!-- MODALS -->
    <div class="modal-overlay" id="childModal"><div class="modal">
        <div class="modal-title" id="childModalTitle">‚ûï Enfant</div>
        <div class="avatar-picker"><div class="avatar-option selected" data-avatar="üë¶">üë¶</div><div class="avatar-option" data-avatar="üëß">üëß</div><div class="avatar-option" data-avatar="üßí">üßí</div></div>
        <div class="form-group"><label class="form-label">Pr√©nom</label><input type="text" class="form-input" id="childNameInput"></div>
        <div class="form-group"><label class="form-label">√Çge</label><input type="number" class="form-input" id="childAgeInput" min="3" max="18"></div>
        <div class="form-group"><label class="form-label">Classe</label><select class="form-select" id="childClassInput"><option>CP</option><option>CE1</option><option>CE2</option><option>CM1</option><option>CM2</option><option>6e</option><option>5e</option><option selected>4e</option><option>3e</option><option>2nde</option><option>1ere</option><option>Term</option></select></div>
        <div class="form-group"><label class="form-label">Int√©r√™ts</label><input type="text" class="form-input" id="childInterestsInput" placeholder="foot, manga..."></div>
        <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('childModal')">Annuler</button><button class="modal-btn btn-delete" id="deleteChildBtn" onclick="deleteChild()" style="display:none">üóëÔ∏è</button><button class="modal-btn btn-save" onclick="saveChild()">OK</button></div>
    </div></div>
    <div class="modal-overlay" id="activityModal"><div class="modal">
        <div class="modal-title" id="activityModalTitle">‚ûï Activit√©</div>
        <div class="form-group"><label class="form-label">Titre</label><input type="text" class="form-input" id="activityTitle"></div>
        <div class="form-group"><label class="form-label">Heure</label><input type="time" class="form-input" id="activityTime" value="17:00"></div>
        <div class="form-group"><label class="form-label">Enfant</label><select class="form-select" id="activityChild"></select></div>
        <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="activityType"><option value="activity">üìå Activit√©</option><option value="revision">üìö R√©vision</option></select></div>
        <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('activityModal')">Annuler</button><button class="modal-btn btn-delete" id="deleteActivityBtn" onclick="deleteActivity()" style="display:none">üóëÔ∏è</button><button class="modal-btn btn-save" onclick="saveActivity()">OK</button></div>
    </div></div>
    <div class="modal-overlay" id="lessonModal"><div class="modal" style="max-width:380px">
        <div class="modal-title" id="lessonModalTitle">üìö Le√ßon</div>
        <div id="lessonModalContent"></div>
        <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('lessonModal')">Fermer</button><button class="modal-btn btn-save" onclick="startLessonQuiz()">üéÆ Quiz</button></div>
    </div></div>
<script>
const SUBJECTS={math:{emoji:'üî¢',name:'Maths',color:'#9B59B6'},french:{emoji:'üìñ',name:'Fran√ßais',color:'#C9856B'},history:{emoji:'üèõÔ∏è',name:'Histoire',color:'#E67E22'},science:{emoji:'üî¨',name:'Sciences',color:'#27AE60'},english:{emoji:'üá¨üáß',name:'Anglais',color:'#3498DB'},general:{emoji:'üìö',name:'G√©n√©ral',color:'#7F8C8D'}};
const DAYS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
let data={children:[{id:1,name:'Gauthier',age:13,class:'4e',avatar:'üë¶',interests:'jeux vid√©o, histoire'},{id:2,name:'Charles',age:11,class:'6e',avatar:'üßí',interests:'foot, sciences'},{id:3,name:'Victoire',age:7,class:'CE1',avatar:'üëß',interests:'dessin, animaux'}],lessons:[],activities:[],dismissedNotifs:[]};
let currentChild=null,currentView='revision',viewHistory=[],selectedSubject='',selectedDate=new Date(),selectedFolder=null;
let uploadedFile=null,uploadedBase64=null,conversationHistory=[],currentLesson=null;
let quizQuestions=[],quizIndex=0,quizScore=0,quizAnswered=false;
let editingChild=null,editingActivity=null,viewingLesson=null;

function init(){const s=localStorage.getItem('familyflow_v9');if(s)data={...data,...JSON.parse(s)};if(data.children.length>0){currentChild=data.children[0];selectedFolder=data.children[0]}setupListeners();updateAll();generateNotifs()}
function save(){localStorage.setItem('familyflow_v9',JSON.stringify(data))}
function switchView(v){if(currentView!==v)viewHistory.push(currentView);currentView=v;document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.getElementById(v+'-view').classList.add('active');document.querySelector(`[data-view="${v}"]`)?.classList.add('active');document.getElementById('backBtn').classList.toggle('visible',viewHistory.length>0);if(v==='planning')updatePlanning();if(v==='revision')updateRevision()}
function goBack(){if(viewHistory.length>0){const p=viewHistory.pop();currentView=p;document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.getElementById(p+'-view').classList.add('active');document.querySelector(`[data-view="${p}"]`)?.classList.add('active')}document.getElementById('backBtn').classList.toggle('visible',viewHistory.length>0)}
function setupListeners(){document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>switchView(n.dataset.view)));document.getElementById('fileInput').addEventListener('change',e=>e.target.files[0]&&handleUpload(e.target.files[0]));document.getElementById('parentInput').addEventListener('keypress',e=>e.key==='Enter'&&sendParentMsg());document.getElementById('childSelector').addEventListener('click',e=>{e.stopPropagation();document.getElementById('childDropdown').classList.toggle('show')});document.addEventListener('click',()=>document.getElementById('childDropdown').classList.remove('show'));document.querySelectorAll('.subject-chip').forEach(c=>c.addEventListener('click',()=>{document.querySelectorAll('.subject-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');selectedSubject=c.dataset.subject}));document.querySelectorAll('.avatar-option').forEach(a=>a.addEventListener('click',()=>{document.querySelectorAll('.avatar-option').forEach(x=>x.classList.remove('selected'));a.classList.add('selected')}));document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>e.target===m&&closeModal(m.id)))}
function updateAll(){updateChildSelector();updateChildrenList();updateChildFolders();updateRevision();updatePlanning()}
function generateNotifs(){const n=[],t=new Date(),h=t.getHours();if(h>=17&&h<=20&&data.children.length>0){const c=data.children[0],ls=data.lessons.filter(l=>l.childId===c.id);const nr=ls.filter(l=>{const d=Math.floor((t-new Date(l.date))/(1000*60*60*24));return d>=1&&d<=7});if(nr.length>0&&!data.dismissedNotifs.includes('rev_'+t.toDateString()))n.push({id:'rev_'+t.toDateString(),icon:'üìö',title:nr.length+' le√ßon(s) √† r√©viser',text:c.name+' - '+nr[0].title,action:()=>{selectedFolder=c;updateRevision()}})}const ta=data.activities.filter(a=>new Date(a.date).toDateString()===t.toDateString());if(ta.length>0){const a=ta[0],c=data.children.find(x=>x.id===a.childId);if(!data.dismissedNotifs.includes('act_'+a.id))n.push({id:'act_'+a.id,icon:a.type==='revision'?'üìö':'üìÖ',title:a.title,text:c?c.name+' √† '+a.time:'√Ä '+a.time,action:()=>switchView('planning')})}renderNotifs(n.slice(0,2))}
function renderNotifs(n){document.getElementById('smartNotifications').innerHTML=n.map(x=>`<div class="smart-notif" onclick="handleNotif('${x.id}')"><div class="smart-notif-icon">${x.icon}</div><div class="smart-notif-content"><div class="smart-notif-title">${x.title}</div><div class="smart-notif-text">${x.text}</div></div><button class="smart-notif-close" onclick="dismissNotif(event,'${x.id}')">‚úï</button></div>`).join('');window.notifAct={};n.forEach(x=>{window.notifAct[x.id]=x.action})}
function handleNotif(id){if(window.notifAct[id])window.notifAct[id]()}
function dismissNotif(e,id){e.stopPropagation();data.dismissedNotifs.push(id);save();generateNotifs()}
function updateChildFolders(){document.getElementById('childFolders').innerHTML=data.children.map(c=>{const ct=data.lessons.filter(l=>l.childId===c.id).length;return`<div class="child-folder ${selectedFolder?.id===c.id?'active':''}" onclick="selectFolder(${c.id})"><div class="child-folder-avatar">${c.avatar}</div><div class="child-folder-name">${c.name}</div><div class="child-folder-count">${ct} le√ßon${ct>1?'s':''}</div></div>`}).join('')}
function selectFolder(id){selectedFolder=data.children.find(c=>c.id===id);updateChildFolders();updateLessonsList()}
function updateRevision(){updateChildFolders();updateRevisionPlan();updateLessonsList()}
function updateRevisionPlan(){const p=document.getElementById('revisionPlan'),it=document.getElementById('revisionItems');if(!selectedFolder||data.lessons.length===0){p.style.display='none';return}const ls=data.lessons.filter(l=>l.childId===selectedFolder.id).sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(0,3);if(ls.length===0){p.style.display='none';return}p.style.display='block';const busy=data.activities.filter(a=>new Date(a.date).toDateString()===new Date().toDateString()).map(a=>a.time);const slots=['17:00','17:30','18:00'].filter(t=>!busy.includes(t));it.innerHTML=ls.map((l,i)=>{if(!slots[i])return'';const days=Math.floor((new Date()-new Date(l.date))/(1000*60*60*24));const type=days<1?'Premi√®re lecture':days<3?'R√©vision rapide':'Quiz rappel';return`<div class="revision-item"><div class="revision-time">${slots[i]}</div><div class="revision-content"><div class="revision-content-title">${l.title}</div><div class="revision-content-type">${type}</div></div><button class="revision-action" onclick="scheduleRevision(${l.id},'${slots[i]}')">+</button></div>`}).join('')}
function scheduleRevision(lid,time){const l=data.lessons.find(x=>x.id===lid);if(!l)return;data.activities.push({id:Date.now(),title:'üìö '+l.title,date:selectedDate.toISOString(),time,childId:l.childId,type:'revision'});save();updatePlanning();notify('‚úÖ R√©vision planifi√©e')}
function updateLessonsList(){const c=document.getElementById('lessonsList');if(!selectedFolder){c.innerHTML='<div class="empty-state"><div class="empty-icon">üìÅ</div><div>S√©lectionnez un enfant</div></div>';return}const ls=data.lessons.filter(l=>l.childId===selectedFolder.id).sort((a,b)=>new Date(b.date)-new Date(a.date));if(ls.length===0){c.innerHTML=`<div class="empty-state"><div class="empty-icon">üìö</div><div>Aucune le√ßon</div><button class="lesson-action-btn quiz" style="margin-top:.5rem;max-width:150px" onclick="switchView('homework')">‚úèÔ∏è Ajouter</button></div>`;return}c.innerHTML=ls.map(l=>{const s=SUBJECTS[l.subject]||SUBJECTS.general;const d=new Date(l.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short'});return`<div class="lesson-card ${l.subject}" onclick="openLessonModal(${l.id})"><div class="lesson-header"><div><span class="lesson-subject">${s.emoji} ${s.name}</span><div class="lesson-title">${l.title}</div></div><div class="lesson-date">${d}</div></div><div class="lesson-stats"><span>üß† ${l.mindmap?.branches?.length||0}</span><span>‚ùì ${l.quiz?.length||0}</span>${l.lastQuizScore!==undefined?`<span>üìä ${l.lastQuizScore}%</span>`:''}</div></div>`}).join('')}
function openLessonModal(id){viewingLesson=data.lessons.find(l=>l.id===id);if(!viewingLesson)return;const s=SUBJECTS[viewingLesson.subject]||SUBJECTS.general;document.getElementById('lessonModalTitle').textContent=s.emoji+' '+viewingLesson.title;let h='';if(viewingLesson.summary){h+='<div style="margin-bottom:.8rem"><div style="font-weight:600;color:var(--forest);margin-bottom:.3rem">üìù Points cl√©s</div>';h+=viewingLesson.summary.keyPoints.map(p=>`<div class="key-point">${p}</div>`).join('')+'</div>'}if(viewingLesson.mindmap){h+='<div style="margin-bottom:.8rem"><div style="font-weight:600;color:var(--purple);margin-bottom:.3rem">üß† Carte mentale</div>';h+=`<div class="mindmap-center" style="font-size:.75rem;padding:.3rem .5rem">${viewingLesson.mindmap.center}</div>`;h+=viewingLesson.mindmap.branches.map(b=>`<div style="display:flex;gap:.3rem;font-size:.75rem;margin:.2rem 0"><span>${b.icon}</span><strong>${b.title}:</strong><span style="color:var(--sage)">${b.items.join(', ')}</span></div>`).join('')+'</div>'}document.getElementById('lessonModalContent').innerHTML=h;openModal('lessonModal')}
function startLessonQuiz(){if(!viewingLesson||!viewingLesson.quiz)return;closeModal('lessonModal');quizQuestions=viewingLesson.quiz.map(q=>({q:q.question,a:q.answer,correctAnswer:q.options[0],options:[...q.options].sort(()=>Math.random()-.5),hint:q.hint,lessonId:viewingLesson.id}));quizIndex=0;quizScore=0;quizAnswered=false;switchView('quiz');showQuizQ()}
function updateChildSelector(){const d=document.getElementById('childDropdown');d.innerHTML=data.children.map(c=>`<div class="child-dropdown-item ${currentChild?.id===c.id?'active':''}" onclick="selectChild(${c.id})">${c.avatar} ${c.name}</div>`).join('');if(currentChild){document.getElementById('currentAvatar').textContent=currentChild.avatar;document.getElementById('currentName').textContent=currentChild.name}}
function selectChild(id){currentChild=data.children.find(c=>c.id===id);updateChildSelector();document.getElementById('childDropdown').classList.remove('show');conversationHistory=[];notify('üëã '+currentChild.name)}
function handleUpload(f){if(!f.type.startsWith('image/')&&f.type!=='application/pdf')return notify('‚ö†Ô∏è Format non support√©');uploadedFile=f;const r=new FileReader();r.onload=e=>{uploadedBase64=e.target.result;document.getElementById('uploadZone').style.display='none';document.getElementById('uploadPreview').style.display='block';document.getElementById('previewImg').src=f.type.startsWith('image/')?e.target.result:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><rect fill="%23e74c3c" width="50" height="50" rx="5"/><text x="25" y="30" text-anchor="middle" fill="white">PDF</text></svg>'};r.readAsDataURL(f)}
function clearUpload(){uploadedFile=null;uploadedBase64=null;document.getElementById('uploadZone').style.display='block';document.getElementById('uploadPreview').style.display='none';document.getElementById('fileInput').value=''}
async function sendParentMsg(){const inp=document.getElementById('parentInput'),msg=inp.value.trim();if(!msg&&!uploadedFile)return;inp.value='';const child=currentChild||data.children[0]||{name:'enfant',age:10,class:'CM2',interests:''};let uc=[];if(uploadedBase64&&uploadedFile){const b=uploadedBase64.split(',')[1];uc.push(uploadedFile.type.startsWith('image/')?{type:'image',source:{type:'base64',media_type:uploadedFile.type,data:b}}:{type:'document',source:{type:'base64',media_type:'application/pdf',data:b}})}uc.push({type:'text',text:msg||'Analyse cette le√ßon.'});conversationHistory.push({role:'user',content:uc});document.getElementById('lessonContent').innerHTML='<div class="loading-container"><div class="loading-spinner"></div><div style="color:var(--sage)">ü§ñ Agent Devoirs analyse...</div></div>';const sys=`Tu es l'Agent Devoirs pour ${child.name} (${child.age} ans, ${child.class}). ${child.interests?'Int√©r√™ts: '+child.interests:''}
JAMAIS d'ast√©risques **. R√©ponds UNIQUEMENT en JSON:
{"title":"Titre","subject":"${selectedSubject||'general'}","summary":{"keyPoints":["Point 1","Point 2"],"definitions":[{"term":"Mot","definition":"Def"}]},"mindmap":{"center":"Th√®me","branches":[{"icon":"üîµ","title":"Branche","items":["item1","item2"]}]},"quiz":[{"question":"Q?","answer":"R","options":["Bonne","Fausse1","Fausse2","Fausse3"],"hint":"Indice"}],"estimatedTime":15}
5-6 questions quiz avec options PERTINENTES.`;
try{const res=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys,messages:conversationHistory})});if(res.ok){const r=await res.json(),reply=r.content[0].text;conversationHistory.push({role:'assistant',content:reply});try{const jm=reply.match(/\{[\s\S]*\}/);if(jm){const lesson=JSON.parse(jm[0]);currentLesson={...lesson,id:Date.now(),childId:child.id,date:new Date().toISOString(),subject:selectedSubject||lesson.subject||'general'};renderLesson(currentLesson)}else renderFallback(reply)}catch(e){renderFallback(reply)}}clearUpload()}catch(e){document.getElementById('lessonContent').innerHTML='<div class="empty-state"><div class="empty-icon">‚ùå</div><div>Erreur</div></div>'}}
function renderLesson(l){let h='';if(l.summary){h+=`<div class="lesson-section"><div class="lesson-section-header summary" onclick="toggleSection(this)">üìù R√©sum√© <span class="toggle-icon">‚ñº</span></div><div class="lesson-section-content"><div class="summary-content">${l.title?'<h3 style="color:var(--forest);margin-bottom:.5rem;font-size:.95rem">'+l.title+'</h3>':''}${l.summary.keyPoints?.map(p=>`<div class="key-point">${p}</div>`).join('')||''}${l.summary.definitions?.map(d=>`<div class="definition"><span class="definition-term">${d.term}</span>: ${d.definition}</div>`).join('')||''}</div></div></div>`}if(l.mindmap){h+=`<div class="lesson-section"><div class="lesson-section-header mindmap" onclick="toggleSection(this)">üß† Carte mentale <span class="toggle-icon">‚ñº</span></div><div class="lesson-section-content"><div class="mindmap-center">${l.mindmap.center}</div>${l.mindmap.branches?.map(b=>`<div class="mindmap-branch"><div class="mindmap-branch-icon">${b.icon}</div><div class="mindmap-branch-content"><div class="mindmap-branch-title">${b.title}</div><ul class="mindmap-branch-items">${b.items.map(i=>`<li>${i}</li>`).join('')}</ul></div></div>`).join('')||''}</div></div>`}if(l.quiz&&l.quiz.length>0){quizQuestions=l.quiz.map(q=>({q:q.question,a:q.answer,correctAnswer:q.options[0],options:[...q.options].sort(()=>Math.random()-.5),hint:q.hint}));h+=`<div class="lesson-section"><div class="lesson-section-header qa" onclick="toggleSection(this)">‚ùì Questions (${l.quiz.length}) <span class="toggle-icon">‚ñº</span></div><div class="lesson-section-content">${l.quiz.map((q,i)=>`<div class="qa-card"><div class="qa-question" onclick="toggleQA(this)"><span>${i+1}. ${q.question}</span><span class="toggle">‚ñº</span></div><div class="qa-answer"><div class="qa-answer-content">‚úÖ ${q.answer}</div></div></div>`).join('')}</div></div>`}h+=`<div class="lesson-actions"><button class="lesson-action-btn save" onclick="saveLesson()">üíæ Sauver</button><button class="lesson-action-btn quiz" onclick="startQuizFromLesson()">üéÆ Quiz</button><button class="lesson-action-btn plan" onclick="planRevision()">üìÖ Planifier</button></div>`;document.getElementById('lessonContent').innerHTML=h}
function renderFallback(t){document.getElementById('lessonContent').innerHTML=`<div class="card"><div class="card-title">üìö R√©sum√©</div><div style="font-size:.85rem">${t.replace(/\*\*/g,'').replace(/\n/g,'<br>')}</div></div>`}
function toggleSection(el){el.classList.toggle('collapsed');el.nextElementSibling.classList.toggle('hidden')}
function toggleQA(el){el.classList.toggle('open');el.nextElementSibling.classList.toggle('show')}
function saveLesson(){if(!currentLesson)return notify('‚ö†Ô∏è Aucune le√ßon');const ex=data.lessons.findIndex(l=>l.id===currentLesson.id);if(ex>=0)data.lessons[ex]=currentLesson;else data.lessons.push(currentLesson);save();updateRevision();notify('‚úÖ Sauvegard√©')}
function planRevision(){if(!currentLesson)return;if(!data.lessons.find(l=>l.id===currentLesson.id))saveLesson();const tom=new Date();tom.setDate(tom.getDate()+1);data.activities.push({id:Date.now(),title:'üìö '+currentLesson.title,date:tom.toISOString(),time:'18:00',childId:currentLesson.childId,type:'revision'});save();switchView('planning');notify('üìÖ Planifi√© demain')}
function startQuizFromLesson(){if(quizQuestions.length===0)return notify('‚ö†Ô∏è Pas de questions');quizIndex=0;quizScore=0;quizAnswered=false;switchView('quiz');showQuizQ()}
function showQuizQ(){if(quizIndex>=quizQuestions.length){showQuizResults();return}const q=quizQuestions[quizIndex];quizAnswered=false;document.getElementById('quizProgress').innerHTML=quizQuestions.map((_,i)=>`<div class="progress-dot ${i<quizIndex?'done':i===quizIndex?'current':''}"></div>`).join('');document.getElementById('quizScore').textContent='Score: '+quizScore+'/'+quizIndex;document.getElementById('quizContent').innerHTML=`<div class="quiz-card"><div class="quiz-card-header" id="quizHeader"><div class="quiz-number">Question ${quizIndex+1}/${quizQuestions.length}</div><div class="quiz-question-text">${q.q}</div></div><div class="quiz-card-body"><div class="quiz-options">${q.options.map(o=>`<div class="quiz-option" data-value="${o}" onclick="selectOpt(this)">${o}</div>`).join('')}</div><div id="quizHint"></div><div id="quizExpl"></div></div></div><div class="quiz-actions"><button class="quiz-btn hint" onclick="showHint()">üí°</button><button class="quiz-btn check" onclick="checkAns()">‚úì</button><button class="quiz-btn next" onclick="nextQ()">‚Üí</button></div>`}
function selectOpt(el){if(quizAnswered)return;document.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));el.classList.add('selected')}
function checkAns(){if(quizAnswered)return;const sel=document.querySelector('.quiz-option.selected');if(!sel)return notify('Choisis!');quizAnswered=true;const q=quizQuestions[quizIndex],sv=sel.dataset.value,ic=sv===q.correctAnswer;document.querySelectorAll('.quiz-option').forEach(o=>{o.classList.add('disabled');if(o.dataset.value===q.correctAnswer)o.classList.add('correct');else if(o===sel&&!ic)o.classList.add('wrong')});const h=document.getElementById('quizHeader');if(ic){quizScore++;h.classList.add('correct');notify('üéâ Bravo!')}else{h.classList.add('wrong');document.getElementById('quizExpl').innerHTML=`<div class="quiz-explanation">üìñ ${q.a}</div>`}document.getElementById('quizScore').textContent='Score: '+quizScore+'/'+(quizIndex+1)}
function nextQ(){quizIndex++;showQuizQ()}
function showHint(){const q=quizQuestions[quizIndex];document.getElementById('quizHint').innerHTML=`<div class="quiz-hint">üí° ${q.hint||'R√©fl√©chis...'}</div>`}
function showQuizResults(){const pct=Math.round((quizScore/quizQuestions.length)*100),emoji=pct>=80?'üèÜ':pct>=60?'üëç':'üí™';let txt=pct>=80?'Excellent!':pct>=60?'Bien jou√©!':'Continue!';if(currentChild){if(pct>=80)txt='Bravo '+currentChild.name+'!';else if(pct<60)txt='Courage '+currentChild.name+'!'}if(viewingLesson){const idx=data.lessons.findIndex(l=>l.id===viewingLesson.id);if(idx>=0){data.lessons[idx].lastQuizScore=pct;save()}}document.getElementById('quizContent').innerHTML=`<div class="quiz-results"><div style="font-size:2.5rem">${emoji}</div><div class="quiz-results-score">${quizScore}/${quizQuestions.length}</div><div class="quiz-results-text">${txt}</div><button class="quiz-results-btn" onclick="restartQuiz()">üîÑ Recommencer</button><button class="quiz-results-btn" onclick="switchView('revision')">üìÅ Le√ßons</button></div>`;document.getElementById('quizProgress').innerHTML=''}
function restartQuiz(){quizIndex=0;quizScore=0;quizAnswered=false;quizQuestions.forEach(q=>{q.options=[...q.options].sort(()=>Math.random()-.5)});showQuizQ()}
function updatePlanning(){const t=new Date(),ws=new Date(t);ws.setDate(t.getDate()-t.getDay()+1);let wh='';for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(ws.getDate()+i);const it=d.toDateString()===t.toDateString(),is=d.toDateString()===selectedDate.toDateString(),hr=data.activities.some(a=>new Date(a.date).toDateString()===d.toDateString()&&a.type==='revision');wh+=`<div class="planning-day ${is?'active':''} ${it?'today':''} ${hr?'has-revision':''}" onclick="selectDate('${d.toISOString()}')"><div class="planning-day-name">${DAYS[d.getDay()]}</div><div class="planning-day-num">${d.getDate()}</div></div>`}document.getElementById('planningWeek').innerHTML=wh;document.getElementById('dayTitle').textContent='üìã '+selectedDate.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});const da=data.activities.filter(a=>{const ad=new Date(a.date);return ad.toDateString()===selectedDate.toDateString()}).sort((a,b)=>a.time.localeCompare(b.time));document.getElementById('activitiesList').innerHTML=da.length?da.map(a=>{const c=data.children.find(x=>x.id===a.childId);return`<div class="activity-item ${a.type==='revision'?'revision':''}" onclick="editActivity(${a.id})"><div class="activity-time">${a.time}</div><div class="activity-info"><div class="activity-title">${a.title}</div><div class="activity-child">${c?c.avatar+' '+c.name:''}</div></div><div class="activity-icon">${a.type==='revision'?'üìö':'üìå'}</div></div>`}).join(''):'<div class="empty-state" style="padding:.8rem">Aucune activit√©</div>'}
function selectDate(iso){selectedDate=new Date(iso);updatePlanning()}
function openActivityModal(id=null){editingActivity=id?data.activities.find(a=>a.id===id):null;document.getElementById('activityModalTitle').textContent=editingActivity?'‚úèÔ∏è Modifier':'‚ûï Activit√©';document.getElementById('deleteActivityBtn').style.display=editingActivity?'block':'none';document.getElementById('activityTitle').value=editingActivity?.title||'';document.getElementById('activityTime').value=editingActivity?.time||'17:00';document.getElementById('activityType').value=editingActivity?.type||'activity';document.getElementById('activityChild').innerHTML='<option value="">Famille</option>'+data.children.map(c=>`<option value="${c.id}" ${editingActivity?.childId===c.id?'selected':''}>${c.avatar} ${c.name}</option>`).join('');openModal('activityModal')}
function editActivity(id){openActivityModal(id)}
function saveActivity(){const t=document.getElementById('activityTitle').value.trim();if(!t)return notify('‚ö†Ô∏è Titre requis');const a={id:editingActivity?.id||Date.now(),title:t,time:document.getElementById('activityTime').value,childId:parseInt(document.getElementById('activityChild').value)||null,date:selectedDate.toISOString(),type:document.getElementById('activityType').value};if(editingActivity){const i=data.activities.findIndex(x=>x.id===editingActivity.id);if(i>=0)data.activities[i]=a}else data.activities.push(a);save();updatePlanning();closeModal('activityModal');notify('‚úÖ OK')}
function deleteActivity(){if(!editingActivity)return;data.activities=data.activities.filter(a=>a.id!==editingActivity.id);save();updatePlanning();closeModal('activityModal');notify('üóëÔ∏è Supprim√©')}
function updateChildrenList(){document.getElementById('childrenList').innerHTML=data.children.map(c=>{const ls=data.lessons.filter(l=>l.childId===c.id).length;return`<div class="child-card"><div class="child-avatar-lg">${c.avatar}</div><div class="child-info"><div class="child-name">${c.name}</div><div class="child-details">${c.age} ans ‚Ä¢ ${c.class} ‚Ä¢ ${ls} le√ßons</div></div><button class="child-edit" onclick="editChildProfile(${c.id})">‚úèÔ∏è</button></div>`}).join('')||'<div style="color:var(--sage);padding:.4rem">Aucun enfant</div>'}
function openChildModal(id=null){editingChild=id?data.children.find(c=>c.id===id):null;document.getElementById('childModalTitle').textContent=editingChild?'‚úèÔ∏è Modifier':'‚ûï Enfant';document.getElementById('deleteChildBtn').style.display=editingChild?'block':'none';document.getElementById('childNameInput').value=editingChild?.name||'';document.getElementById('childAgeInput').value=editingChild?.age||'';document.getElementById('childClassInput').value=editingChild?.class||'4e';document.getElementById('childInterestsInput').value=editingChild?.interests||'';document.querySelectorAll('.avatar-option').forEach(a=>a.classList.toggle('selected',a.dataset.avatar===(editingChild?.avatar||'üë¶')));openModal('childModal')}
function editChildProfile(id){openChildModal(id)}
function saveChild(){const n=document.getElementById('childNameInput').value.trim(),a=parseInt(document.getElementById('childAgeInput').value);if(!n||!a)return notify('‚ö†Ô∏è Requis');const c={id:editingChild?.id||Date.now(),name:n,age:a,class:document.getElementById('childClassInput').value,interests:document.getElementById('childInterestsInput').value.trim(),avatar:document.querySelector('.avatar-option.selected')?.dataset.avatar||'üë¶'};if(editingChild){const i=data.children.findIndex(x=>x.id===editingChild.id);if(i>=0)data.children[i]=c}else data.children.push(c);if(!currentChild)currentChild=c;if(!selectedFolder)selectedFolder=c;save();updateAll();closeModal('childModal');notify('‚úÖ OK')}
function deleteChild(){if(!editingChild)return;data.children=data.children.filter(c=>c.id!==editingChild.id);data.lessons=data.lessons.filter(l=>l.childId!==editingChild.id);if(currentChild?.id===editingChild.id)currentChild=data.children[0]||null;if(selectedFolder?.id===editingChild.id)selectedFolder=data.children[0]||null;save();updateAll();closeModal('childModal');notify('üóëÔ∏è Supprim√©')}
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function notify(m){const n=document.createElement('div');n.className='notification';n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.remove(),2500)}
function resetAll(){if(confirm('Tout r√©initialiser?')){localStorage.removeItem('familyflow_v9');location.reload()}}
init();
</script>
</body>
</html>
