<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow v10</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--cream:#FAF7F2;--sand:#E8DCC4;--terracotta:#C9856B;--forest:#5F7161;--sage:#8B9D83;--midnight:#2C3333;--white:#FFF;--red:#E74C3C;--green:#27AE60;--blue:#3498DB;--purple:#9B59B6;--orange:#E67E22;--yellow:#F1C40F}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--cream);color:var(--midnight);min-height:100vh;padding-bottom:80px}
        header{background:linear-gradient(135deg,var(--forest),var(--sage));padding:.8rem 1rem;display:flex;justify-content:space-between;align-items:center}
        .header-title{font-family:'Playfair Display',serif;font-size:1.4rem;color:#fff;font-weight:600}
        .header-icon{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:.5rem 0;box-shadow:0 -2px 15px rgba(0,0,0,.1);z-index:100}
        .nav-item{display:flex;flex-direction:column;align-items:center;padding:.2rem .5rem;border:none;background:none;cursor:pointer;color:var(--sage);font-size:.55rem}
        .nav-item.active{color:var(--forest)}
        .nav-item .nav-icon{font-size:1.2rem}
        .container{max-width:600px;margin:0 auto;padding:1rem}
        .view{display:none}.view.active{display:block}
        .card{background:#fff;border-radius:16px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 15px rgba(0,0,0,.08)}
        .card-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--forest);margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
        .meteo-header{background:linear-gradient(135deg,var(--forest),var(--sage));border-radius:16px;padding:1.2rem;color:#fff;margin-bottom:1rem;text-align:center}
        .meteo-date{font-size:.8rem;opacity:.9}
        .meteo-greeting{font-family:'Playfair Display',serif;font-size:1.3rem;margin:.3rem 0}
        .meteo-summary{font-size:.85rem;opacity:.9}
        .meteo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.8rem;margin-bottom:1rem}
        .meteo-card{background:#fff;border-radius:12px;padding:.8rem;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.06)}
        .meteo-card.good{border-top:3px solid var(--green)}
        .meteo-card.warning{border-top:3px solid var(--orange)}
        .meteo-card.alert{border-top:3px solid var(--red)}
        .meteo-icon{font-size:1.5rem;margin-bottom:.3rem}
        .meteo-label{font-size:.65rem;color:var(--sage)}
        .meteo-value{font-weight:600;font-size:.9rem}
        .daily-tips{background:linear-gradient(135deg,var(--terracotta),#D4967A);border-radius:12px;padding:1rem;color:#fff}
        .daily-tips-title{font-weight:600;margin-bottom:.5rem}
        .daily-tip{font-size:.85rem;padding:.4rem 0;border-bottom:1px solid rgba(255,255,255,.2)}
        .daily-tip:last-child{border-bottom:none}
        .import-zone{border:3px dashed var(--sand);border-radius:16px;padding:2rem;text-align:center;cursor:pointer;background:#fff}
        .import-icon{font-size:2.5rem;margin-bottom:.5rem}
        .import-title{font-family:'Playfair Display',serif;color:var(--forest)}
        .import-text{color:var(--sage);font-size:.8rem}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin-bottom:1rem}
        .stat-card{background:#fff;border-radius:12px;padding:.8rem;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.06)}
        .stat-card.income{border-left:3px solid var(--green)}
        .stat-card.expense{border-left:3px solid var(--terracotta)}
        .stat-card.balance{border-left:3px solid var(--blue)}
        .stat-card.savings{border-left:3px solid var(--purple)}
        .stat-value{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600}
        .stat-label{font-size:.65rem;color:var(--sage)}
        .category-item{display:flex;align-items:center;gap:.5rem;padding:.5rem 0;border-bottom:1px solid var(--cream)}
        .category-emoji{font-size:1.1rem}
        .category-info{flex:1}
        .category-name{font-size:.8rem;font-weight:500}
        .category-bar{height:5px;background:var(--cream);border-radius:3px;margin-top:.2rem}
        .category-fill{height:100%;border-radius:3px}
        .category-amount{font-weight:600;font-size:.85rem}
        .transaction-item{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--cream);border-radius:10px;margin-bottom:.4rem}
        .transaction-info{flex:1}
        .transaction-desc{font-size:.8rem;font-weight:500}
        .transaction-date{font-size:.65rem;color:var(--sage)}
        .transaction-amount{font-weight:600;font-size:.85rem}
        .transaction-amount.income{color:var(--green)}
        .transaction-amount.expense{color:var(--terracotta)}
        .alert-card{border-radius:12px;padding:.8rem;margin-bottom:.6rem;display:flex;gap:.6rem}
        .alert-card.warning{background:#FFF3E0;border-left:3px solid var(--orange)}
        .alert-card.danger{background:#FFEBEE;border-left:3px solid var(--red)}
        .alert-card.success{background:#E8F5E9;border-left:3px solid var(--green)}
        .alert-card.tip{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .alert-icon{font-size:1.2rem}
        .alert-content{flex:1}
        .alert-title{font-weight:600;font-size:.85rem}
        .alert-text{font-size:.75rem;opacity:.9}
        .score-circle{width:80px;height:80px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 1rem}
        .score-circle.good{background:linear-gradient(135deg,var(--green),#2ECC71)}
        .score-circle.warning{background:linear-gradient(135deg,var(--orange),#F39C12)}
        .score-circle.bad{background:linear-gradient(135deg,var(--red),#C0392B)}
        .score-value{font-size:1.5rem;font-weight:700;color:#fff}
        .score-label{font-size:.5rem;color:rgba(255,255,255,.8)}
        .planning-week{display:flex;gap:.3rem;margin-bottom:1rem;overflow-x:auto}
        .planning-day{flex:1;min-width:50px;text-align:center;padding:.5rem .3rem;background:#fff;border-radius:10px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.05)}
        .planning-day.active{background:var(--forest);color:#fff}
        .planning-day.today{border:2px solid var(--terracotta)}
        .planning-day.has-event::after{content:'';display:block;width:6px;height:6px;background:var(--purple);border-radius:50%;margin:.3rem auto 0}
        .planning-day-name{font-size:.6rem}
        .planning-day-num{font-size:1rem;font-weight:600}
        .activity-item{display:flex;align-items:center;gap:.6rem;padding:.7rem;background:#fff;border-radius:10px;margin-bottom:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05);cursor:pointer}
        .activity-item.revision{border-left:3px solid var(--purple)}
        .activity-time{font-size:.75rem;font-weight:600;color:var(--forest);min-width:45px}
        .activity-info{flex:1}
        .activity-title{font-size:.85rem;font-weight:500}
        .activity-child{font-size:.7rem;color:var(--sage)}
        .add-btn{width:100%;padding:.7rem;border:2px dashed var(--sand);border-radius:10px;background:none;color:var(--sage);cursor:pointer;font-size:.85rem}
        .homework-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
        .child-selector{position:relative;display:flex;align-items:center;gap:.4rem;padding:.5rem .8rem;background:#fff;border-radius:25px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .child-selector .avatar{font-size:1.2rem}
        .child-selector .name{font-weight:500;font-size:.85rem}
        .child-selector .arrow{font-size:.6rem;color:var(--sage)}
        .child-dropdown{position:absolute;top:calc(100% + 5px);left:0;right:0;background:#fff;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.15);z-index:50;max-height:0;overflow:hidden;transition:max-height .3s}
        .child-dropdown.show{max-height:200px}
        .child-dropdown-item{padding:.6rem .8rem;cursor:pointer;font-size:.85rem}
        .child-dropdown-item:hover{background:var(--cream)}
        .child-dropdown-item.active{background:var(--sand)}
        .subject-chips{display:flex;gap:.4rem;margin-bottom:.8rem;flex-wrap:wrap}
        .subject-chip{padding:.4rem .7rem;border-radius:20px;border:2px solid var(--sand);background:#fff;font-size:.75rem;cursor:pointer}
        .subject-chip.active{border-color:var(--forest);background:var(--cream)}
        .upload-zone{border:2px dashed var(--sand);border-radius:12px;padding:.8rem;text-align:center;cursor:pointer;font-size:.8rem;color:var(--sage);margin-bottom:.5rem}
        .upload-preview{position:relative;padding:.5rem;background:var(--cream);border-radius:10px;text-align:center;margin-bottom:.5rem}
        .upload-preview img{max-width:100%;max-height:80px;border-radius:6px}
        .remove-upload{position:absolute;top:5px;right:5px;width:20px;height:20px;border-radius:50%;border:none;background:var(--red);color:#fff;cursor:pointer;font-size:.7rem}
        .chat-input-container{display:flex;gap:.4rem;padding:.5rem;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
        .chat-input{flex:1;padding:.5rem;border:none;font-family:'Outfit',sans-serif;font-size:.85rem}
        .chat-input:focus{outline:none}
        .chat-send{padding:.5rem .8rem;border:none;border-radius:8px;background:var(--forest);color:#fff;cursor:pointer}
        .lesson-section{background:#fff;border-radius:14px;margin-bottom:.8rem;overflow:hidden;box-shadow:0 3px 12px rgba(0,0,0,.08)}
        .lesson-section-header{padding:.7rem 1rem;font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:.5rem;cursor:pointer}
        .lesson-section-header.summary{background:linear-gradient(135deg,var(--blue),#5DADE2);color:#fff}
        .lesson-section-header.mindmap{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff}
        .lesson-section-header.qa{background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff}
        .lesson-section-header .toggle-icon{margin-left:auto}
        .lesson-section-content{padding:1rem}
        .lesson-section-content.hidden{display:none}
        .key-point{background:rgba(52,152,219,.1);border-left:3px solid var(--blue);padding:.5rem .8rem;margin:.4rem 0;border-radius:0 8px 8px 0;font-size:.85rem}
        .definition{background:var(--cream);padding:.5rem;border-radius:8px;margin:.4rem 0;font-size:.85rem}
        .definition-term{font-weight:600;color:var(--forest)}
        .mindmap-center{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff;padding:.6rem 1rem;border-radius:25px;text-align:center;font-weight:600;font-size:.9rem;margin:0 auto .8rem;max-width:200px}
        .mindmap-branch{display:flex;align-items:flex-start;gap:.5rem;margin-bottom:.6rem}
        .mindmap-branch-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85rem;background:var(--cream)}
        .mindmap-branch-content{flex:1;background:var(--cream);padding:.5rem .7rem;border-radius:10px}
        .mindmap-branch-title{font-weight:600;font-size:.85rem;color:var(--forest)}
        .mindmap-branch-items{font-size:.8rem;list-style:none}
        .mindmap-branch-items li{margin:.2rem 0;padding-left:.5rem}
        .qa-card{background:#fff;border-radius:10px;margin-bottom:.5rem;overflow:hidden;border:1px solid var(--sand)}
        .qa-question{padding:.7rem;background:linear-gradient(135deg,var(--forest),var(--sage));color:#fff;font-size:.85rem;cursor:pointer;display:flex;justify-content:space-between}
        .qa-answer{max-height:0;overflow:hidden;transition:max-height .3s;background:var(--cream)}
        .qa-answer.show{max-height:300px}
        .qa-answer-content{padding:.7rem;font-size:.85rem}
        .lesson-actions{display:flex;gap:.5rem;flex-wrap:wrap}
        .lesson-action-btn{flex:1;min-width:100px;padding:.6rem;border:none;border-radius:10px;font-size:.8rem;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.3rem}
        .lesson-action-btn.save{background:linear-gradient(135deg,var(--purple),#A569BD);color:#fff}
        .lesson-action-btn.quiz{background:linear-gradient(135deg,var(--terracotta),#D98B70);color:#fff}
        .lesson-action-btn.plan{background:linear-gradient(135deg,var(--green),var(--sage));color:#fff}
        .quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .quiz-progress{display:flex;gap:.3rem}
        .progress-dot{width:10px;height:10px;border-radius:50%;background:var(--sand)}
        .progress-dot.done{background:var(--green)}
        .progress-dot.current{background:var(--blue);transform:scale(1.2)}
        .quiz-score{font-weight:600;color:var(--forest)}
        .quiz-card{background:#fff;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,.1);overflow:hidden}
        .quiz-card-header{padding:1.2rem;text-align:center;background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .quiz-card-header.correct{background:linear-gradient(135deg,var(--green),#2ECC71)}
        .quiz-card-header.wrong{background:linear-gradient(135deg,var(--red),#C0392B)}
        .quiz-number{font-size:.75rem;opacity:.9}
        .quiz-question-text{font-size:1rem;font-weight:600;margin-top:.3rem}
        .quiz-card-body{padding:1rem}
        .quiz-option{padding:.7rem;border:2px solid var(--sand);border-radius:10px;margin-bottom:.5rem;cursor:pointer;font-size:.9rem}
        .quiz-option:hover{border-color:var(--blue)}
        .quiz-option.selected{border-color:var(--blue);background:rgba(52,152,219,.1)}
        .quiz-option.correct{border-color:var(--green);background:rgba(39,174,96,.15)}
        .quiz-option.wrong{border-color:var(--red);background:rgba(231,76,60,.15)}
        .quiz-option.disabled{pointer-events:none;opacity:.7}
        .quiz-actions{display:flex;justify-content:center;gap:1rem;margin-top:1rem}
        .quiz-btn{width:50px;height:50px;border-radius:50%;border:none;font-size:1.2rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .quiz-btn.hint{background:linear-gradient(135deg,var(--orange),var(--yellow));color:#fff}
        .quiz-btn.check{background:linear-gradient(135deg,var(--green),#2ECC71);color:#fff}
        .quiz-btn.next{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .quiz-hint{text-align:center;padding:.5rem;background:#FFF3E0;border-radius:8px;margin-top:.6rem;font-size:.85rem;color:var(--orange)}
        .quiz-explanation{padding:.6rem;background:var(--cream);border-radius:8px;margin-top:.6rem;font-size:.85rem}
        .quiz-results{text-align:center;padding:2rem 1rem}
        .quiz-results-score{font-size:3rem;font-weight:700;color:var(--forest)}
        .quiz-results-text{color:var(--sage);margin:.5rem 0 1rem}
        .quiz-results-btn{padding:.7rem 1.2rem;border:none;border-radius:25px;background:var(--forest);color:#fff;cursor:pointer;margin:.3rem}
        .child-folders{display:flex;gap:.5rem;overflow-x:auto;padding-bottom:.5rem;margin-bottom:1rem}
        .child-folder{display:flex;flex-direction:column;align-items:center;padding:.6rem .8rem;background:#fff;border-radius:12px;cursor:pointer;min-width:70px;box-shadow:0 2px 8px rgba(0,0,0,.06);border:2px solid transparent}
        .child-folder.active{border-color:var(--forest);background:var(--cream)}
        .child-folder-avatar{font-size:1.4rem}
        .child-folder-name{font-size:.7rem;font-weight:500}
        .child-folder-count{font-size:.6rem;color:var(--sage)}
        .lesson-folder-card{background:#fff;border-radius:12px;padding:.8rem;margin-bottom:.6rem;box-shadow:0 2px 10px rgba(0,0,0,.06);cursor:pointer;border-left:4px solid var(--blue)}
        .lesson-folder-card.math{border-left-color:var(--purple)}
        .lesson-folder-card.french{border-left-color:var(--terracotta)}
        .lesson-folder-card.history{border-left-color:var(--orange)}
        .lesson-folder-card.science{border-left-color:var(--green)}
        .lesson-folder-header{display:flex;justify-content:space-between}
        .lesson-folder-title{font-weight:600;font-size:.85rem}
        .lesson-folder-date{font-size:.65rem;color:var(--sage)}
        .lesson-folder-subject{display:inline-block;padding:.15rem .4rem;border-radius:10px;font-size:.6rem;background:var(--cream);margin-bottom:.2rem}
        .lesson-folder-stats{display:flex;gap:.8rem;font-size:.7rem;color:var(--sage)}
        .profile-header{text-align:center;padding:1.5rem;background:linear-gradient(135deg,var(--forest),var(--sage));border-radius:16px;margin-bottom:1rem;color:#fff}
        .profile-avatar{width:60px;height:60px;border-radius:50%;background:var(--sand);margin:0 auto .5rem;display:flex;align-items:center;justify-content:center;font-size:1.8rem;border:3px solid #fff}
        .profile-name{font-size:1.1rem;font-weight:600}
        .family-title{font-size:.85rem;color:var(--sage);margin-bottom:.5rem;display:flex;justify-content:space-between}
        .add-child-btn{padding:.3rem .6rem;border:none;border-radius:15px;background:var(--terracotta);color:#fff;font-size:.7rem;cursor:pointer}
        .child-card{display:flex;align-items:center;gap:.8rem;padding:.8rem;background:#fff;border-radius:12px;margin-bottom:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .child-avatar-lg{width:45px;height:45px;border-radius:50%;background:var(--cream);display:flex;align-items:center;justify-content:center;font-size:1.5rem}
        .child-info{flex:1}
        .child-name{font-weight:600;font-size:.95rem}
        .child-details{font-size:.75rem;color:var(--sage)}
        .child-edit{padding:.3rem .6rem;border:1px solid var(--sand);border-radius:8px;background:none;font-size:.7rem;cursor:pointer}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:#fff;border-radius:16px;padding:1.2rem;max-width:350px;width:90%;max-height:80vh;overflow-y:auto}
        .modal-title{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--forest);margin-bottom:1rem;text-align:center}
        .form-group{margin-bottom:.7rem}
        .form-label{display:block;font-size:.75rem;color:var(--sage);margin-bottom:.2rem}
        .form-input,.form-select{width:100%;padding:.6rem;border:2px solid var(--sand);border-radius:8px;font-family:'Outfit',sans-serif;font-size:.9rem}
        .avatar-picker{display:flex;justify-content:center;gap:.5rem;margin-bottom:1rem}
        .avatar-option{width:40px;height:40px;border-radius:50%;border:2px solid var(--sand);display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer}
        .avatar-option.selected{border-color:var(--forest);background:var(--cream)}
        .modal-buttons{display:flex;gap:.6rem;margin-top:1rem}
        .modal-btn{flex:1;padding:.7rem;border:none;border-radius:8px;font-weight:500;cursor:pointer;font-size:.85rem}
        .btn-cancel{background:var(--sand)}
        .btn-save{background:var(--forest);color:#fff}
        .btn-delete{background:var(--red);color:#fff}
        .notification{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:var(--forest);color:#fff;padding:.6rem 1.2rem;border-radius:25px;box-shadow:0 4px 15px rgba(0,0,0,.2);z-index:2000;font-size:.85rem}
        .loading-container{text-align:center;padding:2rem}
        .loading-spinner{width:40px;height:40px;border:3px solid var(--sand);border-top-color:var(--forest);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto .5rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:2rem;color:var(--sage)}
        .empty-icon{font-size:2.5rem;margin-bottom:.5rem}
        .reset-btn{display:block;width:100%;padding:.6rem;border:2px dashed var(--sand);border-radius:8px;background:none;color:var(--sage);cursor:pointer;margin-top:1rem}
        .logout-btn{width:100%;padding:.8rem;border:none;border-radius:10px;background:var(--red);color:#fff;cursor:pointer;margin-top:1rem}
    </style>
</head>
<body>
    <header>
        <div class="header-title">üåä FamilyFlow</div>
        <div class="header-icon" onclick="switchView('profile')">üë§</div>
    </header>
    <div class="container">
        <!-- DASHBOARD -->
        <div class="view active" id="dashboard-view">
            <div class="meteo-header">
                <div class="meteo-date" id="meteoDate"></div>
                <div class="meteo-greeting" id="meteoGreeting">Bonjour ! üëã</div>
                <div class="meteo-summary" id="meteoSummary">Votre journ√©e en un coup d'≈ìil</div>
            </div>
            <div class="meteo-grid">
                <div class="meteo-card" id="meteoHw"><div class="meteo-icon">üìö</div><div class="meteo-label">Devoirs</div><div class="meteo-value" id="meteoHwVal">0</div></div>
                <div class="meteo-card" id="meteoAct"><div class="meteo-icon">üìÖ</div><div class="meteo-label">Activit√©s</div><div class="meteo-value" id="meteoActVal">0</div></div>
                <div class="meteo-card" id="meteoBudget"><div class="meteo-icon">üí∞</div><div class="meteo-label">Budget</div><div class="meteo-value" id="meteoBudgetVal">--</div></div>
            </div>
            <div class="daily-tips"><div class="daily-tips-title">üí° Conseils du jour</div><div id="tipsContent"></div></div>
        </div>
        <!-- BUDGET -->
        <div class="view" id="budget-view">
            <div id="importSection"><div class="import-zone" onclick="document.getElementById('importInput').click()"><div class="import-icon">üìÑ</div><div class="import-title">Importer un relev√©</div><div class="import-text">PDF ou CSV</div><input type="file" id="importInput" accept=".pdf,.csv" style="display:none"></div></div>
            <div class="loading-container" id="loadingBudget" style="display:none"><div class="loading-spinner"></div><div style="color:var(--sage)">Analyse...</div></div>
            <div id="budgetDashboard" style="display:none">
                <div class="stats-grid">
                    <div class="stat-card income"><div class="stat-value" id="totalIncome">0‚Ç¨</div><div class="stat-label">Revenus</div></div>
                    <div class="stat-card expense"><div class="stat-value" id="totalExpenses">0‚Ç¨</div><div class="stat-label">D√©penses</div></div>
                    <div class="stat-card balance"><div class="stat-value" id="totalBalance">0‚Ç¨</div><div class="stat-label">Solde</div></div>
                    <div class="stat-card savings"><div class="stat-value" id="savingsRate">0%</div><div class="stat-label">√âpargne</div></div>
                </div>
                <div class="card"><div class="card-title">üìä Par cat√©gorie</div><div id="categoryBreakdown"></div></div>
                <div class="card"><div class="card-title">üìã Transactions</div><div id="recentTransactions"></div></div>
                <button class="reset-btn" onclick="resetBudget()">üîÑ Nouveau relev√©</button>
            </div>
        </div>
        <!-- OPTIMIZE -->
        <div class="view" id="optimize-view"><div id="optimizeContent"><div class="empty-state"><div class="empty-icon">üìä</div><div>Importez un relev√©</div></div></div></div>
        <!-- PLANNING -->
        <div class="view" id="planning-view">
            <div class="card"><div class="card-title">üìÖ Semaine</div><div class="planning-week" id="planningWeek"></div></div>
            <div class="card"><div class="card-title" id="dayTitle">üìã Activit√©s</div><div id="activitiesList"></div><button class="add-btn" onclick="openActivityModal()">+ Ajouter</button></div>
        </div>
        <!-- HOMEWORK -->
        <div class="view" id="homework-view">
            <div class="homework-header">
                <div class="child-selector" id="childSelector" onclick="toggleDropdown(event)"><span class="avatar" id="curAvatar">üë¶</span><span class="name" id="curName">Choisir</span><span class="arrow">‚ñº</span><div class="child-dropdown" id="childDropdown"></div></div>
            </div>
            <div class="subject-chips"><div class="subject-chip active" data-subject="" onclick="selectSubject(this)">üìö Tous</div><div class="subject-chip" data-subject="math" onclick="selectSubject(this)">üî¢ Maths</div><div class="subject-chip" data-subject="french" onclick="selectSubject(this)">üìñ Fran√ßais</div><div class="subject-chip" data-subject="history" onclick="selectSubject(this)">üèõÔ∏è Histoire</div><div class="subject-chip" data-subject="science" onclick="selectSubject(this)">üî¨ Sciences</div></div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">üìé Photo ou PDF<input type="file" id="fileInput" accept="image/*,.pdf" style="display:none"></div>
            <div class="upload-preview" id="uploadPreview" style="display:none"><img id="previewImg"><button class="remove-upload" onclick="clearUpload()">‚úï</button></div>
            <div class="chat-input-container"><input type="text" class="chat-input" id="lessonInput" placeholder="Sujet de la le√ßon..."><button class="chat-send" onclick="sendLesson()">‚Üí</button></div>
            <div id="lessonContent"></div>
        </div>
        <!-- QUIZ -->
        <div class="view" id="quiz-view">
            <div class="quiz-header"><div class="quiz-progress" id="quizProgress"></div><div class="quiz-score" id="quizScoreDisplay">Score: 0</div></div>
            <div id="quizContent"><div class="empty-state"><div class="empty-icon">üéÆ</div><div>G√©n√©rez une le√ßon</div></div></div>
        </div>
        <!-- REVISION -->
        <div class="view" id="revision-view">
            <div class="card"><div class="card-title">üìÅ Le√ßons sauvegard√©es</div><div class="child-folders" id="childFolders"></div><div id="savedLessons"></div></div>
        </div>
        <!-- PROFILE -->
        <div class="view" id="profile-view">
            <div class="profile-header"><div class="profile-avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div><div class="profile-name">Ma Famille</div></div>
            <div class="family-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Enfants <button class="add-child-btn" onclick="openChildModal()">+ Ajouter</button></div>
            <div id="childrenList"></div>
            <button class="logout-btn" onclick="resetAll()">üö™ R√©initialiser</button>
        </div>
    </div>
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="dashboard"><span class="nav-icon">üè†</span>Accueil</button>
        <button class="nav-item" data-view="budget"><span class="nav-icon">üí∞</span>Budget</button>
        <button class="nav-item" data-view="planning"><span class="nav-icon">üìÖ</span>Planning</button>
        <button class="nav-item" data-view="homework"><span class="nav-icon">üìö</span>Devoirs</button>
        <button class="nav-item" data-view="revision"><span class="nav-icon">üéØ</span>R√©visions</button>
    </nav>
    <!-- MODALS -->
    <div class="modal-overlay" id="childModal"><div class="modal">
        <div class="modal-title" id="childModalTitle">‚ûï Enfant</div>
        <div class="avatar-picker"><div class="avatar-option selected" data-avatar="üë¶">üë¶</div><div class="avatar-option" data-avatar="üëß">üëß</div><div class="avatar-option" data-avatar="üßí">üßí</div></div>
        <div class="form-group"><label class="form-label">Pr√©nom</label><input type="text" class="form-input" id="childNameInput"></div>
        <div class="form-group"><label class="form-label">√Çge</label><input type="number" class="form-input" id="childAgeInput" min="3" max="18"></div>
        <div class="form-group"><label class="form-label">Classe</label><select class="form-select" id="childClassInput"><option>CP</option><option>CE1</option><option>CE2</option><option>CM1</option><option>CM2</option><option>6e</option><option>5e</option><option selected>4e</option><option>3e</option><option>2nde</option><option>1ere</option><option>Term</option></select></div>
        <div class="form-group"><label class="form-label">Int√©r√™ts</label><input type="text" class="form-input" id="childInterestsInput" placeholder="foot, manga..."></div>
        <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('childModal')">Annuler</button><button class="modal-btn btn-delete" id="deleteChildBtn" onclick="deleteChild()" style="display:none">üóëÔ∏è</button><button class="modal-btn btn-save" onclick="saveChild()">OK</button></div>
    </div></div>
    <div class="modal-overlay" id="activityModal"><div class="modal">
        <div class="modal-title" id="activityModalTitle">‚ûï Activit√©</div>
        <div class="form-group"><label class="form-label">Titre</label><input type="text" class="form-input" id="activityTitleInput"></div>
        <div class="form-group"><label class="form-label">Heure</label><input type="time" class="form-input" id="activityTimeInput" value="14:00"></div>
        <div class="form-group"><label class="form-label">Enfant</label><select class="form-select" id="activityChildInput"></select></div>
        <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="activityTypeInput"><option value="activity">üìå Activit√©</option><option value="revision">üìö R√©vision</option></select></div>
        <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('activityModal')">Annuler</button><button class="modal-btn btn-delete" id="deleteActivityBtn" onclick="deleteActivity()" style="display:none">üóëÔ∏è</button><button class="modal-btn btn-save" onclick="saveActivity()">OK</button></div>
    </div></div>
    <div class="modal-overlay" id="lessonModal"><div class="modal" style="max-width:400px">
        <div class="modal-title" id="lessonModalTitle">üìö Le√ßon</div>
        <div id="lessonModalContent"></div>
        <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeModal('lessonModal')">Fermer</button><button class="modal-btn btn-save" onclick="startSavedQuiz()">üéÆ Quiz</button></div>
    </div></div>
<script>
const CATEGORIES={shopping:{emoji:'üõí',name:'Shopping',color:'#E74C3C'},food:{emoji:'üçï',name:'Alimentation',color:'#E67E22'},transport:{emoji:'üöó',name:'Transport',color:'#3498DB'},housing:{emoji:'üè†',name:'Logement',color:'#9B59B6'},bills:{emoji:'üìÑ',name:'Factures',color:'#8E44AD'},entertainment:{emoji:'üé¨',name:'Loisirs',color:'#1ABC9C'},health:{emoji:'üíä',name:'Sant√©',color:'#E91E63'},subscriptions:{emoji:'üì±',name:'Abos',color:'#00BCD4'},salary:{emoji:'üíº',name:'Salaire',color:'#27AE60'},other:{emoji:'üì¶',name:'Autre',color:'#7F8C8D'}};
const SUBJECTS={math:{emoji:'üî¢',name:'Maths',color:'#9B59B6'},french:{emoji:'üìñ',name:'Fran√ßais',color:'#C9856B'},history:{emoji:'üèõÔ∏è',name:'Histoire',color:'#E67E22'},science:{emoji:'üî¨',name:'Sciences',color:'#27AE60'},general:{emoji:'üìö',name:'G√©n√©ral',color:'#7F8C8D'}};
const DAYS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
let data={children:[{id:1,name:'Gauthier',age:13,class:'4e',avatar:'üë¶',interests:'jeux vid√©o, histoire'},{id:2,name:'Charles',age:11,class:'6e',avatar:'üßí',interests:'foot, sciences'},{id:3,name:'Victoire',age:7,class:'CE1',avatar:'üëß',interests:'dessin, animaux'}],transactions:[],activities:[],lessons:[]};
let currentView='dashboard',currentChild=null,selectedDate=new Date(),selectedSubject='',selectedFolder=null;
let uploadedFile=null,uploadedBase64=null,conversationHistory=[],currentLesson=null;
let quizQuestions=[],quizIndex=0,quizScore=0,quizAnswered=false;
let editingChild=null,editingActivity=null,viewingLesson=null;

function init(){const s=localStorage.getItem('familyflow_v10');if(s)data={...data,...JSON.parse(s)};if(data.children.length>0){currentChild=data.children[0];selectedFolder=data.children[0]}setupListeners();updateAll()}
function save(){localStorage.setItem('familyflow_v10',JSON.stringify(data))}
function switchView(v){currentView=v;document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.getElementById(v+'-view').classList.add('active');document.querySelector(`[data-view="${v}"]`)?.classList.add('active');if(v==='dashboard')updateDashboard();if(v==='budget')updateBudget();if(v==='optimize')updateOptimize();if(v==='planning')updatePlanning();if(v==='revision')updateRevision()}
function setupListeners(){document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>switchView(n.dataset.view)));document.getElementById('importInput').addEventListener('change',e=>e.target.files[0]&&importBudget(e.target.files[0]));document.getElementById('fileInput').addEventListener('change',e=>e.target.files[0]&&handleUpload(e.target.files[0]));document.getElementById('lessonInput').addEventListener('keypress',e=>e.key==='Enter'&&sendLesson());document.addEventListener('click',e=>{if(!e.target.closest('#childSelector'))document.getElementById('childDropdown').classList.remove('show')});document.querySelectorAll('.avatar-option').forEach(a=>a.addEventListener('click',()=>{document.querySelectorAll('.avatar-option').forEach(x=>x.classList.remove('selected'));a.classList.add('selected')}));document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>e.target===m&&closeModal(m.id)))}
function toggleDropdown(e){e.stopPropagation();document.getElementById('childDropdown').classList.toggle('show')}
function selectSubject(el){document.querySelectorAll('.subject-chip').forEach(x=>x.classList.remove('active'));el.classList.add('active');selectedSubject=el.dataset.subject}
function updateAll(){updateDashboard();updateChildSelector();updateChildrenList();updateBudget();updatePlanning();updateRevision()}

// DASHBOARD
function updateDashboard(){const now=new Date(),h=now.getHours(),days=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'],months=['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];document.getElementById('meteoDate').textContent=days[now.getDay()]+' '+now.getDate()+' '+months[now.getMonth()];document.getElementById('meteoGreeting').textContent=(h<12?'Bonjour':h<18?'Bon apr√®s-midi':'Bonsoir')+' ! üëã';
const lr=data.lessons.filter(l=>{const d=Math.floor((now-new Date(l.date))/(1000*60*60*24));return d>=1&&d<=7}).length;document.getElementById('meteoHwVal').textContent=lr;document.getElementById('meteoHw').className='meteo-card '+(lr===0?'good':lr<=2?'warning':'alert');
const ta=data.activities.filter(a=>new Date(a.date).toDateString()===now.toDateString()).length;document.getElementById('meteoActVal').textContent=ta;document.getElementById('meteoAct').className='meteo-card '+(ta<=2?'good':ta<=4?'warning':'alert');
if(data.transactions.length>0){const inc=data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),exp=data.transactions.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0),rate=inc>0?Math.round(((inc-exp)/inc)*100):0;document.getElementById('meteoBudgetVal').textContent=rate+'%';document.getElementById('meteoBudget').className='meteo-card '+(rate>=20?'good':rate>=10?'warning':'alert')}
generateTips()}
function generateTips(){const tips=[],now=new Date(),h=now.getHours();const lr=data.lessons.filter(l=>{const d=Math.floor((now-new Date(l.date))/(1000*60*60*24));return d>=1&&d<=7});if(lr.length>0){const c=data.children.find(x=>x.id===lr[0].childId);tips.push('üìö '+(c?.name||'Votre enfant')+' devrait r√©viser "'+lr[0].title+'"')}const ta=data.activities.filter(a=>new Date(a.date).toDateString()===now.toDateString()).sort((a,b)=>a.time.localeCompare(b.time));if(ta.length>0){const nxt=ta.find(a=>a.time>`${h}:00`);if(nxt){const c=data.children.find(x=>x.id===nxt.childId);tips.push('üìÖ Prochain: '+nxt.title+' √† '+nxt.time+(c?' ('+c.name+')':''))}}if(data.transactions.length>0){const bc={};data.transactions.filter(t=>t.amount<0).forEach(t=>{bc[t.category||'other']=(bc[t.category||'other']||0)+Math.abs(t.amount)});if((bc.subscriptions||0)>100)tips.push('üí∞ '+Math.round(bc.subscriptions)+'‚Ç¨ d\'abos - v√©rifiez leur utilit√©')}if(h>=17&&h<=20&&data.children.filter(c=>c.age>=6).length>0)tips.push('‚è∞ C\'est l\'heure des devoirs !');if(tips.length===0)tips.push('‚ú® Tout va bien ! Profitez de votre journ√©e');document.getElementById('tipsContent').innerHTML=tips.slice(0,4).map(t=>'<div class="daily-tip">'+t+'</div>').join('')}

// BUDGET
function updateBudget(){const has=data.transactions.length>0;document.getElementById('importSection').style.display=has?'none':'block';document.getElementById('budgetDashboard').style.display=has?'block':'none';if(has){const inc=data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),exp=data.transactions.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0),bal=inc-exp;document.getElementById('totalIncome').textContent='+'+Math.round(inc)+'‚Ç¨';document.getElementById('totalExpenses').textContent='-'+Math.round(exp)+'‚Ç¨';document.getElementById('totalBalance').textContent=(bal>=0?'+':'')+Math.round(bal)+'‚Ç¨';document.getElementById('totalBalance').style.color=bal>=0?'var(--green)':'var(--red)';document.getElementById('savingsRate').textContent=inc>0?Math.round((bal/inc)*100)+'%':'0%';const bc={};data.transactions.filter(t=>t.amount<0).forEach(t=>{bc[t.category||'other']=(bc[t.category||'other']||0)+Math.abs(t.amount)});const sr=Object.entries(bc).sort((a,b)=>b[1]-a[1]).slice(0,5),mx=sr[0]?.[1]||1;document.getElementById('categoryBreakdown').innerHTML=sr.map(([c,a])=>{const ct=CATEGORIES[c]||CATEGORIES.other;return'<div class="category-item"><div class="category-emoji">'+ct.emoji+'</div><div class="category-info"><div class="category-name">'+ct.name+'</div><div class="category-bar"><div class="category-fill" style="width:'+(a/mx)*100+'%;background:'+ct.color+'"></div></div></div><div class="category-amount">'+Math.round(a)+'‚Ç¨</div></div>'}).join('');const rc=[...data.transactions].sort((a,b)=>(b.date||'').localeCompare(a.date||'')).slice(0,5);document.getElementById('recentTransactions').innerHTML=rc.map(t=>{const c=CATEGORIES[t.category]||CATEGORIES.other;return'<div class="transaction-item"><div class="category-emoji">'+c.emoji+'</div><div class="transaction-info"><div class="transaction-desc">'+t.description+'</div><div class="transaction-date">'+t.date+'</div></div><div class="transaction-amount '+(t.amount>0?'income':'expense')+'">'+(t.amount>0?'+':'')+t.amount.toFixed(0)+'‚Ç¨</div></div>'}).join('')}}
async function importBudget(f){document.getElementById('importSection').style.display='none';document.getElementById('loadingBudget').style.display='block';const r=new FileReader();r.onload=async e=>{const b=e.target.result.split(',')[1];try{const res=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:'Extrais transactions. JSON: {"transactions":[{"date":"DD/MM/YYYY","description":"Court","amount":123.45,"category":"salary|food|shopping|transport|housing|bills|entertainment|health|subscriptions|other"}]}',messages:[{role:'user',content:[{type:'document',source:{type:'base64',media_type:'application/pdf',data:b}},{type:'text',text:'JSON uniquement'}]}]})});document.getElementById('loadingBudget').style.display='none';if(res.ok){const j=await res.json(),m=j.content[0].text.match(/\{[\s\S]*\}/);if(m){const p=JSON.parse(m[0]);if(p.transactions?.length){data.transactions=p.transactions.map((t,i)=>({id:Date.now()+i,...t}));save();updateBudget();updateDashboard();notify('‚úÖ '+data.transactions.length+' transactions');return}}}showImportErr()}catch(e){showImportErr()}};r.readAsDataURL(f)}
function showImportErr(){document.getElementById('loadingBudget').style.display='none';document.getElementById('importSection').style.display='block';notify('‚ùå Erreur')}
function resetBudget(){if(confirm('Effacer?')){data.transactions=[];save();updateBudget();updateDashboard()}}

// OPTIMIZE
function updateOptimize(){if(data.transactions.length===0){document.getElementById('optimizeContent').innerHTML='<div class="empty-state"><div class="empty-icon">üìä</div><div>Importez un relev√©</div></div>';return}const inc=data.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),exp=data.transactions.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0),rate=inc>0?(inc-exp)/inc:0,bc={};data.transactions.filter(t=>t.amount<0).forEach(t=>{bc[t.category||'other']=(bc[t.category||'other']||0)+Math.abs(t.amount)});const score=Math.max(0,Math.min(100,Math.round(50+rate*40))),scl=score>=70?'good':score>=40?'warning':'bad';let al=[];if((bc.subscriptions||0)>80)al.push({type:'warning',icon:'üì±',title:Math.round(bc.subscriptions)+'‚Ç¨ abos',text:'V√©rifiez leur utilit√©'});if(rate<.1)al.push({type:'danger',icon:'üí∏',title:'√âpargne faible',text:Math.round(rate*100)+'%'});else if(rate>=.2)al.push({type:'success',icon:'üéâ',title:'Bravo!',text:Math.round(rate*100)+'% √©pargne'});if(data.children.length>0)al.push({type:'tip',icon:'üí°',title:'Astuce',text:'Livret jeune pour '+data.children.slice(0,2).map(c=>c.name).join(', ')});document.getElementById('optimizeContent').innerHTML='<div class="card"><div class="card-title">üìà Score</div><div class="score-circle '+scl+'"><div class="score-value">'+score+'</div><div class="score-label">/100</div></div></div>'+al.map(a=>'<div class="alert-card '+a.type+'"><div class="alert-icon">'+a.icon+'</div><div class="alert-content"><div class="alert-title">'+a.title+'</div><div class="alert-text">'+a.text+'</div></div></div>').join('')}

// PLANNING
function updatePlanning(){const t=new Date(),ws=new Date(t);ws.setDate(t.getDate()-t.getDay()+1);let wh='';for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(ws.getDate()+i);const it=d.toDateString()===t.toDateString(),is=d.toDateString()===selectedDate.toDateString(),he=data.activities.some(a=>new Date(a.date).toDateString()===d.toDateString());wh+='<div class="planning-day '+(is?'active':'')+' '+(it?'today':'')+' '+(he?'has-event':'')+'" onclick="selectDate(\''+d.toISOString()+'\')"><div class="planning-day-name">'+DAYS[d.getDay()]+'</div><div class="planning-day-num">'+d.getDate()+'</div></div>'}document.getElementById('planningWeek').innerHTML=wh;document.getElementById('dayTitle').textContent='üìã '+selectedDate.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});const da=data.activities.filter(a=>new Date(a.date).toDateString()===selectedDate.toDateString()).sort((a,b)=>a.time.localeCompare(b.time));document.getElementById('activitiesList').innerHTML=da.length?da.map(a=>{const c=data.children.find(x=>x.id===a.childId);return'<div class="activity-item '+(a.type==='revision'?'revision':'')+'" onclick="editActivity('+a.id+')"><div class="activity-time">'+a.time+'</div><div class="activity-info"><div class="activity-title">'+a.title+'</div><div class="activity-child">'+(c?c.avatar+' '+c.name:'')+'</div></div></div>'}).join(''):'<div class="empty-state" style="padding:1rem">Aucune activit√©</div>'}
function selectDate(iso){selectedDate=new Date(iso);updatePlanning()}
function openActivityModal(id=null){editingActivity=id?data.activities.find(a=>a.id===id):null;document.getElementById('activityModalTitle').textContent=editingActivity?'‚úèÔ∏è Modifier':'‚ûï Activit√©';document.getElementById('deleteActivityBtn').style.display=editingActivity?'block':'none';document.getElementById('activityTitleInput').value=editingActivity?.title||'';document.getElementById('activityTimeInput').value=editingActivity?.time||'14:00';document.getElementById('activityTypeInput').value=editingActivity?.type||'activity';document.getElementById('activityChildInput').innerHTML='<option value="">Famille</option>'+data.children.map(c=>'<option value="'+c.id+'" '+(editingActivity?.childId===c.id?'selected':'')+'>'+c.avatar+' '+c.name+'</option>').join('');openModal('activityModal')}
function editActivity(id){openActivityModal(id)}
function saveActivity(){const t=document.getElementById('activityTitleInput').value.trim();if(!t)return notify('‚ö†Ô∏è Titre requis');const a={id:editingActivity?.id||Date.now(),title:t,time:document.getElementById('activityTimeInput').value,childId:parseInt(document.getElementById('activityChildInput').value)||null,date:selectedDate.toISOString(),type:document.getElementById('activityTypeInput').value};if(editingActivity){const i=data.activities.findIndex(x=>x.id===editingActivity.id);if(i>=0)data.activities[i]=a}else data.activities.push(a);save();updatePlanning();updateDashboard();closeModal('activityModal');notify('‚úÖ OK')}
function deleteActivity(){if(!editingActivity)return;data.activities=data.activities.filter(a=>a.id!==editingActivity.id);save();updatePlanning();updateDashboard();closeModal('activityModal');notify('üóëÔ∏è Supprim√©')}

// HOMEWORK
function updateChildSelector(){document.getElementById('childDropdown').innerHTML=data.children.map(c=>'<div class="child-dropdown-item '+(currentChild?.id===c.id?'active':'')+'" onclick="selectChild('+c.id+')">'+c.avatar+' '+c.name+'</div>').join('');if(currentChild){document.getElementById('curAvatar').textContent=currentChild.avatar;document.getElementById('curName').textContent=currentChild.name}}
function selectChild(id){currentChild=data.children.find(c=>c.id===id);updateChildSelector();document.getElementById('childDropdown').classList.remove('show');conversationHistory=[];notify('üëã '+currentChild.name)}
function handleUpload(f){if(!f.type.startsWith('image/')&&f.type!=='application/pdf')return notify('‚ö†Ô∏è Format non support√©');uploadedFile=f;const r=new FileReader();r.onload=e=>{uploadedBase64=e.target.result;document.getElementById('uploadZone').style.display='none';document.getElementById('uploadPreview').style.display='block';document.getElementById('previewImg').src=f.type.startsWith('image/')?e.target.result:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><rect fill="%23C9856B" width="50" height="50" rx="8"/><text x="25" y="32" text-anchor="middle" fill="white" font-size="14">PDF</text></svg>'};r.readAsDataURL(f)}
function clearUpload(){uploadedFile=null;uploadedBase64=null;document.getElementById('uploadZone').style.display='block';document.getElementById('uploadPreview').style.display='none';document.getElementById('fileInput').value=''}
async function sendLesson(){const inp=document.getElementById('lessonInput'),msg=inp.value.trim();if(!msg&&!uploadedFile)return;inp.value='';const child=currentChild||data.children[0]||{name:'√âl√®ve',age:12,class:'5e',interests:''};let uc=[];if(uploadedBase64&&uploadedFile){const b=uploadedBase64.split(',')[1];uc.push(uploadedFile.type.startsWith('image/')?{type:'image',source:{type:'base64',media_type:uploadedFile.type,data:b}}:{type:'document',source:{type:'base64',media_type:'application/pdf',data:b}})}uc.push({type:'text',text:msg||'Analyse cette le√ßon.'});conversationHistory.push({role:'user',content:uc});document.getElementById('lessonContent').innerHTML='<div class="loading-container"><div class="loading-spinner"></div><div style="color:var(--sage)">ü§ñ Analyse pour '+child.name+'...</div></div>';
const sys=`Tu es un prof expert pour ${child.name} (${child.age} ans, ${child.class}). ${child.interests?'Int√©r√™ts: '+child.interests+'. Utilise-les!':''}
JAMAIS d'ast√©risques **. JSON uniquement:
{"title":"Titre","subject":"${selectedSubject||'general'}","summary":{"keyPoints":["Point 1","Point 2","Point 3"],"definitions":[{"term":"Mot","definition":"Def simple"}]},"mindmap":{"center":"Th√®me","branches":[{"icon":"üîµ","title":"Aspect 1","items":["d√©tail 1","d√©tail 2"]},{"icon":"üü¢","title":"Aspect 2","items":["d√©tail 1","d√©tail 2"]},{"icon":"üü†","title":"Aspect 3","items":["d√©tail 1","d√©tail 2"]}]},"quiz":[{"question":"Question pr√©cise?","answer":"R√©ponse compl√®te","options":["Bonne r√©ponse","Mauvaise plausible 1","Mauvaise plausible 2","Mauvaise plausible 3"],"hint":"Indice utile"}]}
IMPORTANT pour le quiz: les 4 options doivent √™tre CR√âDIBLES et li√©es au sujet!
Ex: "Capitale France?" ‚Üí ["Paris","Lyon","Marseille","Bordeaux"] ‚úì
Ex: "7x8?" ‚Üí ["56","54","48","63"] ‚úì
JAMAIS: ["R√©ponse","Je ne sais pas","Aucune","Autre"] ‚úó
G√©n√®re 5-6 questions vari√©es.`;
try{const res=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys,messages:conversationHistory})});if(res.ok){const r=await res.json(),reply=r.content[0].text;conversationHistory.push({role:'assistant',content:reply});try{const jm=reply.match(/\{[\s\S]*\}/);if(jm){const lesson=JSON.parse(jm[0]);currentLesson={...lesson,id:Date.now(),childId:child.id,date:new Date().toISOString(),subject:selectedSubject||lesson.subject||'general'};renderLesson(currentLesson)}else renderFallback(reply)}catch(e){renderFallback(reply)}}clearUpload()}catch(e){document.getElementById('lessonContent').innerHTML='<div class="empty-state"><div class="empty-icon">‚ùå</div><div>Erreur</div></div>'}}
function renderLesson(l){let h='';if(l.summary){h+='<div class="lesson-section"><div class="lesson-section-header summary" onclick="toggleSection(this)">üìù R√©sum√© <span class="toggle-icon">‚ñº</span></div><div class="lesson-section-content">'+(l.title?'<h3 style="color:var(--forest);margin-bottom:.5rem">'+l.title+'</h3>':'')+(l.summary.keyPoints?.map(p=>'<div class="key-point">'+p+'</div>').join('')||'')+(l.summary.definitions?.map(d=>'<div class="definition"><span class="definition-term">'+d.term+'</span>: '+d.definition+'</div>').join('')||'')+'</div></div>'}if(l.mindmap){h+='<div class="lesson-section"><div class="lesson-section-header mindmap" onclick="toggleSection(this)">üß† Carte mentale <span class="toggle-icon">‚ñº</span></div><div class="lesson-section-content"><div class="mindmap-center">'+l.mindmap.center+'</div>'+(l.mindmap.branches?.map(b=>'<div class="mindmap-branch"><div class="mindmap-branch-icon">'+b.icon+'</div><div class="mindmap-branch-content"><div class="mindmap-branch-title">'+b.title+'</div><ul class="mindmap-branch-items">'+b.items.map(i=>'<li>'+i+'</li>').join('')+'</ul></div></div>').join('')||'')+'</div></div>'}if(l.quiz?.length>0){quizQuestions=l.quiz.map(q=>({q:q.question,a:q.answer,correctAnswer:q.options[0],options:shuffle([...q.options]),hint:q.hint}));h+='<div class="lesson-section"><div class="lesson-section-header qa" onclick="toggleSection(this)">‚ùì Questions ('+l.quiz.length+') <span class="toggle-icon">‚ñº</span></div><div class="lesson-section-content">'+l.quiz.map((q,i)=>'<div class="qa-card"><div class="qa-question" onclick="toggleQA(this)"><span>'+(i+1)+'. '+q.question+'</span><span>‚ñº</span></div><div class="qa-answer"><div class="qa-answer-content">‚úÖ '+q.answer+'</div></div></div>').join('')+'</div></div>'}h+='<div class="lesson-actions"><button class="lesson-action-btn save" onclick="saveLesson()">üíæ Sauver</button><button class="lesson-action-btn quiz" onclick="startQuiz()">üéÆ Quiz</button><button class="lesson-action-btn plan" onclick="planRevision()">üìÖ Planifier</button></div>';document.getElementById('lessonContent').innerHTML=h}
function renderFallback(t){document.getElementById('lessonContent').innerHTML='<div class="card"><div class="card-title">üìö R√©ponse</div><div style="font-size:.9rem">'+t.replace(/\*\*/g,'').replace(/\n/g,'<br>')+'</div></div>'}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function toggleSection(el){el.nextElementSibling.classList.toggle('hidden')}
function toggleQA(el){el.nextElementSibling.classList.toggle('show')}
function saveLesson(){if(!currentLesson)return notify('‚ö†Ô∏è Rien √† sauver');const ex=data.lessons.findIndex(l=>l.id===currentLesson.id);if(ex>=0)data.lessons[ex]=currentLesson;else data.lessons.push(currentLesson);save();updateRevision();updateDashboard();notify('‚úÖ Sauvegard√©')}
function planRevision(){if(!currentLesson)return;if(!data.lessons.find(l=>l.id===currentLesson.id))saveLesson();const tom=new Date();tom.setDate(tom.getDate()+1);data.activities.push({id:Date.now(),title:'üìö '+currentLesson.title,date:tom.toISOString(),time:'18:00',childId:currentLesson.childId,type:'revision'});save();switchView('planning');notify('üìÖ Planifi√© demain')}

// QUIZ
function startQuiz(){if(quizQuestions.length===0)return notify('‚ö†Ô∏è Pas de questions');quizIndex=0;quizScore=0;quizAnswered=false;switchView('quiz');showQuizQ()}
function showQuizQ(){if(quizIndex>=quizQuestions.length){showQuizResults();return}const q=quizQuestions[quizIndex];quizAnswered=false;document.getElementById('quizProgress').innerHTML=quizQuestions.map((_,i)=>'<div class="progress-dot '+(i<quizIndex?'done':i===quizIndex?'current':'')+'"></div>').join('');document.getElementById('quizScoreDisplay').textContent='Score: '+quizScore+'/'+quizIndex;document.getElementById('quizContent').innerHTML='<div class="quiz-card"><div class="quiz-card-header" id="quizHeader"><div class="quiz-number">Question '+(quizIndex+1)+'/'+quizQuestions.length+'</div><div class="quiz-question-text">'+q.q+'</div></div><div class="quiz-card-body"><div class="quiz-options">'+q.options.map(o=>'<div class="quiz-option" data-value="'+o+'" onclick="selectOpt(this)">'+o+'</div>').join('')+'</div><div id="quizHint"></div><div id="quizExpl"></div></div></div><div class="quiz-actions"><button class="quiz-btn hint" onclick="showHint()">üí°</button><button class="quiz-btn check" onclick="checkAns()">‚úì</button><button class="quiz-btn next" onclick="nextQ()">‚Üí</button></div>'}
function selectOpt(el){if(quizAnswered)return;document.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));el.classList.add('selected')}
function checkAns(){if(quizAnswered)return;const sel=document.querySelector('.quiz-option.selected');if(!sel)return notify('Choisis!');quizAnswered=true;const q=quizQuestions[quizIndex],sv=sel.dataset.value,ic=sv===q.correctAnswer;document.querySelectorAll('.quiz-option').forEach(o=>{o.classList.add('disabled');if(o.dataset.value===q.correctAnswer)o.classList.add('correct');else if(o===sel&&!ic)o.classList.add('wrong')});const h=document.getElementById('quizHeader');if(ic){quizScore++;h.classList.add('correct');notify('üéâ Bravo!')}else{h.classList.add('wrong');document.getElementById('quizExpl').innerHTML='<div class="quiz-explanation">üìñ '+q.a+'</div>'}document.getElementById('quizScoreDisplay').textContent='Score: '+quizScore+'/'+(quizIndex+1)}
function nextQ(){quizIndex++;showQuizQ()}
function showHint(){document.getElementById('quizHint').innerHTML='<div class="quiz-hint">üí° '+(quizQuestions[quizIndex].hint||'R√©fl√©chis...')+'</div>'}
function showQuizResults(){const pct=Math.round((quizScore/quizQuestions.length)*100),emoji=pct>=80?'üèÜ':pct>=60?'üëç':'üí™';let txt=pct>=80?'Excellent!':pct>=60?'Bien jou√©!':'Continue!';if(currentChild)txt=pct>=80?'Bravo '+currentChild.name+'!':pct<60?'Courage '+currentChild.name+'!':txt;if(currentLesson){const idx=data.lessons.findIndex(l=>l.id===currentLesson.id);if(idx>=0){data.lessons[idx].lastQuizScore=pct;save()}}document.getElementById('quizContent').innerHTML='<div class="quiz-results"><div style="font-size:3rem">'+emoji+'</div><div class="quiz-results-score">'+quizScore+'/'+quizQuestions.length+'</div><div class="quiz-results-text">'+txt+'</div><button class="quiz-results-btn" onclick="restartQuiz()">üîÑ Recommencer</button><button class="quiz-results-btn" onclick="switchView(\'revision\')">üìÅ Le√ßons</button><button class="quiz-results-btn" onclick="switchView(\'dashboard\')">üè† Accueil</button></div>';document.getElementById('quizProgress').innerHTML=''}
function restartQuiz(){quizIndex=0;quizScore=0;quizAnswered=false;quizQuestions.forEach(q=>{q.options=shuffle([...q.options])});showQuizQ()}

// REVISION
function updateRevision(){document.getElementById('childFolders').innerHTML=data.children.map(c=>{const ct=data.lessons.filter(l=>l.childId===c.id).length;return'<div class="child-folder '+(selectedFolder?.id===c.id?'active':'')+'" onclick="selectFolder('+c.id+')"><div class="child-folder-avatar">'+c.avatar+'</div><div class="child-folder-name">'+c.name+'</div><div class="child-folder-count">'+ct+' le√ßon'+(ct>1?'s':'')+'</div></div>'}).join('');updateSavedLessons()}
function selectFolder(id){selectedFolder=data.children.find(c=>c.id===id);updateRevision()}
function updateSavedLessons(){const c=document.getElementById('savedLessons');if(!selectedFolder){c.innerHTML='<div class="empty-state"><div class="empty-icon">üìÅ</div><div>S√©lectionnez un enfant</div></div>';return}const ls=data.lessons.filter(l=>l.childId===selectedFolder.id).sort((a,b)=>new Date(b.date)-new Date(a.date));if(ls.length===0){c.innerHTML='<div class="empty-state"><div class="empty-icon">üìö</div><div>Aucune le√ßon</div><button class="lesson-action-btn quiz" style="margin-top:.5rem;max-width:150px" onclick="switchView(\'homework\')">‚úèÔ∏è Ajouter</button></div>';return}c.innerHTML=ls.map(l=>{const s=SUBJECTS[l.subject]||SUBJECTS.general,d=new Date(l.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short'});return'<div class="lesson-folder-card '+l.subject+'" onclick="openSavedLesson('+l.id+')"><div class="lesson-folder-header"><div><span class="lesson-folder-subject">'+s.emoji+' '+s.name+'</span><div class="lesson-folder-title">'+l.title+'</div></div><div class="lesson-folder-date">'+d+'</div></div><div class="lesson-folder-stats"><span>üß† '+(l.mindmap?.branches?.length||0)+'</span><span>‚ùì '+(l.quiz?.length||0)+'</span>'+(l.lastQuizScore!==undefined?'<span>üìä '+l.lastQuizScore+'%</span>':'')+'</div></div>'}).join('')}
function openSavedLesson(id){viewingLesson=data.lessons.find(l=>l.id===id);if(!viewingLesson)return;const s=SUBJECTS[viewingLesson.subject]||SUBJECTS.general;document.getElementById('lessonModalTitle').textContent=s.emoji+' '+viewingLesson.title;let h='';if(viewingLesson.summary){h+='<div style="margin-bottom:.8rem"><div style="font-weight:600;color:var(--forest);margin-bottom:.3rem">üìù Points cl√©s</div>'+(viewingLesson.summary.keyPoints?.map(p=>'<div class="key-point">'+p+'</div>').join('')||'')+'</div>'}if(viewingLesson.mindmap){h+='<div style="margin-bottom:.8rem"><div style="font-weight:600;color:var(--purple);margin-bottom:.3rem">üß† Carte mentale</div><div class="mindmap-center" style="font-size:.8rem;padding:.4rem">'+viewingLesson.mindmap.center+'</div>'+(viewingLesson.mindmap.branches?.map(b=>'<div style="display:flex;gap:.3rem;font-size:.8rem;margin:.2rem 0"><span>'+b.icon+'</span><strong>'+b.title+':</strong><span style="color:var(--sage)">'+b.items.join(', ')+'</span></div>').join('')||'')+'</div>'}if(viewingLesson.lastQuizScore!==undefined)h+='<div style="text-align:center;padding:.5rem;background:var(--cream);border-radius:8px"><div style="font-size:.7rem;color:var(--sage)">Dernier score</div><div style="font-size:1.3rem;font-weight:600;color:var(--forest)">'+viewingLesson.lastQuizScore+'%</div></div>';document.getElementById('lessonModalContent').innerHTML=h;openModal('lessonModal')}
function startSavedQuiz(){if(!viewingLesson||!viewingLesson.quiz)return notify('‚ö†Ô∏è Pas de quiz');closeModal('lessonModal');currentLesson=viewingLesson;quizQuestions=viewingLesson.quiz.map(q=>({q:q.question,a:q.answer,correctAnswer:q.options[0],options:shuffle([...q.options]),hint:q.hint}));quizIndex=0;quizScore=0;quizAnswered=false;switchView('quiz');showQuizQ()}

// CHILDREN
function updateChildrenList(){document.getElementById('childrenList').innerHTML=data.children.map(c=>{const lc=data.lessons.filter(l=>l.childId===c.id).length;return'<div class="child-card"><div class="child-avatar-lg">'+c.avatar+'</div><div class="child-info"><div class="child-name">'+c.name+'</div><div class="child-details">'+c.age+' ans ‚Ä¢ '+c.class+' ‚Ä¢ '+lc+' le√ßons'+(c.interests?' ‚Ä¢ '+c.interests:'')+'</div></div><button class="child-edit" onclick="editChild('+c.id+')">‚úèÔ∏è</button></div>'}).join('')||'<div style="color:var(--sage)">Aucun enfant</div>'}
function openChildModal(id=null){editingChild=id?data.children.find(c=>c.id===id):null;document.getElementById('childModalTitle').textContent=editingChild?'‚úèÔ∏è Modifier':'‚ûï Enfant';document.getElementById('deleteChildBtn').style.display=editingChild?'block':'none';document.getElementById('childNameInput').value=editingChild?.name||'';document.getElementById('childAgeInput').value=editingChild?.age||'';document.getElementById('childClassInput').value=editingChild?.class||'4e';document.getElementById('childInterestsInput').value=editingChild?.interests||'';document.querySelectorAll('.avatar-option').forEach(a=>a.classList.toggle('selected',a.dataset.avatar===(editingChild?.avatar||'üë¶')));openModal('childModal')}
function editChild(id){openChildModal(id)}
function saveChild(){const n=document.getElementById('childNameInput').value.trim(),a=parseInt(document.getElementById('childAgeInput').value);if(!n||!a)return notify('‚ö†Ô∏è Requis');const c={id:editingChild?.id||Date.now(),name:n,age:a,class:document.getElementById('childClassInput').value,interests:document.getElementById('childInterestsInput').value.trim(),avatar:document.querySelector('.avatar-option.selected')?.dataset.avatar||'üë¶'};if(editingChild){const i=data.children.findIndex(x=>x.id===editingChild.id);if(i>=0)data.children[i]=c}else data.children.push(c);if(!currentChild)currentChild=c;if(!selectedFolder)selectedFolder=c;save();updateAll();closeModal('childModal');notify('‚úÖ OK')}
function deleteChild(){if(!editingChild||!confirm('Supprimer '+editingChild.name+'?'))return;data.children=data.children.filter(c=>c.id!==editingChild.id);data.lessons=data.lessons.filter(l=>l.childId!==editingChild.id);data.activities=data.activities.filter(a=>a.childId!==editingChild.id);if(currentChild?.id===editingChild.id)currentChild=data.children[0]||null;if(selectedFolder?.id===editingChild.id)selectedFolder=data.children[0]||null;save();updateAll();closeModal('childModal');notify('üóëÔ∏è Supprim√©')}

// UTILS
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function notify(m){const n=document.createElement('div');n.className='notification';n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.remove(),2500)}
function resetAll(){if(confirm('Tout r√©initialiser?')){localStorage.removeItem('familyflow_v10');location.reload()}}
init();
</script>
</body>
</html>
