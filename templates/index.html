<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow - Assistant Familial IA ‚ú®</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #FAF7F2;
            --sand: #E8DCC4;
            --terracotta: #C9856B;
            --terracotta-dark: #B8754A;
            --forest: #5F7161;
            --sage: #8B9D83;
            --midnight: #2C3333;
            --white: #FFFFFF;
            --red: #E74C3C;
            --green: #27AE60;
            --blue: #3498DB;
            --purple: #9B59B6;
            --orange: #E67E22;
            --yellow: #F1C40F;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F0EDE5 100%);
            color: var(--midnight);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--forest) 0%, var(--sage) 100%);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--white);
            font-weight: 600;
            font-style: italic;
        }
        
        .tagline { color: var(--sand); font-size: 0.8rem; font-weight: 300; }
        
        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.4rem 0.8rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--sage);
            font-size: 0.7rem;
            transition: all 0.3s;
        }
        
        .nav-item.active { color: var(--forest); }
        .nav-item .nav-icon { font-size: 1.4rem; margin-bottom: 0.2rem; }
        .nav-item.active .nav-icon { transform: scale(1.1); }
        
        /* CONTAINER */
        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* CARDS */
        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: var(--forest);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* IMPORT */
        .import-zone {
            border: 3px dashed var(--sand);
            border-radius: 15px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--white);
        }
        
        .import-zone:hover, .import-zone.dragover {
            border-color: var(--forest);
            background: rgba(95, 113, 97, 0.05);
        }
        
        .import-icon { font-size: 3rem; margin-bottom: 0.5rem; }
        .import-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--forest); }
        .import-text { color: var(--sage); font-size: 0.85rem; margin-top: 0.3rem; }
        
        /* LOADING */
        .loading-container { text-align: center; padding: 2rem; }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--sand);
            border-top-color: var(--forest);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--sage); font-size: 0.9rem; }
        
        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        }
        
        .stat-card.income { border-left: 3px solid var(--green); }
        .stat-card.expense { border-left: 3px solid var(--terracotta); }
        .stat-card.balance { border-left: 3px solid var(--blue); }
        .stat-card.savings { border-left: 3px solid var(--purple); }
        
        .stat-icon { font-size: 1.5rem; }
        .stat-value { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 600; }
        .stat-label { font-size: 0.7rem; color: var(--sage); }
        
        /* CATEGORY BREAKDOWN */
        .category-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--cream);
        }
        .category-item:last-child { border-bottom: none; }
        .category-emoji { font-size: 1.2rem; width: 30px; text-align: center; }
        .category-info { flex: 1; }
        .category-name { font-size: 0.85rem; font-weight: 500; }
        .category-bar { height: 6px; background: var(--cream); border-radius: 3px; margin-top: 0.3rem; overflow: hidden; }
        .category-fill { height: 100%; border-radius: 3px; }
        .category-amount { font-weight: 600; font-size: 0.9rem; }
        .category-percent { font-size: 0.7rem; color: var(--sage); }
        
        /* TRANSACTION LIST */
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem;
            background: var(--cream);
            border-radius: 10px;
            margin-bottom: 0.4rem;
            cursor: pointer;
        }
        .transaction-item:hover { background: var(--sand); }
        .transaction-emoji { font-size: 1.1rem; }
        .transaction-info { flex: 1; min-width: 0; }
        .transaction-desc { font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-date { font-size: 0.7rem; color: var(--sage); }
        .transaction-amount { font-weight: 600; font-size: 0.9rem; }
        .transaction-amount.income { color: var(--green); }
        .transaction-amount.expense { color: var(--terracotta); }
        
        /* ALERTS & TIPS */
        .alert-card {
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }
        
        .alert-card.warning { background: linear-gradient(135deg, #FFF3E0, #FFE0B2); border-left: 4px solid var(--orange); }
        .alert-card.danger { background: linear-gradient(135deg, #FFEBEE, #FFCDD2); border-left: 4px solid var(--red); }
        .alert-card.success { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-left: 4px solid var(--green); }
        .alert-card.info { background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-left: 4px solid var(--blue); }
        .alert-card.tip { background: linear-gradient(135deg, var(--forest), var(--sage)); color: var(--white); }
        
        .alert-icon { font-size: 1.5rem; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.2rem; }
        .alert-text { font-size: 0.8rem; opacity: 0.9; line-height: 1.4; }
        .alert-action { font-size: 0.75rem; margin-top: 0.4rem; color: var(--terracotta); font-weight: 600; cursor: pointer; }
        .alert-card.tip .alert-action { color: var(--sand); }
        
        /* BUDGET PLAN */
        .budget-item {
            background: var(--cream);
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 0.6rem;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .budget-category { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .budget-amounts { text-align: right; }
        .budget-spent { font-weight: 600; font-size: 0.9rem; }
        .budget-limit { font-size: 0.75rem; color: var(--sage); }
        
        .budget-bar { height: 8px; background: var(--sand); border-radius: 4px; overflow: hidden; }
        .budget-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .budget-fill.ok { background: var(--green); }
        .budget-fill.warning { background: var(--orange); }
        .budget-fill.danger { background: var(--red); }
        
        .budget-status { font-size: 0.75rem; margin-top: 0.3rem; }
        .budget-status.ok { color: var(--green); }
        .budget-status.warning { color: var(--orange); }
        .budget-status.danger { color: var(--red); }
        
        /* EDIT BUDGET */
        .edit-budget-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            width: 100%;
            padding: 0.6rem;
            border: 2px dashed var(--sand);
            border-radius: 10px;
            background: none;
            color: var(--sage);
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        .edit-budget-btn:hover { border-color: var(--forest); color: var(--forest); }
        
        /* CHAT */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            max-height: 500px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message {
            max-width: 85%;
            padding: 0.7rem 0.9rem;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .message.user {
            background: var(--forest);
            color: var(--white);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            background: var(--cream);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            padding: 0.5rem;
        }
        
        .suggestion-btn {
            padding: 0.4rem 0.7rem;
            border: 2px solid var(--sand);
            border-radius: 15px;
            background: var(--white);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .suggestion-btn:hover { border-color: var(--forest); background: var(--cream); }
        
        .chat-input-container {
            display: flex;
            gap: 0.4rem;
            padding: 0.5rem;
            background: var(--cream);
            border-radius: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
        }
        .chat-input:focus { outline: none; }
        
        .chat-send {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--forest), var(--sage));
            color: var(--white);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* HOMEWORK */
        .child-tabs {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1rem;
            overflow-x: auto;
        }
        
        .child-tab {
            padding: 0.5rem 0.8rem;
            border: 2px solid var(--sand);
            border-radius: 20px;
            background: var(--white);
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .child-tab.active { background: var(--forest); border-color: var(--forest); color: var(--white); }
        
        .mode-toggle {
            display: flex;
            background: var(--cream);
            border-radius: 10px;
            padding: 0.3rem;
            margin-bottom: 1rem;
        }
        
        .mode-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            background: none;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-btn.active { background: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .upload-zone {
            border: 2px dashed var(--sand);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--sage);
            margin-bottom: 0.5rem;
        }
        .upload-zone:hover { border-color: var(--forest); }
        
        .upload-preview {
            position: relative;
            padding: 0.5rem;
            background: var(--cream);
            border-radius: 10px;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .upload-preview img { max-width: 100%; max-height: 100px; border-radius: 6px; }
        .remove-upload {
            position: absolute;
            top: 3px; right: 3px;
            width: 20px; height: 20px;
            border-radius: 50%;
            border: none;
            background: var(--red);
            color: white;
            cursor: pointer;
            font-size: 0.7rem;
        }
        
        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal {
            background: var(--white);
            border-radius: 15px;
            padding: 1.2rem;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        
        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--forest);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .form-group { margin-bottom: 0.7rem; }
        .form-label { display: block; font-size: 0.75rem; color: var(--sage); margin-bottom: 0.2rem; }
        .form-input, .form-select {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--forest); }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
        }
        
        .category-option {
            padding: 0.5rem 0.3rem;
            border: 2px solid var(--sand);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s;
        }
        .category-option:hover { border-color: var(--terracotta); }
        .category-option.active { background: var(--terracotta); border-color: var(--terracotta); color: var(--white); }
        .category-option .cat-emoji { display: block; font-size: 1.1rem; margin-bottom: 0.1rem; }
        
        .modal-buttons {
            display: flex;
            gap: 0.6rem;
            margin-top: 1rem;
        }
        
        .modal-btn {
            flex: 1;
            padding: 0.7rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-cancel { background: var(--sand); color: var(--midnight); }
        .btn-save { background: linear-gradient(135deg, var(--forest), var(--sage)); color: var(--white); }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--sage);
        }
        .empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .empty-text { font-size: 0.85rem; }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 10px; right: 10px;
            background: linear-gradient(135deg, var(--forest), var(--sage));
            color: var(--white);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(95, 113, 97, 0.4);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            font-size: 0.85rem;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* LOADING DOTS */
        .loading-dots { display: flex; gap: 0.2rem; padding: 0.5rem; }
        .loading-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--sage);
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* TABS */
        .filter-tabs {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.8rem;
        }
        .filter-tab {
            padding: 0.4rem 0.7rem;
            border: none;
            border-radius: 15px;
            background: var(--sand);
            font-size: 0.75rem;
            cursor: pointer;
        }
        .filter-tab.active { background: var(--forest); color: var(--white); }
        
        /* SCORE */
        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.8rem;
        }
        .score-circle.good { background: linear-gradient(135deg, var(--green), #2ECC71); }
        .score-circle.warning { background: linear-gradient(135deg, var(--orange), #F39C12); }
        .score-circle.bad { background: linear-gradient(135deg, var(--red), #C0392B); }
        .score-value { font-size: 1.5rem; font-weight: 700; color: white; }
        .score-label { font-size: 0.6rem; color: rgba(255,255,255,0.8); }
        
        .reset-btn {
            display: block;
            width: 100%;
            padding: 0.6rem;
            border: 2px dashed var(--sand);
            border-radius: 8px;
            background: none;
            color: var(--sage);
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 1rem;
        }
        .reset-btn:hover { border-color: var(--terracotta); color: var(--terracotta); }
    </style>
</head>
<body>
    <header>
        <h1>üåä FamilyFlow</h1>
        <p class="tagline">Votre assistant familial intelligent</p>
    </header>
    
    <!-- VIEWS -->
    <div class="container">
        <!-- BUDGET VIEW -->
        <div class="view active" id="budget-view">
            <div class="import-zone" id="importZone">
                <div class="import-icon">üìÑ</div>
                <div class="import-title">Importer votre relev√©</div>
                <div class="import-text">Glissez un PDF ou cliquez</div>
                <input type="file" id="importInput" accept=".pdf,.csv" style="display: none;">
            </div>
            
            <div class="loading-container" id="loadingContainer" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">ü§ñ Analyse en cours...</div>
            </div>
            
            <div id="dashboardContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-icon">üì•</div>
                        <div class="stat-value" id="totalIncome">0‚Ç¨</div>
                        <div class="stat-label">Revenus</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-icon">üí≥</div>
                        <div class="stat-value" id="totalExpenses">0‚Ç¨</div>
                        <div class="stat-label">D√©penses</div>
                    </div>
                    <div class="stat-card balance">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalBalance">0‚Ç¨</div>
                        <div class="stat-label">Solde</div>
                    </div>
                    <div class="stat-card savings">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="savingsRate">0%</div>
                        <div class="stat-label">√âpargne</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">üìä R√©partition</div>
                    <div id="categoryBreakdown"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">üìã Derni√®res transactions</div>
                    <div id="recentTransactions"></div>
                    <button class="edit-budget-btn" onclick="switchView('transactions')">Voir tout ‚Üí</button>
                </div>
                
                <button class="reset-btn" onclick="resetData()">üîÑ Importer un autre relev√©</button>
            </div>
        </div>
        
        <!-- OPTIMIZATION VIEW -->
        <div class="view" id="optimize-view">
            <div id="optimizeContent">
                <div class="empty-state" id="optimizeEmpty">
                    <div class="empty-icon">üìä</div>
                    <div class="empty-text">Importez un relev√© pour voir les optimisations</div>
                </div>
            </div>
        </div>
        
        <!-- PLAN VIEW -->
        <div class="view" id="plan-view">
            <div id="planContent">
                <div class="empty-state" id="planEmpty">
                    <div class="empty-icon">üéØ</div>
                    <div class="empty-text">Importez un relev√© pour cr√©er votre plan budget</div>
                </div>
            </div>
        </div>
        
        <!-- AI ASSISTANT VIEW -->
        <div class="view" id="assistant-view">
            <div class="card chat-container">
                <div class="chat-messages" id="budgetChatMessages">
                    <div class="message assistant">
                        üëã Bonjour ! Je suis votre assistant budget. Importez un relev√© bancaire puis posez-moi vos questions !
                        <br><br>
                        Je peux vous aider √† :
                        <br>‚Ä¢ Analyser vos d√©penses
                        <br>‚Ä¢ Trouver des √©conomies
                        <br>‚Ä¢ Cr√©er un plan budget
                    </div>
                </div>
                
                <div class="chat-suggestions" id="budgetSuggestions">
                    <button class="suggestion-btn" onclick="askBudgetQuestion('Comment r√©duire mes d√©penses ?')">üí° R√©duire mes d√©penses</button>
                    <button class="suggestion-btn" onclick="askBudgetQuestion('Analyse mes abonnements')">üì± Mes abonnements</button>
                    <button class="suggestion-btn" onclick="askBudgetQuestion('Cr√©e-moi un plan budget')">üéØ Plan budget</button>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="budgetChatInput" placeholder="Posez votre question...">
                    <button class="chat-send" id="budgetChatSend">Envoyer</button>
                </div>
            </div>
        </div>
        
        <!-- HOMEWORK VIEW -->
        <div class="view" id="homework-view">
            <div class="child-tabs">
                <button class="child-tab active" data-child="gauthier">üë¶ Gauthier (4e)</button>
                <button class="child-tab" data-child="charles">üßí Charles (6e)</button>
                <button class="child-tab" data-child="victoire">üëß Victoire (CE1)</button>
            </div>
            
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="parent">üë®‚Äçüë©‚Äçüëß Parent</button>
                <button class="mode-btn" data-mode="child">üéÆ Enfant</button>
            </div>
            
            <div class="card chat-container">
                <div class="chat-messages" id="homeworkChatMessages">
                    <div class="message assistant">
                        üìö Bienvenue ! Uploadez une photo de le√ßon ou posez une question pour commencer.
                    </div>
                </div>
                
                <div class="upload-zone" id="uploadZone">
                    üìé Ajouter une photo ou PDF
                    <input type="file" id="fileInput" accept="image/*,.pdf" style="display: none;">
                </div>
                <div class="upload-preview" id="uploadPreview" style="display: none;">
                    <img id="previewImage" src="">
                    <button class="remove-upload" id="removeUpload">‚úï</button>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="homeworkChatInput" placeholder="Posez une question...">
                    <button class="chat-send" id="homeworkChatSend">Envoyer</button>
                </div>
            </div>
        </div>
        
        <!-- TRANSACTIONS VIEW -->
        <div class="view" id="transactions-view">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">Tout</button>
                <button class="filter-tab" data-filter="income">üì• Revenus</button>
                <button class="filter-tab" data-filter="expense">üí≥ D√©penses</button>
            </div>
            <div class="card">
                <div id="allTransactions"></div>
            </div>
        </div>
    </div>
    
    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="budget">
            <span class="nav-icon">üí∞</span>
            Budget
        </button>
        <button class="nav-item" data-view="optimize">
            <span class="nav-icon">üéØ</span>
            Optimiser
        </button>
        <button class="nav-item" data-view="plan">
            <span class="nav-icon">üìÖ</span>
            Plan
        </button>
        <button class="nav-item" data-view="assistant">
            <span class="nav-icon">ü§ñ</span>
            Assistant
        </button>
        <button class="nav-item" data-view="homework">
            <span class="nav-icon">üìö</span>
            Devoirs
        </button>
    </nav>
    
    <!-- EDIT MODAL -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-title">‚úèÔ∏è Modifier</div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="editDesc">
            </div>
            <div class="form-group">
                <label class="form-label">Cat√©gorie</label>
                <div class="category-grid" id="categorySelect"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" id="cancelEdit">Annuler</button>
                <button class="modal-btn btn-save" id="saveEdit">OK</button>
            </div>
        </div>
    </div>
    
    <!-- BUDGET MODAL -->
    <div class="modal-overlay" id="budgetModal">
        <div class="modal">
            <div class="modal-title">üéØ D√©finir un budget</div>
            <div class="form-group">
                <label class="form-label">Cat√©gorie</label>
                <select class="form-select" id="budgetCategory"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Budget mensuel (‚Ç¨)</label>
                <input type="number" class="form-input" id="budgetAmount" placeholder="100">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" id="cancelBudget">Annuler</button>
                <button class="modal-btn btn-save" id="saveBudget">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ============ CATEGORIES ============
        const CATEGORIES = {
            shopping: { emoji: 'üõí', name: 'Shopping', color: '#E74C3C' },
            food: { emoji: 'üçï', name: 'Alimentation', color: '#E67E22' },
            transport: { emoji: 'üöó', name: 'Transport', color: '#3498DB' },
            housing: { emoji: 'üè†', name: 'Logement', color: '#9B59B6' },
            bills: { emoji: 'üìÑ', name: 'Factures', color: '#8E44AD' },
            entertainment: { emoji: 'üé¨', name: 'Loisirs', color: '#1ABC9C' },
            health: { emoji: 'üíä', name: 'Sant√©/Beaut√©', color: '#E91E63' },
            subscriptions: { emoji: 'üì±', name: 'Abonnements', color: '#00BCD4' },
            insurance: { emoji: 'üõ°Ô∏è', name: 'Assurance', color: '#607D8B' },
            salary: { emoji: 'üíº', name: 'Revenus', color: '#27AE60' },
            transfer: { emoji: 'üîÑ', name: 'Virement', color: '#95A5A6' },
            other: { emoji: 'üì¶', name: 'Autre', color: '#7F8C8D' }
        };

        // ============ DATA ============
        let data = {
            transactions: [],
            budgets: {},
            period: ''
        };
        
        let currentFilter = 'all';
        let editingTransaction = null;
        let currentMode = 'parent';
        let currentChild = { name: 'Gauthier', level: '4√®me' };
        let homeworkHistory = [];
        let budgetChatHistory = [];
        let uploadedFile = null;
        let uploadedFileBase64 = null;

        // ============ INIT ============
        function init() {
            loadData();
            setupEventListeners();
            updateAllViews();
        }

        function loadData() {
            const saved = localStorage.getItem('familyflow_v4');
            if (saved) data = { ...data, ...JSON.parse(saved) };
        }

        function saveData() {
            localStorage.setItem('familyflow_v4', JSON.stringify(data));
        }

        // ============ EVENT LISTENERS ============
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchView(item.dataset.view));
            });

            // Import
            const importZone = document.getElementById('importZone');
            importZone.addEventListener('click', () => document.getElementById('importInput').click());
            document.getElementById('importInput').addEventListener('change', handleImport);
            importZone.addEventListener('dragover', (e) => { e.preventDefault(); importZone.classList.add('dragover'); });
            importZone.addEventListener('dragleave', () => importZone.classList.remove('dragover'));
            importZone.addEventListener('drop', (e) => {
                e.preventDefault();
                importZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleImportFile(e.dataTransfer.files[0]);
            });

            // Filters
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    renderAllTransactions();
                });
            });

            // Edit modal
            document.getElementById('cancelEdit').addEventListener('click', () => closeModal('editModal'));
            document.getElementById('saveEdit').addEventListener('click', saveEdit);
            
            // Budget modal
            document.getElementById('cancelBudget').addEventListener('click', () => closeModal('budgetModal'));
            document.getElementById('saveBudget').addEventListener('click', saveBudgetLimit);

            // Budget chat
            document.getElementById('budgetChatSend').addEventListener('click', sendBudgetMessage);
            document.getElementById('budgetChatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendBudgetMessage();
            });

            // Homework
            document.querySelectorAll('.child-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.child-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const children = {
                        gauthier: { name: 'Gauthier', level: '4√®me' },
                        charles: { name: 'Charles', level: '6√®me' },
                        victoire: { name: 'Victoire', level: 'CE1' }
                    };
                    currentChild = children[tab.dataset.child];
                });
            });

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                });
            });

            document.getElementById('homeworkChatSend').addEventListener('click', sendHomeworkMessage);
            document.getElementById('homeworkChatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendHomeworkMessage();
            });

            // File upload
            document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
            });
            document.getElementById('removeUpload').addEventListener('click', clearUpload);
            
            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(m => {
                m.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) closeModal(m.id);
                });
            });
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');
        }

        // ============ IMPORT ============
        function handleImport(e) {
            if (e.target.files.length > 0) handleImportFile(e.target.files[0]);
        }

        async function handleImportFile(file) {
            document.getElementById('importZone').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                
                try {
                    const response = await fetch('/api/claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            system: `Tu es un expert en analyse de relev√©s bancaires. Extrais TOUTES les transactions et cat√©gorise-les.

RETOURNE UNIQUEMENT CE JSON (sans texte avant/apr√®s):
{
  "period": "D√©cembre 2025",
  "transactions": [
    {"date": "02/12/2025", "description": "Description courte", "amount": 2366.77, "category": "salary"}
  ]
}

R√®gles:
- REVENUS = montant POSITIF (salaires, remboursements)
- D√âPENSES = montant N√âGATIF
- Cat√©gories: shopping, food, transport, housing, bills, entertainment, health, subscriptions, insurance, salary, transfer, other
- Simplifie les descriptions (ex: "CB AMAZON PAYMENTS" ‚Üí "Amazon")`,
                            messages: [{
                                role: 'user',
                                content: [
                                    { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64Data } },
                                    { type: 'text', text: 'Analyse ce relev√©. Retourne uniquement le JSON.' }
                                ]
                            }]
                        })
                    });

                    document.getElementById('loadingContainer').style.display = 'none';

                    if (response.ok) {
                        const result = await response.json();
                        const jsonMatch = result.content[0].text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsed = JSON.parse(jsonMatch[0]);
                            if (parsed.transactions?.length > 0) {
                                data.transactions = parsed.transactions.map((t, i) => ({ id: Date.now() + i, ...t }));
                                data.period = parsed.period || '';
                                saveData();
                                updateAllViews();
                                notify(`‚úÖ ${data.transactions.length} transactions import√©es !`);
                                return;
                            }
                        }
                    }
                    showImportError();
                } catch (err) {
                    console.error(err);
                    showImportError();
                }
            };
            reader.readAsDataURL(file);
        }

        function showImportError() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('importZone').style.display = 'block';
            notify('‚ùå Erreur d\'import');
        }

        function resetData() {
            if (confirm('Effacer et importer un nouveau relev√© ?')) {
                data = { transactions: [], budgets: {}, period: '' };
                saveData();
                updateAllViews();
            }
        }

        // ============ UPDATE ALL VIEWS ============
        function updateAllViews() {
            const hasData = data.transactions.length > 0;
            
            // Budget view
            document.getElementById('importZone').style.display = hasData ? 'none' : 'block';
            document.getElementById('dashboardContent').style.display = hasData ? 'block' : 'none';
            
            // Other views
            document.getElementById('optimizeEmpty').style.display = hasData ? 'none' : 'block';
            document.getElementById('planEmpty').style.display = hasData ? 'none' : 'block';
            
            if (hasData) {
                updateDashboard();
                updateOptimizations();
                updatePlan();
                renderAllTransactions();
            }
        }

        // ============ DASHBOARD ============
        function updateDashboard() {
            const income = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const expenses = data.transactions.filter(t => t.amount < 0).reduce((s, t) => s + Math.abs(t.amount), 0);
            const balance = income - expenses;
            const savingsRate = income > 0 ? Math.round((balance / income) * 100) : 0;
            
            document.getElementById('totalIncome').textContent = '+' + Math.round(income) + '‚Ç¨';
            document.getElementById('totalExpenses').textContent = '-' + Math.round(expenses) + '‚Ç¨';
            document.getElementById('totalBalance').textContent = (balance >= 0 ? '+' : '') + Math.round(balance) + '‚Ç¨';
            document.getElementById('totalBalance').style.color = balance >= 0 ? 'var(--green)' : 'var(--red)';
            document.getElementById('savingsRate').textContent = savingsRate + '%';
            document.getElementById('savingsRate').style.color = savingsRate >= 20 ? 'var(--green)' : savingsRate >= 0 ? 'var(--orange)' : 'var(--red)';
            
            // Category breakdown
            const byCategory = {};
            data.transactions.filter(t => t.amount < 0).forEach(t => {
                byCategory[t.category || 'other'] = (byCategory[t.category || 'other'] || 0) + Math.abs(t.amount);
            });
            
            const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const total = Object.values(byCategory).reduce((s, v) => s + v, 0);
            const max = sorted[0]?.[1] || 1;
            
            document.getElementById('categoryBreakdown').innerHTML = sorted.map(([cat, amount]) => {
                const c = CATEGORIES[cat] || CATEGORIES.other;
                return `
                    <div class="category-item">
                        <div class="category-emoji">${c.emoji}</div>
                        <div class="category-info">
                            <div class="category-name">${c.name}</div>
                            <div class="category-bar"><div class="category-fill" style="width:${(amount/max)*100}%;background:${c.color}"></div></div>
                        </div>
                        <div>
                            <div class="category-amount">${Math.round(amount)}‚Ç¨</div>
                            <div class="category-percent">${Math.round((amount/total)*100)}%</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Recent transactions
            const recent = [...data.transactions].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 5);
            document.getElementById('recentTransactions').innerHTML = recent.map(t => transactionHTML(t)).join('');
        }

        function transactionHTML(t) {
            const isIncome = t.amount > 0;
            const c = CATEGORIES[t.category] || CATEGORIES.other;
            return `
                <div class="transaction-item" onclick="openEditModal(${t.id})">
                    <div class="transaction-emoji">${c.emoji}</div>
                    <div class="transaction-info">
                        <div class="transaction-desc">${t.description}</div>
                        <div class="transaction-date">${t.date}</div>
                    </div>
                    <div class="transaction-amount ${isIncome ? 'income' : 'expense'}">${isIncome ? '+' : ''}${t.amount.toFixed(0)}‚Ç¨</div>
                </div>
            `;
        }

        // ============ OPTIMIZATIONS ============
        function updateOptimizations() {
            const expenses = data.transactions.filter(t => t.amount < 0);
            const income = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const totalExpenses = expenses.reduce((s, t) => s + Math.abs(t.amount), 0);
            
            const byCategory = {};
            expenses.forEach(t => {
                byCategory[t.category || 'other'] = (byCategory[t.category || 'other'] || 0) + Math.abs(t.amount);
            });
            
            // Calculate score
            const savingsRate = income > 0 ? (income - totalExpenses) / income : 0;
            const subscriptionRatio = (byCategory.subscriptions || 0) / totalExpenses;
            let score = Math.round(50 + savingsRate * 30 - subscriptionRatio * 20);
            score = Math.max(0, Math.min(100, score));
            
            let alerts = [];
            
            // Subscriptions analysis
            const subs = expenses.filter(t => t.category === 'subscriptions');
            const subTotal = subs.reduce((s, t) => s + Math.abs(t.amount), 0);
            if (subTotal > 100) {
                alerts.push({
                    type: 'warning',
                    icon: 'üì±',
                    title: `${Math.round(subTotal)}‚Ç¨ d'abonnements`,
                    text: `${subs.length} abonnements d√©tect√©s. V√©rifiez si vous les utilisez tous.`,
                    action: 'Voir le d√©tail'
                });
            }
            
            // Detect potential duplicates (similar subscriptions)
            const subNames = subs.map(s => s.description.toLowerCase());
            if (subNames.some(n => n.includes('music')) && subNames.filter(n => n.includes('music') || n.includes('spotify') || n.includes('deezer')).length > 1) {
                alerts.push({
                    type: 'danger',
                    icon: '‚ö†Ô∏è',
                    title: 'Doublons d√©tect√©s ?',
                    text: 'Plusieurs services de musique d√©tect√©s. Un seul pourrait suffire.',
                    action: '√âconomie potentielle: ~10‚Ç¨/mois'
                });
            }
            
            // High shopping
            if (byCategory.shopping && byCategory.shopping > totalExpenses * 0.3) {
                alerts.push({
                    type: 'warning',
                    icon: 'üõí',
                    title: 'Shopping √©lev√©',
                    text: `${Math.round((byCategory.shopping/totalExpenses)*100)}% de vos d√©penses. Fixez-vous un budget max.`,
                    action: 'D√©finir un budget'
                });
            }
            
            // Savings tip
            if (savingsRate < 0.1) {
                alerts.push({
                    type: 'danger',
                    icon: 'üí∏',
                    title: '√âpargne faible',
                    text: `Taux d'√©pargne: ${Math.round(savingsRate*100)}%. L'objectif recommand√© est 20%.`,
                    action: 'Voir le plan budget'
                });
            } else if (savingsRate >= 0.2) {
                alerts.push({
                    type: 'success',
                    icon: 'üéâ',
                    title: 'Bravo !',
                    text: `Taux d'√©pargne de ${Math.round(savingsRate*100)}%. Continuez ainsi !`
                });
            }
            
            // Tips
            const tips = [
                { icon: 'üí°', title: 'Astuce', text: 'N√©gociez vos assurances chaque ann√©e. √âconomie moyenne: 15%.' },
                { icon: 'üìû', title: 'Forfait mobile', text: 'Des forfaits √† 2‚Ç¨/mois existent (Free). √âconomie: ~40‚Ç¨/mois.' },
                { icon: 'üîå', title: '√ânergie', text: 'Comparez les fournisseurs d\'√©nergie sur energie-info.fr.' }
            ];
            
            const scoreClass = score >= 70 ? 'good' : score >= 40 ? 'warning' : 'bad';
            
            document.getElementById('optimizeContent').innerHTML = `
                <div class="card">
                    <div class="card-title">üìà Score financier</div>
                    <div class="score-circle ${scoreClass}">
                        <div class="score-value">${score}</div>
                        <div class="score-label">/100</div>
                    </div>
                    <p style="text-align:center;font-size:0.85rem;color:var(--sage);">
                        ${score >= 70 ? 'Excellente gestion !' : score >= 40 ? 'Peut √™tre am√©lior√©' : 'Attention requise'}
                    </p>
                </div>
                
                <div class="card-title" style="margin:1rem 0 0.5rem;">üîç Analyse</div>
                ${alerts.map(a => `
                    <div class="alert-card ${a.type}">
                        <div class="alert-icon">${a.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${a.title}</div>
                            <div class="alert-text">${a.text}</div>
                            ${a.action ? `<div class="alert-action">${a.action}</div>` : ''}
                        </div>
                    </div>
                `).join('')}
                
                <div class="card-title" style="margin:1rem 0 0.5rem;">üí° Conseils</div>
                ${tips.slice(0, 2).map(t => `
                    <div class="alert-card tip">
                        <div class="alert-icon">${t.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${t.title}</div>
                            <div class="alert-text">${t.text}</div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ============ PLAN ============
        function updatePlan() {
            const expenses = data.transactions.filter(t => t.amount < 0);
            const income = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            
            const byCategory = {};
            expenses.forEach(t => {
                byCategory[t.category || 'other'] = (byCategory[t.category || 'other'] || 0) + Math.abs(t.amount);
            });
            
            // Default budgets based on spending
            const defaultBudgets = {};
            Object.entries(byCategory).forEach(([cat, amount]) => {
                defaultBudgets[cat] = data.budgets[cat] || Math.round(amount * 1.1); // 10% buffer
            });
            
            const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
            
            document.getElementById('planContent').innerHTML = `
                <div class="card">
                    <div class="card-title">üí∞ Revenus du mois</div>
                    <div style="font-size:1.5rem;font-weight:600;color:var(--green);text-align:center;padding:0.5rem 0;">
                        +${Math.round(income)}‚Ç¨
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">üéØ Budgets par cat√©gorie</div>
                    <p style="font-size:0.8rem;color:var(--sage);margin-bottom:0.8rem;">Cliquez pour modifier</p>
                    
                    ${sorted.map(([cat, spent]) => {
                        const c = CATEGORIES[cat] || CATEGORIES.other;
                        const budget = data.budgets[cat] || Math.round(spent * 1.2);
                        const percent = Math.round((spent / budget) * 100);
                        const status = percent >= 100 ? 'danger' : percent >= 80 ? 'warning' : 'ok';
                        const remaining = budget - spent;
                        
                        return `
                            <div class="budget-item" onclick="openBudgetModal('${cat}', ${budget})">
                                <div class="budget-header">
                                    <div class="budget-category">${c.emoji} ${c.name}</div>
                                    <div class="budget-amounts">
                                        <div class="budget-spent">${Math.round(spent)}‚Ç¨ / ${budget}‚Ç¨</div>
                                    </div>
                                </div>
                                <div class="budget-bar">
                                    <div class="budget-fill ${status}" style="width:${Math.min(percent, 100)}%"></div>
                                </div>
                                <div class="budget-status ${status}">
                                    ${remaining >= 0 ? `‚úì Reste ${Math.round(remaining)}‚Ç¨` : `‚ö†Ô∏è D√©pass√© de ${Math.round(Math.abs(remaining))}‚Ç¨`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <button class="edit-budget-btn" onclick="openBudgetModal('', 0)">‚ûï Ajouter un budget</button>
                </div>
                
                <div class="card">
                    <div class="card-title">üìä R√©partition id√©ale</div>
                    <div style="font-size:0.8rem;color:var(--sage);">
                        <div style="display:flex;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid var(--cream);">
                            <span>üè† Logement</span><span>~35%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid var(--cream);">
                            <span>üçï Alimentation</span><span>~15%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid var(--cream);">
                            <span>üöó Transport</span><span>~10%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid var(--cream);">
                            <span>üì± Abonnements</span><span>~5%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid var(--cream);">
                            <span>üé¨ Loisirs</span><span>~10%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:0.3rem 0;font-weight:600;color:var(--green);">
                            <span>üí∞ √âpargne</span><span>~20%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============ TRANSACTIONS ============
        function renderAllTransactions() {
            let filtered = data.transactions;
            if (currentFilter === 'income') filtered = filtered.filter(t => t.amount > 0);
            if (currentFilter === 'expense') filtered = filtered.filter(t => t.amount < 0);
            
            filtered = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
            
            document.getElementById('allTransactions').innerHTML = filtered.length 
                ? filtered.map(t => transactionHTML(t)).join('')
                : '<div class="empty-state"><div class="empty-text">Aucune transaction</div></div>';
        }

        // ============ MODALS ============
        function openEditModal(id) {
            editingTransaction = data.transactions.find(t => t.id === id);
            if (!editingTransaction) return;
            
            document.getElementById('editDesc').value = editingTransaction.description;
            document.getElementById('categorySelect').innerHTML = Object.entries(CATEGORIES).map(([key, c]) => `
                <div class="category-option ${editingTransaction.category === key ? 'active' : ''}" data-cat="${key}">
                    <span class="cat-emoji">${c.emoji}</span>${c.name}
                </div>
            `).join('');
            
            document.querySelectorAll('.category-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.category-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                });
            });
            
            document.getElementById('editModal').classList.add('active');
        }

        function saveEdit() {
            if (!editingTransaction) return;
            editingTransaction.description = document.getElementById('editDesc').value.trim() || editingTransaction.description;
            editingTransaction.category = document.querySelector('.category-option.active')?.dataset.cat || editingTransaction.category;
            saveData();
            updateAllViews();
            closeModal('editModal');
            notify('‚úÖ Modifi√©');
        }

        function openBudgetModal(cat, amount) {
            document.getElementById('budgetCategory').innerHTML = Object.entries(CATEGORIES)
                .filter(([k]) => !['salary', 'transfer'].includes(k))
                .map(([k, c]) => `<option value="${k}" ${k === cat ? 'selected' : ''}>${c.emoji} ${c.name}</option>`)
                .join('');
            document.getElementById('budgetAmount').value = amount || '';
            document.getElementById('budgetModal').classList.add('active');
        }

        function saveBudgetLimit() {
            const cat = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            if (cat && amount > 0) {
                data.budgets[cat] = amount;
                saveData();
                updatePlan();
                notify('‚úÖ Budget d√©fini');
            }
            closeModal('budgetModal');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ============ BUDGET CHAT ============
        async function sendBudgetMessage() {
            const input = document.getElementById('budgetChatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addBudgetMessage(message, 'user');
            input.value = '';
            
            const chatEl = document.getElementById('budgetChatMessages');
            const loading = document.createElement('div');
            loading.className = 'loading-dots';
            loading.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
            chatEl.appendChild(loading);
            chatEl.scrollTop = chatEl.scrollHeight;
            
            // Build context
            const income = data.transactions.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
            const expenses = data.transactions.filter(t => t.amount < 0);
            const totalExpenses = expenses.reduce((s, t) => s + Math.abs(t.amount), 0);
            
            const byCategory = {};
            expenses.forEach(t => {
                byCategory[t.category || 'other'] = (byCategory[t.category || 'other'] || 0) + Math.abs(t.amount);
            });
            
            const context = `Donn√©es financi√®res de l'utilisateur:
- Revenus: ${income.toFixed(0)}‚Ç¨
- D√©penses totales: ${totalExpenses.toFixed(0)}‚Ç¨
- Solde: ${(income - totalExpenses).toFixed(0)}‚Ç¨
- R√©partition: ${Object.entries(byCategory).map(([c, a]) => `${CATEGORIES[c]?.name || c}: ${a.toFixed(0)}‚Ç¨`).join(', ')}
- Transactions: ${JSON.stringify(data.transactions.slice(0, 20))}`;
            
            try {
                const response = await fetch('/api/claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system: `Tu es un conseiller financier personnel. Tu analyses les donn√©es de l'utilisateur et donnes des conseils personnalis√©s, concrets et actionnables. Utilise des emojis. Sois concis mais utile. R√©ponds en fran√ßais.

${context}`,
                        messages: [...budgetChatHistory.slice(-6), { role: 'user', content: message }]
                    })
                });
                
                loading.remove();
                
                if (response.ok) {
                    const result = await response.json();
                    const reply = result.content[0].text;
                    addBudgetMessage(reply, 'assistant');
                    budgetChatHistory.push({ role: 'user', content: message });
                    budgetChatHistory.push({ role: 'assistant', content: reply });
                } else {
                    addBudgetMessage('‚ùå Erreur de connexion', 'assistant');
                }
            } catch (err) {
                loading.remove();
                addBudgetMessage('‚ùå Erreur', 'assistant');
            }
        }

        function askBudgetQuestion(question) {
            document.getElementById('budgetChatInput').value = question;
            sendBudgetMessage();
        }

        function addBudgetMessage(text, role) {
            const el = document.createElement('div');
            el.className = `message ${role}`;
            el.innerHTML = text.replace(/\n/g, '<br>');
            document.getElementById('budgetChatMessages').appendChild(el);
            document.getElementById('budgetChatMessages').scrollTop = 99999;
        }

        // ============ HOMEWORK ============
        function handleFileUpload(file) {
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                notify('‚ö†Ô∏è Format non support√©');
                return;
            }
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileBase64 = e.target.result;
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('uploadPreview').style.display = 'block';
                document.getElementById('previewImage').src = file.type.startsWith('image/') 
                    ? e.target.result 
                    : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><rect fill="%23e74c3c" width="60" height="60" rx="6"/><text x="30" y="36" text-anchor="middle" fill="white" font-size="14">PDF</text></svg>';
            };
            reader.readAsDataURL(file);
        }

        function clearUpload() {
            uploadedFile = null;
            uploadedFileBase64 = null;
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        async function sendHomeworkMessage() {
            const input = document.getElementById('homeworkChatInput');
            const message = input.value.trim();
            if (!message && !uploadedFile) return;
            
            let display = message || '';
            if (uploadedFile) display += (display ? '\n' : '') + 'üìé ' + uploadedFile.name;
            addHomeworkMessage(display, 'user');
            input.value = '';
            
            const chatEl = document.getElementById('homeworkChatMessages');
            const loading = document.createElement('div');
            loading.className = 'loading-dots';
            loading.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
            chatEl.appendChild(loading);
            chatEl.scrollTop = chatEl.scrollHeight;
            
            const systemPrompt = currentMode === 'parent'
                ? `Tu es un assistant p√©dagogique. L'enfant: ${currentChild.name} (${currentChild.level}). Aide le parent √† interroger son enfant. Sugg√®re des questions. Utilise des emojis. R√©ponds en fran√ßais.`
                : `Tu es un assistant sympa pour ${currentChild.name} (${currentChild.level}). Explique simplement avec des exemples. Encourage. Utilise des emojis. R√©ponds en fran√ßais.`;
            
            let content = [];
            if (uploadedFileBase64 && uploadedFile) {
                const b64 = uploadedFileBase64.split(',')[1];
                content.push(uploadedFile.type.startsWith('image/')
                    ? { type: 'image', source: { type: 'base64', media_type: uploadedFile.type, data: b64 } }
                    : { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: b64 } });
            }
            content.push({ type: 'text', text: message || 'Analyse ce document.' });
            
            try {
                const response = await fetch('/api/claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system: systemPrompt,
                        messages: [...homeworkHistory.slice(-6), { role: 'user', content: content.length === 1 ? content[0].text : content }]
                    })
                });
                
                loading.remove();
                
                if (response.ok) {
                    const result = await response.json();
                    const reply = result.content[0].text;
                    addHomeworkMessage(reply, 'assistant');
                    homeworkHistory.push({ role: 'user', content: message || 'Document' });
                    homeworkHistory.push({ role: 'assistant', content: reply });
                    clearUpload();
                } else {
                    addHomeworkMessage('‚ùå Erreur', 'assistant');
                }
            } catch (err) {
                loading.remove();
                addHomeworkMessage('‚ùå Erreur', 'assistant');
            }
        }

        function addHomeworkMessage(text, role) {
            const el = document.createElement('div');
            el.className = `message ${role}`;
            el.innerHTML = text.replace(/\n/g, '<br>');
            document.getElementById('homeworkChatMessages').appendChild(el);
            document.getElementById('homeworkChatMessages').scrollTop = 99999;
        }

        // ============ UTILITY ============
        function notify(msg) {
            const n = document.createElement('div');
            n.className = 'notification';
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 2500);
        }

        init();
    </script>
</body>
</html>
